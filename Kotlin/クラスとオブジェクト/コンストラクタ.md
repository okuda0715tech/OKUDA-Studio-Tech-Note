- [コンストラクタ](#コンストラクタ)
  - [コンストラクタの役割](#コンストラクタの役割)
  - [プライマリコンストラクター](#プライマリコンストラクター)
  - [初期化ブロック](#初期化ブロック)
    - [基本](#基本)
    - [実行順序](#実行順序)
  - [セカンダリコンストラクタ](#セカンダリコンストラクタ)
    - [基本形](#基本形)
    - [セカンダリコンストラクタの引数に val や var は指定不可](#セカンダリコンストラクタの引数に-val-や-var-は指定不可)
    - [参考](#参考)
  - [暗黙的に生成されるコンストラクタ](#暗黙的に生成されるコンストラクタ)
  - [【参考】すべてのパラメータにデフォルト値が設定されたコンストラクタ](#参考すべてのパラメータにデフォルト値が設定されたコンストラクタ)


# コンストラクタ

## コンストラクタの役割

コンストラクタには、以下の 3 つの機能があります。

1. クラスのインスタンス生成時に、そのインスタンスにデータを渡す
2. 渡されてきたデータをインスタンス内部で使用可能にする
3. 渡されてきたデータをインスタンスのメンバ変数に格納する

コンストラクタの定義方法によっては、上記の機能が果たされないものもあるため、注意が必要です。


## プライマリコンストラクター

プライマリコンストラクタとは、クラス名のすぐ右側に `()` で囲んだ部分のことを示します。

```Kotlin
class Person constructor(firstName: String) { /*...*/ }

// プライマリ コンストラクターに注釈や可視性修飾子がない場合は、
// constructor キーワードを省略できます。
// 通常は、省略する場合が多いでしょう。
class Person(firstName: String) { /*...*/ }

// val が付与された場合
class Person(val firstName: String) { /*...*/ }

// var が付与された場合
class Person(var firstName: String) { /*...*/ }

// デフォルト値を設定可能
// val や var が付与されているかどうかに関わらず設定可能
class Person(firstName: String = "hoge") { /*...*/ }

// アクセス修飾子を付与する場合
class Person private constructor(firstName: String) { /*...*/ }
```

`val` or `var` が付与されている場合と、付与されていない場合では、動きが異なります。

- 付与されていない場合
  - クラスのプロパティとして認識されません。
  - init ブロック内からのみアクセス可能な変数となります。
- 付与されている場合
  - クラスのプロパティとして認識されます。

```
プライマリコンストラクターで渡されてきた値は、フィールドの初期化や init ブロック内で使用することが可能です。
```


## 初期化ブロック

クラスヘッダー (プライマリコンストラクタ内) には実行可能なコードを含めることはできません。  
オブジェクトの作成中にコードを実行する場合は、クラス本体内で `init` ブロックを使用します。


### 基本

```Kotlin
class Pet {

    init {
        // ここで、プライマリコンストラクタの変数や
        // フィールドやメンバ関数等にアクセス可能。
        // アクセス修飾子に則ってアクセス可能。
    }

}
```


### 実行順序

```Kotlin
class InitOrderDemo(name: String) {
    val firstProperty = "First property: $name".also(::println)
    
    init {
        println("First initializer block that prints $name")
    }
    
    val secondProperty = "Second property: ${name.length}".also(::println)
    
    init {
        println("Second initializer block that prints ${name.length}")
    }
}

fun main() {
    InitOrderDemo("hello")
}
```

フィールドの初期化と init ブロックの実行に、優先順位の違いは存在せず、  
上から順番に実行されます。

**実行結果**

```
First property: hello
First initializer block that prints hello
Second property: 5
Second initializer block that prints 5
```


## セカンダリコンストラクタ

### 基本形

```Kotlin
class Person(val name: String) {

    // this() は、プライマリコンストラクタの呼び出しを意味します。
    // this() は、セカンダリコンストラクタで必須です。
    constructor(name: String, age: Int) : this(name) {
        // セカンダリコンストラクタでは、 init ブロック同様に処理の記載が可能です。

        // セカンダリコンストラクタが呼ばれると、
        // まずは、プライマリコンストラクタに引数が渡されます。
        // 次に、 「 init ブロックの処理」と「フィールドの初期化」 が行われます。
        // 最後に、ここ (セカンダリコンストラクタ) に記述した処理が行われます。
    }
    
}
```


### セカンダリコンストラクタの引数に val や var は指定不可

セカンダリコンストラクタの引数に val や var は指定することができません。  
これは、考えてみれば当たり前のことで、どのコンストラクタを呼び出すかによって、クラスのプロパティの存在有無が変わってきては、怖くてインスタンスを扱うことなどできません。


### 参考

プライマリコンストラクタが定義されていないにもかかわらず、セカンダリコンストラクタが定義されている場合は、  
「まずはプライマリコンストラクタを利用するべきです」 というワーニングが表示されます。

プライマリコンストラクタとセカンダリコンストラクタのシグネチャが同じになるようなコンストラクタの定義はできません。


## 暗黙的に生成されるコンストラクタ

Java と同様に、具象クラスがコンストラクタ (プライマリまたはセカンダリ) を定義していない場合は、  
引数のないプライマリコンストラクタが生成されます。  
そのコンストラクタの可視性は public になります。

クラスにパブリックコンストラクターを持たせたくない場合は、デフォルトの可視性 (public) 以外を持つ空のプライマリコンストラクターを宣言します。

```Kotlin
class DontCreateMe private constructor() { /*...*/ }
```


## 【参考】すべてのパラメータにデフォルト値が設定されたコンストラクタ

JVM では、すべてのプライマリコンストラクターパラメーターにデフォルト値がある場合、  
コンパイラーはデフォルト値を使用する追加のパラメーターなしのコンストラクターを生成します。  
これにより、パラメータなしのコンストラクターを通じてクラスインスタンスを作成する Jackson や JPA などの  
ライブラリで Kotlin を使用することが容易になります。

これが、

```Kotlin
class Customer(val name: String = "defVal")
```

こうなる感じ。

```Kotlin
class Customer(val name: String = "defVal") {
    // 追加でパラメータなしのコンストラクタを生成
    // this() には何も渡さなくてもデフォルト値があるので大丈夫
    constructor(): this() {
        
    }
}
```

