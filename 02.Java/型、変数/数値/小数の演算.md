- [小数の演算](#小数の演算)


# 小数の演算

## 概要

小数の演算に double 型や float 型を使用すると、小数は丸めが発生する可能性が高いです。

例えば、 double 型で、 10 進数の 0.1 を 10 回足したものは、 0.99999... になってしまいます。

そのため、小数を正確に扱いたい場合には、 BigDecimal 型を使用することが推奨されます。


## なぜ double や float は丸めが発生するのか

そもそも、 double や float は、 2 進数でデータを保持しています。  

2 進数で小数点以下の数字を扱うと以下のようになります。

| 2 進数 | 10 進数 |
| ------ | ------- |
| 0.1    | 0.5     |
| 0.01   | 0.25    |
| 0.001  | 0.125   |
| 0.0001 | 0.0625  |

そもそも 2 進数の定義は、  
2 進数の 1 が、 10 進数の 1 になるように基準が定められており、  
そうなると、自ずと 2 進数の小数は、上記の表のように定義しなければなりません。

これにより、 2 進数を 10 進数に変換する場合は丸めが発生しませんが、  
逆に、 10 進数を 2 進数に変換する場合には、割り切れずに  
無限小数になってしまう可能性が高いです。  
当然、コンピュータで扱える数値は有限であるため、どこかで丸めが発生してしまいます。

例えば、 10 進数の 0.1 を 2 進数で表現すると、以下のようになります。

```
0.0001 1001 1001 1001 1001 ...
割り切れずに 1001 が永遠に続きます。
```

これをどこかで丸めることにより、丸め誤差が発生して、  
0.1 を 10 回足しても 1 にならず 0.999... になってしまうというわけです。


## 丸め誤差をなくす方法

### BigDecimal 型を使用する

とはいえ、丸め誤差をなくす方法もあります。

それは、 double や float ではなく、 `BigDecimal` 型を使用することです。  
`BigDecimal` 型を使用する場合には注意点もあるため、以下で説明します。


### サンプル

```java
BigDecimal b1 = new BigDecimal("0");
BigDecimal constantOne = new BigDecimal("0.1");
for(int i = 0; i < 10; i++){
    b1 = b1.add(constantOne);
}
Log.d("test", "result = " + b1.toString()); // result = 1.0
```

通常の演算子 ( +, -, *, / など) は使用できないため、  
`add(), subtract(), multiply(), divide()` などのメソッドを使用します。


### 注意点

```java
// NG パターン
double a = 0.03;
BigDecimal db_a = new BigDecimal(a);

// OK パターン
String b = "0.03";
BigDecimal db_b = new BigDecimal(b);
```

BigDecimal の値を設定するときには、 double や float のリテラルを使用してはいけません。  
double や float に値を格納した時点で、丸め誤差が発生してしまいます。  
必ず、 String リテラルで値を設定するようにしてください。




