- [Template パターン](#template-パターン)
  - [役割](#役割)
  - [実装方法](#実装方法)
  - [使いどころ](#使いどころ)
    - [Activity や Fragment のライフサイクル](#activity-や-fragment-のライフサイクル)
    - [サーバーリクエストとその結果の画面表示](#サーバーリクエストとその結果の画面表示)
    - [複数種類の通知処理](#複数種類の通知処理)


# Template パターン

## 役割

処理の流れをスーパークラスで定義し、具体的な処理内容をサブクラスで実装する。


## 実装方法

省略


## 使いどころ

何らかの共通の処理フローがあると感じられる場合には、 Template パターンの実装を検討してみると良さそうです。


### Activity や Fragment のライフサイクル

Activity や Fragment のライフサイクルでも、 Template パターンが使われています。


### サーバーリクエストとその結果の画面表示

```kotlin
abstract class FormFlow {

    // テンプレート
    fun execute() {
        validateInput()
        showLoading()
        sendRequest()
        hideLoading()
        handleResult()
    }

    // サブクラス固有の処理
    protected abstract fun validateInput()
    protected abstract fun sendRequest()
    protected abstract fun handleResult()

    // 共通処理
    private fun showLoading() { println("Loading...") }
    private fun hideLoading() { println("Done.") }
}
```

```kotlin
// 各サーバーリクエストごとの処理
class LoginFormFlow : FormFlow() {
    override fun validateInput() {
        println("メールアドレスとパスワードをチェック")
    }

    override fun sendRequest() {
        println("ログインAPIを呼び出し")
    }

    override fun handleResult() {
        println("ログイン成功 → ホームへ遷移")
    }
}
```

```kotlin
// 実行
val flow = LoginFormFlow()
flow.execute()
```


### 複数種類の通知処理

複数種類の通知処理を Template パターンで実装するサンプルコードを以下に示します。

たとえば、アプリ内で以下のような通知を送るとします。

- 🔔 通常のお知らせ（例：キャンペーン情報）
- 📢 重要通知（例：アカウント停止など）
- 💬 メッセージ通知（例：ユーザー間のチャット）

共通の流れ（テンプレート）は以下のようにします。

1. 通知データを作成
2. 通知チャネルやオプションの設定
3. 通知送信

```kotlin
abstract class BaseNotifier {

    // テンプレート
    fun notifyUser() {
        val data = buildNotificationData()
        val builder = createNotificationBuilder(data)
        sendNotification(builder)
    }

    // サブクラス固有の処理
    protected abstract fun buildNotificationData(): NotificationData
    protected abstract fun createNotificationBuilder(data: NotificationData): NotificationCompat.Builder

    // 全サブクラスで共通の処理
    private fun sendNotification(builder: NotificationCompat.Builder) {
        val notificationManager = NotificationManagerCompat.from(App.instance)
        notificationManager.notify(generateNotificationId(), builder.build())
    }

    // 全サブクラスで共通の処理
    private fun generateNotificationId(): Int = (System.currentTimeMillis() % Int.MAX_VALUE).toInt()
}

data class NotificationData(
    val title: String,
    val message: String,
    val channelId: String
)
```

```kotlin
// 通常通知の実装

class NormalNotifier : BaseNotifier() {
    override fun buildNotificationData(): NotificationData {
        return NotificationData(
            title = "お知らせ",
            message = "新しいキャンペーンが始まりました！",
            channelId = "normal_channel"
        )
    }

    override fun createNotificationBuilder(data: NotificationData): NotificationCompat.Builder {
        return NotificationCompat.Builder(App.instance, data.channelId)
            .setContentTitle(data.title)
            .setContentText(data.message)
            .setSmallIcon(R.drawable.ic_notification)
            .setPriority(NotificationCompat.PRIORITY_DEFAULT)
    }
}
```

```kotlin
// 重要通知の実装

class ImportantNotifier : BaseNotifier() {
    override fun buildNotificationData(): NotificationData {
        return NotificationData(
            title = "重要なお知らせ",
            message = "アカウントが一時停止されました。",
            channelId = "important_channel"
        )
    }

    override fun createNotificationBuilder(data: NotificationData): NotificationCompat.Builder {
        return NotificationCompat.Builder(App.instance, data.channelId)
            .setContentTitle(data.title)
            .setContentText(data.message)
            .setSmallIcon(R.drawable.ic_warning)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setDefaults(NotificationCompat.DEFAULT_ALL)
    }
}
```

```kotlin
// チャット通知の実装

class ChatNotifier(private val sender: String, private val message: String) : BaseNotifier() {
    override fun buildNotificationData(): NotificationData {
        return NotificationData(
            title = "$sender からのメッセージ",
            message = message,
            channelId = "chat_channel"
        )
    }

    override fun createNotificationBuilder(data: NotificationData): NotificationCompat.Builder {
        return NotificationCompat.Builder(App.instance, data.channelId)
            .setContentTitle(data.title)
            .setContentText(data.message)
            .setSmallIcon(R.drawable.ic_chat)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
    }
}
```

```kotlin
// 呼び出し側

val notifier: BaseNotifier = NormalNotifier()
notifier.notifyUser()

val important = ImportantNotifier()
important.notifyUser()

val chat = ChatNotifier("Alice", "やっほー！")
chat.notifyUser()
```

