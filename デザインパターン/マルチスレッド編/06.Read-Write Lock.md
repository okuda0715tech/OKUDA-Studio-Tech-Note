- [Read-Write Lock](#read-write-lock)
  - [役割](#役割)
  - [実装方法](#実装方法)
    - [Mutex を使ってコルーチンに対応した Read-Write Lock](#mutex-を使ってコルーチンに対応した-read-write-lock)
      - [🔍 ポイント](#-ポイント)
      - [🧠 注意点](#-注意点)
  - [使いどころ](#使いどころ)


# Read-Write Lock

## 役割

- 読み取り（Read） は複数同時に許可される（共有ロック）。
- 書き込み（Write） は排他的で、他の読み取り・書き込みをブロックする（排他ロック）。


## 実装方法

### Mutex を使ってコルーチンに対応した Read-Write Lock

```kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock

class ReadWriteLock {
    private val readersMutex = Mutex()
    private val writerMutex = Mutex()
    private var readers = 0

    suspend fun <T> read(block: suspend () -> T): T {
        // 読み手数を守るためにロック
        readersMutex.withLock {
            if (readers == 0) {
                writerMutex.lock() // 最初のリーダーは書き込みをブロック
            }
            readers++
        }

        try {
            return block()
        } finally {
            readersMutex.withLock {
                readers--
                if (readers == 0) {
                    writerMutex.unlock() // 最後のリーダーが終わったら書き込みを許可
                }
            }
        }
    }

    suspend fun <T> write(block: suspend () -> T): T {
        writerMutex.withLock {
            return block()
        }
    }
}
```

使用側：

```kotlin
val rwLock = ReadWriteLock()
var sharedData = 0

suspend fun reader(id: Int) {
    rwLock.read {
        println("Reader $id sees value $sharedData")
        delay(100)
    }
}

suspend fun writer(id: Int) {
    rwLock.write {
        println("Writer $id is updating value")
        sharedData++
        delay(200)
        println("Writer $id finished")
    }
}

fun main() = runBlocking {
    val jobs = mutableListOf<Job>()

    // リーダーとライターを同時に起動
    repeat(3) { i -> jobs += launch { reader(i) } }
    jobs += launch { writer(1) }
    repeat(2) { i -> jobs += launch { reader(i + 3) } }

    jobs.joinAll()
}
```


#### 🔍 ポイント

- readersMutex は readers 変数の操作に使う。
- writerMutex は実際の書き込み処理に使う。
- 最初のリーダーが writerMutex をロックし、最後のリーダーがアンロック。
- write は常に writerMutex を使って排他実行。


#### 🧠 注意点

- この実装はフェアネス（公平性）を保証しません。リーダーが大量に来るとライターが待たされ続ける可能性があります（いわゆる writer starvation ）。
- フェアネスを追加したい場合は、別途キューイングや状態管理が必要になります。


## 使いどころ



