- [Read-Write Lock](#read-write-lock)
  - [å½¹å‰²](#å½¹å‰²)
  - [å®Ÿè£…æ–¹æ³•](#å®Ÿè£…æ–¹æ³•)
    - [Mutex ã‚’ä½¿ã£ã¦ã‚³ãƒ«ãƒ¼ãƒãƒ³ã«å¯¾å¿œã—ãŸ Read-Write Lock](#mutex-ã‚’ä½¿ã£ã¦ã‚³ãƒ«ãƒ¼ãƒãƒ³ã«å¯¾å¿œã—ãŸ-read-write-lock)
      - [ğŸ” ãƒã‚¤ãƒ³ãƒˆ](#-ãƒã‚¤ãƒ³ãƒˆ)
      - [ğŸ§  æ³¨æ„ç‚¹](#-æ³¨æ„ç‚¹)
  - [ä½¿ã„ã©ã“ã‚](#ä½¿ã„ã©ã“ã‚)


# Read-Write Lock

## å½¹å‰²

- èª­ã¿å–ã‚Šï¼ˆReadï¼‰ ã¯è¤‡æ•°åŒæ™‚ã«è¨±å¯ã•ã‚Œã‚‹ï¼ˆå…±æœ‰ãƒ­ãƒƒã‚¯ï¼‰ã€‚
- æ›¸ãè¾¼ã¿ï¼ˆWriteï¼‰ ã¯æ’ä»–çš„ã§ã€ä»–ã®èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ï¼ˆæ’ä»–ãƒ­ãƒƒã‚¯ï¼‰ã€‚


## å®Ÿè£…æ–¹æ³•

### Mutex ã‚’ä½¿ã£ã¦ã‚³ãƒ«ãƒ¼ãƒãƒ³ã«å¯¾å¿œã—ãŸ Read-Write Lock

```kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock

class ReadWriteLock {
    private val readersMutex = Mutex()
    private val writerMutex = Mutex()
    private var readers = 0

    suspend fun <T> read(block: suspend () -> T): T {
        // èª­ã¿æ‰‹æ•°ã‚’å®ˆã‚‹ãŸã‚ã«ãƒ­ãƒƒã‚¯
        readersMutex.withLock {
            if (readers == 0) {
                writerMutex.lock() // æœ€åˆã®ãƒªãƒ¼ãƒ€ãƒ¼ã¯æ›¸ãè¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯
            }
            readers++
        }

        try {
            return block()
        } finally {
            readersMutex.withLock {
                readers--
                if (readers == 0) {
                    writerMutex.unlock() // æœ€å¾Œã®ãƒªãƒ¼ãƒ€ãƒ¼ãŒçµ‚ã‚ã£ãŸã‚‰æ›¸ãè¾¼ã¿ã‚’è¨±å¯
                }
            }
        }
    }

    suspend fun <T> write(block: suspend () -> T): T {
        writerMutex.withLock {
            return block()
        }
    }
}
```

ä½¿ç”¨å´ï¼š

```kotlin
val rwLock = ReadWriteLock()
var sharedData = 0

suspend fun reader(id: Int) {
    rwLock.read {
        println("Reader $id sees value $sharedData")
        delay(100)
    }
}

suspend fun writer(id: Int) {
    rwLock.write {
        println("Writer $id is updating value")
        sharedData++
        delay(200)
        println("Writer $id finished")
    }
}

fun main() = runBlocking {
    val jobs = mutableListOf<Job>()

    // ãƒªãƒ¼ãƒ€ãƒ¼ã¨ãƒ©ã‚¤ã‚¿ãƒ¼ã‚’åŒæ™‚ã«èµ·å‹•
    repeat(3) { i -> jobs += launch { reader(i) } }
    jobs += launch { writer(1) }
    repeat(2) { i -> jobs += launch { reader(i + 3) } }

    jobs.joinAll()
}
```


#### ğŸ” ãƒã‚¤ãƒ³ãƒˆ

- readersMutex ã¯ readers å¤‰æ•°ã®æ“ä½œã«ä½¿ã†ã€‚
- writerMutex ã¯å®Ÿéš›ã®æ›¸ãè¾¼ã¿å‡¦ç†ã«ä½¿ã†ã€‚
- æœ€åˆã®ãƒªãƒ¼ãƒ€ãƒ¼ãŒ writerMutex ã‚’ãƒ­ãƒƒã‚¯ã—ã€æœ€å¾Œã®ãƒªãƒ¼ãƒ€ãƒ¼ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã€‚
- write ã¯å¸¸ã« writerMutex ã‚’ä½¿ã£ã¦æ’ä»–å®Ÿè¡Œã€‚


#### ğŸ§  æ³¨æ„ç‚¹

- ã“ã®å®Ÿè£…ã¯ãƒ•ã‚§ã‚¢ãƒã‚¹ï¼ˆå…¬å¹³æ€§ï¼‰ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ãƒªãƒ¼ãƒ€ãƒ¼ãŒå¤§é‡ã«æ¥ã‚‹ã¨ãƒ©ã‚¤ã‚¿ãƒ¼ãŒå¾…ãŸã•ã‚Œç¶šã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆã„ã‚ã‚†ã‚‹ writer starvation ï¼‰ã€‚
- ãƒ•ã‚§ã‚¢ãƒã‚¹ã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯ã€åˆ¥é€”ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã‚„çŠ¶æ…‹ç®¡ç†ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚


## ä½¿ã„ã©ã“ã‚



