- [Guarded Suspension](#guarded-suspension)
  - [役割](#役割)
  - [実装方法](#実装方法)
    - [Java の場合](#java-の場合)
      - [待つ側](#待つ側)
      - [起こす側](#起こす側)
    - [Kotlin の場合](#kotlin-の場合)
      - [Channel を使用して通知するパターン](#channel-を使用して通知するパターン)
  - [使いどころ](#使いどころ)


# Guarded Suspension

Guarded Suspension パターンは、 Guarded Wait や Spin Lock と呼ばれることもあります。

Guarded Suspension の Guarded とは、実行可能になる条件のことを意味します。つまり、実行条件が満たされるまで、ガードする (処理を行わない) という意味です。

Guarded Suspension パターンを実装する際は、「ガード条件は何か？」を意識することが重要です。


## 役割

実行可能になるまで、実行を一時停止します。


## 実装方法

### Java の場合

wait() , notify() , notifyAll() と syncronized を使用して実装します。


#### 待つ側

```java
syncronized(obj) {
    while(!ready) {
        wait()
    }
}
```


#### 起こす側

```java
syncronized(obj) {
    ready = true;
    notify();
    // もしくは
    notifyAll();
}
```


### Kotlin の場合

```kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock

class GuardedSuspension<T> {
    private val mutex = Mutex()
    private var resource: T? = null

    suspend fun get(): T {
        while (true) {
            mutex.withLock {
                // この例では、ガード条件は「 resource が null ではないこと」です。
                resource?.let { return it }
            }
            delay(100) // 条件をポーリングする（よりスマートにしたければ Channel を使う）
        }
    }

    suspend fun set(value: T) {
        mutex.withLock {
            resource = value
        }
    }
}
```

使用側：

```kotlin
fun main() = runBlocking {
    val guarded = GuardedSuspension<String>()

    launch {
        delay(1000)
        println("Setting resource")
        guarded.set("Hello, World!")
    }

    launch {
        println("Waiting for resource...")
        val result = guarded.get()
        println("Got: $result")
    }
}
```


#### Channel を使用して通知するパターン

```kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.channels.Channel

class GuardedSuspensionChannel<T> {
    private val channel = Channel<T>(capacity = 1)
    private var resource: T? = null

    suspend fun get(): T {
        // 既にリソースがあるなら返す
        resource?.let { return it }

        // リソースが設定されるまで待機
        resource = channel.receive()
        return resource!!
    }

    suspend fun set(value: T) {
        if (resource == null) {
            resource = value
            channel.send(value) // 通知
        }
    }
}
```

使用側：

```kotlin
fun main() = runBlocking {
    val guarded = GuardedSuspensionChannel<String>()

    launch {
        println("Waiting for resource...")
        val result = guarded.get()
        println("Got resource: $result")
    }

    launch {
        delay(1000)
        println("Setting resource...")
        guarded.set("Hello from Channel!")
    }
}
```


## 使いどころ

