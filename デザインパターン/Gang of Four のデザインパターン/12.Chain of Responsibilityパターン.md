- [Chain of Responsibility パターン](#chain-of-responsibility-パターン)
  - [役割](#役割)
  - [実装方法](#実装方法)
  - [使いどころ](#使いどころ)
    - [入力バリデーションの連鎖](#入力バリデーションの連鎖)
    - [権限チェック](#権限チェック)


# Chain of Responsibility パターン

## 役割

リクエストを処理するオブジェクト (ハンドラー) を数珠つなぎにする。クライアントは、常に、最初のハンドラーにリクエストを送る。ハンドラー自身が、そのリクエストを処理できれば処理を行う。処理できなければ、ハンドラーは、次のハンドラーにリクエストを流す。これにより、処理可能なハンドラーが自動的に選択される仕組みを提供する。

イメージ図を以下に示します。

```text
Client
  ↓
HandlerA → HandlerB → HandlerC
                ↑
        処理できるやつが対応
```


## 実装方法

```kotlin
abstract class Handler {
    var next: Handler? = null

    fun handleRequest(request: Int) {
        if (canHandle(request)) {
            println("${this::class.simpleName} が処理しました")
        } else {
            next?.handleRequest(request)
        }
    }

    abstract fun canHandle(request: Int): Boolean
}

class HandlerA : Handler() {
    override fun canHandle(request: Int) = request < 10
}

class HandlerB : Handler() {
    override fun canHandle(request: Int) = request in 10..19
}

class HandlerC : Handler() {
    override fun canHandle(request: Int) = request >= 20
}

fun main() {
    val handlerA = HandlerA()
    val handlerB = HandlerB()
    val handlerC = HandlerC()

    handlerA.next = handlerB
    handlerB.next = handlerC

    val request = 15
    handlerA.handleRequest(request)
}
```

```plaintext
実行結果

HandlerB が処理しました
```


## 使いどころ

### 入力バリデーションの連鎖

ユーザーの入力に対して複数のバリデーションを順に行う例を以下に示します。

```kotlin
abstract class Validator {
    var next: Validator? = null

    fun validate(input: String): Boolean {
        return if (check(input)) {
            next?.validate(input) ?: true
        } else {
            false
        }
    }

    abstract fun check(input: String): Boolean
}

class NotEmptyValidator : Validator() {
    override fun check(input: String): Boolean {
        return input.isNotEmpty()
    }
}

class EmailFormatValidator : Validator() {
    override fun check(input: String): Boolean {
        return input.contains("@") && input.contains(".")
    }
}
```

呼び出し側：

```kotlin
val validator = NotEmptyValidator().apply {
    next = EmailFormatValidator()
}

val result = validator.validate("test@example.com")
```


### 権限チェック

ただし、複数の権限チェックを連続的に実施する API が Android には用意されているので、あまり使わないかも。


