- [メール＆パスワード認証](#メールパスワード認証)
  - [🛠️ Jetpack Compose + Firebase Authentication（メール＆パスワード）の流れ](#️-jetpack-compose--firebase-authenticationメールパスワードの流れ)
  - [✍️ 例：アカウント作成（メール \& パスワード）](#️-例アカウント作成メール--パスワード)
  - [例：メールアドレス認証](#例メールアドレス認証)
  - [🔍 例：ログイン処理（Kotlin）](#-例ログイン処理kotlin)
  - [アカウント作成とログインの注意点](#アカウント作成とログインの注意点)
  - [セキュリティ](#セキュリティ)
  - [引用元資料](#引用元資料)


# メール＆パスワード認証

## 🛠️ Jetpack Compose + Firebase Authentication（メール＆パスワード）の流れ

1. Firebase プロジェクト作成
2. Android アプリを登録して google-services.json をダウンロード
3. Firebase Authentication をコンソールで有効にする（Email/Passwordなど）
4. firebase-auth ライブラリを導入
5. 実装：
   1. アカウント作成（createUserWithEmailAndPassword）
   2. ログイン（signInWithEmailAndPassword）
   3. ログアウト（signOut）
   4. 現在のユーザーの取得（FirebaseAuth.getInstance().currentUser）


## ✍️ 例：アカウント作成（メール & パスワード）

```kotlin
val auth = FirebaseAuth.getInstance()

fun createAccount(
    email: String,
    password: String,
    onSuccess: () -> Unit,
    onError: (String) -> Unit
) {
    auth.createUserWithEmailAndPassword(email, password)
        .addOnCompleteListener { task ->
            if (task.isSuccessful) {
                // アカウント作成成功
                onSuccess()
            } else {
                // アカウント作成失敗
                onError(task.exception?.message ?: "アカウント作成に失敗しました")
            }
        }
}
```

- アカウントは、メールアドレスの認証なしで作成されます。
- メールアドレスの認証は、別途、実装する必要があります。


## 例：メールアドレス認証

登録されたメールアドレスに対して、認証メールを送信するには、以下のようにします。

```kotlin
val user = FirebaseAuth.getInstance().currentUser
user?.sendEmailVerification()
    ?.addOnCompleteListener { task ->
        if (task.isSuccessful) {
            println("認証メールを送信しました")
        } else {
            println("メール送信失敗: ${task.exception?.message}")
        }
    }
```

- メールには、 URL リンクが含まれており、そのリンクをタップすると、メールアドレスの認証に成功します。
  - メールには、認証コードは含まれていません。

メールアドレスが、認証済みかどうかを確認するには、以下のようにします。

```kotlin
class AuthViewModel : ViewModel() {

    private val auth = FirebaseAuth.getInstance()

    var isVerified by mutableStateOf<Boolean?>(null)
        private set

    fun checkEmailVerification() {
        val user = auth.currentUser
        user?.reload()?.addOnCompleteListener {
            isVerified = user.isEmailVerified
        }
    }
}
```

- reload()
  - Firebase Authentication のサーバーにアクセスして、最新のユーザー情報を取得する処理です。
- isEmailVerified
  - メールアドレスが認証済みであれば true 、そうでなければ false が設定されています。


## 🔍 例：ログイン処理（Kotlin）

```kotlin
val auth = FirebaseAuth.getInstance()

fun signIn(email: String, password: String, onSuccess: () -> Unit, onError: (String) -> Unit) {
    auth.signInWithEmailAndPassword(email, password)
        .addOnCompleteListener { task ->
            if (task.isSuccessful) {
                onSuccess()
            } else {
                onError(task.exception?.message ?: "ログイン失敗")
            }
        }
}
```


## アカウント作成とログインの注意点

アカウント作成処理 ( `createUserWithEmailAndPassword()` ) とログイン処理 ( `signInWithEmailAndPassword()` ) は、メールアドレスの認証が完了していなくても成功します。

これは、アプリ上で、まず、アカウント作成 or ログインを行わないと、 **どのユーザーについて** メールアドレス認証の状態を確認したいのかが、わからないためです。

したがって、メールアドレス認証の状態を確認するには、以下の手順で実施する必要があります。

1. アカウント作成 or ログインする（メール＆パスワード）
2. 作成 or ログインに成功したら、 currentUser にアクセスできる
3. reload() でユーザー情報をリフレッシュ
4. isEmailVerified を確認


## セキュリティ

- メールアドレスとパスワードのペアは Firebase サーバー側で安全に管理されます。
  - Firebase Authentication は Google のインフラ上で、暗号化された形でこれらを保管します。
  - パスワードはもちろんハッシュ化されていて、アプリからは閲覧できません。


## 引用元資料

- ChatGPT




