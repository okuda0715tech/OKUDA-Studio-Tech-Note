- [Cloud Messaging](#cloud-messaging)
  - [🔧 FCMの主な用途](#-fcmの主な用途)
  - [⚙️ 仕組みの概要](#️-仕組みの概要)
  - [📱 メッセージの種類](#-メッセージの種類)
  - [💡 よくある使い方](#-よくある使い方)
  - [📚 使い始めるには？](#-使い始めるには)
  - [🔐 注意点](#-注意点)
  - [実装方法](#実装方法)
    - [✅ 事前準備](#-事前準備)
    - [🔧 FirebaseMessagingService の実装](#-firebasemessagingservice-の実装)
    - [📝 AndroidManifest.xml にサービスを登録](#-androidmanifestxml-にサービスを登録)
    - [🚀 通知の受信をテストする方法](#-通知の受信をテストする方法)
  - [メッセージタイプ](#メッセージタイプ)
    - [通知メッセージ](#通知メッセージ)
      - [1. レガシー HTTP API（今でも使用可能）](#1-レガシー-http-api今でも使用可能)
      - [2. HTTP v1 API（新しい推奨方式）](#2-http-v1-api新しい推奨方式)
    - [データメッセージ](#データメッセージ)
      - [1. レガシー HTTP API（今でも使用可能）](#1-レガシー-http-api今でも使用可能-1)
      - [2. HTTP v1 API（新しい推奨方式）](#2-http-v1-api新しい推奨方式-1)
    - [見分け方](#見分け方)
    - [ハイブリッド（通知＋データ）メッセージ](#ハイブリッド通知データメッセージ)
      - [▶ Android アプリが フォアグラウンド の場合：](#-android-アプリが-フォアグラウンド-の場合)
      - [▶ Android アプリが バックグラウンド の場合：](#-android-アプリが-バックグラウンド-の場合)
  - [メッセージタイプとアプリの状態による挙動の違い](#メッセージタイプとアプリの状態による挙動の違い)
  - [メッセージの送信方法](#メッセージの送信方法)
    - [Firebase コンソールから送信](#firebase-コンソールから送信)
    - [curl コマンドで FCM HTTP v1 API を使って送信](#curl-コマンドで-fcm-http-v1-api-を使って送信)
      - [1. アクセストークンを取得（gcloud CLI または OAuth2 手動発行）](#1-アクセストークンを取得gcloud-cli-または-oauth2-手動発行)
        - [✅ gcloud CLI から取得（推奨）](#-gcloud-cli-から取得推奨)
      - [2. 送信リクエスト（データメッセージ）](#2-送信リクエストデータメッセージ)
    - [事前準備](#事前準備)
      - [🔐 1. サービスアカウントの秘密鍵（JSON）を取得](#-1-サービスアカウントの秘密鍵jsonを取得)
      - [🆔 2. プロジェクトIDを確認](#-2-プロジェクトidを確認)
  - [デフォルトアイコンとデフォルトカラーの指定](#デフォルトアイコンとデフォルトカラーの指定)
  - [メッセージで使用可能なキー](#メッセージで使用可能なキー)
  - [引用元資料](#引用元資料)


# Cloud Messaging

Firebase Cloud Messaging（FCM）は、Google が提供する無料のメッセージングサービスで、アプリに プッシュ通知 や デバイス間のメッセージ通信 を簡単に組み込むことができます。特に Android アプリではよく使われており、iOS や Web でも利用可能です。


## 🔧 FCMの主な用途

- ユーザーへのプッシュ通知
- バックグラウンドでアプリにデータを送信
  - フォアグラウンドサービスのようにフォアグラウンド通知を表示することなく、こっそりとデータを送信して、簡単な処理が実行できる。
- 特定のユーザーやトピックに対するターゲット通知
- アプリ内でのリアルタイムメッセージ


## ⚙️ 仕組みの概要

1. Firebase にプロジェクトを作成し、アプリを登録。
2. アプリに Firebase SDK を導入。
3. アプリが起動すると、FCM トークンが発行される（ユーザーを識別するIDのようなもの）。
4. サーバー（または Firebase コンソール）から、トークンを指定してメッセージ送信。
5. Google の FCM サーバー経由で、アプリに通知が配信される。


## 📱 メッセージの種類

- 通知メッセージ
  - 通知バーに表示される。バックグラウンドで自動的に処理。
  - アプリがフォアグラウンドの際に配信された場合には、明示的に通知を表示する処理を記述する必要がある。
- データメッセージ
  - アプリで独自に処理。バックグラウンドでは動作が制限されることあり。
- 複合型メッセージ
  - 通知 + データの組み合わせ。


## 💡 よくある使い方

- 新着メッセージが届いたときに通知する
- セール情報を定期的に送る
- ユーザー行動に応じて特定の通知を出す
- トピック購読で「天気情報」「ニュース」などをグループに送信


## 📚 使い始めるには？

1. Firebase Console でプロジェクトを作成
2. google-services.json を Android プロジェクトに追加
3. Gradle に必要な Firebase ライブラリを追加
4. FirebaseMessagingService を継承して通知を受け取る処理を書く


## 🔐 注意点

- Android 13 以降は、通知のパーミッションが必須
- トークンの更新や失効に備えて再取得の処理も書く必要あり
- FCM のメッセージには制限（サイズ、回数）あり


## 実装方法

### ✅ 事前準備

- Firebase プロジェクトを作成する。
- google-services.json を app/ に配置する。
- build.gradle に Firebase ライブラリを追加する。

```kotlin
// app/build.gradle
dependencies {
    implementation("com.google.firebase:firebase-messaging:23.4.1")
}
```

```kotlin
// プロジェクトの build.gradle
buildscript {
    dependencies {
        classpath("com.google.gms:google-services:4.4.1")
    }
}
```

```kotlin
// app/build.gradle の最後に追加
apply plugin: 'com.google.gms.google-services'
```


### 🔧 FirebaseMessagingService の実装

```kotlin
class MyFirebaseMessagingService : FirebaseMessagingService() {

    // 通知メッセージやデータメッセージを受信したときに呼ばれる
    override fun onMessageReceived(remoteMessage: RemoteMessage) {
        super.onMessageReceived(remoteMessage)

        // 通知メッセージ（通知ペイロード）
        remoteMessage.notification?.let {
            Log.d("FCM", "通知タイトル: ${it.title}, 本文: ${it.body}")
        }

        // データメッセージ（カスタムデータ）
        if (remoteMessage.data.isNotEmpty()) {
            Log.d("FCM", "データペイロード: ${remoteMessage.data}")
        }
    }

    // 新しいトークンが生成されたとき
    override fun onNewToken(token: String) {
        super.onNewToken(token)
        Log.d("FCM", "新しいトークン: $token")
        // サーバーにトークンを送る処理を書く
    }
}
```

- `onMessageReceived()` 関数が呼ばれる場合と呼ばれない場合の条件については、 [メッセージタイプとアプリの状態による挙動の違い](#メッセージタイプとアプリの状態による挙動の違い) セクションを参照してください。
- メッセージの受信後 20 秒以内にサービスがメッセージを処理する必要があります。
  - メッセージを処理するための時間枠は、onMessageReceived の呼び出しに先立って発生する遅延（OS の遅延、アプリの起動時間、他のオペレーションによってブロックされているメインスレッド、または onMessageReceived の呼び出し時間がかかりすぎるなど）に応じて 20 秒より短くなる場合があります。

`onMessageReceived()` 関数が呼ばれるケースでは、通知は自動的には表示されないため、自前で実装する必要があります。以下に例を示します。

```kotlin
override fun onMessageReceived(remoteMessage: RemoteMessage) {
    super.onMessageReceived(remoteMessage)

    val title = remoteMessage.data["title"] ?: "通知タイトル"
    val body = remoteMessage.data["body"] ?: "通知本文"

    val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager

    // Android 8.0 以降はチャンネルが必要
    val channelId = "default_channel"
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        val channel = NotificationChannel(
            channelId,
            "通常通知",
            NotificationManager.IMPORTANCE_DEFAULT
        )
        notificationManager.createNotificationChannel(channel)
    }

    val notification = NotificationCompat.Builder(this, channelId)
        .setContentTitle(title)
        .setContentText(body)
        .setSmallIcon(R.drawable.ic_notification) // アイコンは必須
        .setAutoCancel(true)
        .build()

    notificationManager.notify(1, notification)
}
```


### 📝 AndroidManifest.xml にサービスを登録

```xml
<service
    android:name=".MyFirebaseMessagingService"
    android:exported="false">
    <intent-filter>
        <action android:name="com.google.firebase.MESSAGING_EVENT"/>
    </intent-filter>
</service>

<!-- Android 13 以降は通知パーミッションも必要 -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
```


### 🚀 通知の受信をテストする方法

- Firebase コンソールを開く
- Cloud Messaging メニューから「新しい通知を送信」
- 対象のアプリを選んで通知を送信


## メッセージタイプ

メッセージには、以下の 2 種類のメッセージタイプが存在します。また、それらの両方を含むメッセージも存在します。

- 通知メッセージ
- データメッセージ


### 通知メッセージ

#### 1. レガシー HTTP API（今でも使用可能）

```json
{
    "to": "fcm_device_token",
    "notification": {
        "title": "タイトル",
        "body": "本文"
    }
}
```


#### 2. HTTP v1 API（新しい推奨方式）

```json
{
    "message": {
        "token": "fcm_device_token",
        "notification": {
            "title": "タイトル",
            "body": "本文"
        }
    }
}
```


### データメッセージ

#### 1. レガシー HTTP API（今でも使用可能）

```json
{
    "to": "token",
    "data": {
        "key1": "value1",
        "key2": "value2"
    }
}
```


#### 2. HTTP v1 API（新しい推奨方式）

```json
{
    "message": {
        "token": "token",
        "data": {
            "key1": "value1",
            "key2": "value2"
        }
    }
}
```


### 見分け方

- notification キーを含み、 data キーを含まない場合は「通知メッセージ」です。
  - data キーを含んでいても「通知メッセージ」に分類することもあります。
- data キーを含み、 notification キーを含まない場合は「データメッセージ」です。
- notification キーと data キー両方を含む場合は「ハイブリッドメッセージ」と呼ばれます。


### ハイブリッド（通知＋データ）メッセージ

#### ▶ Android アプリが フォアグラウンド の場合：

- **onMessageReceived()** が呼ばれます。
- RemoteMessage.getNotification() で通知部分が、
- RemoteMessage.getData() でデータ部分が取得できます。
- 通知の表示は自分で行う必要があります（自動では表示されません）。


#### ▶ Android アプリが バックグラウンド の場合：

- **onMessageReceived() は呼ばれません**。
- FCM が通知メッセージ部分（notification キー）を使って、自動で通知を表示します。
- data キーに含まれる情報は、ユーザーが通知をタップしたときに Intent に含まれて渡される（が、アプリによっては受け取りが面倒）。


## メッセージタイプとアプリの状態による挙動の違い

多くの場合、 `onMessageReceived()` 関数が呼び出され、通知は自動的には表示されません。そのため、開発者が `onMessageReceived()` 内で、明示的に通知を表示する処理を記述する必要があります。

ただし、 「アプリがバックグランドにあり、かつ、メッセージに `notification` キーを含む」 場合は、 `onMessageReceived()` 関数は呼び出されず、通知が自動的に表示されます。

上記の条件に加えて、メッセージに `data` キーが含まれている場合には、 data の渡し方が通常とは異なります。通常は、 `onMessageReceived()` 関数で渡されますが、この場合は、ユーザーが通知をタップした際に起動されるランチャーアクティビティの Intent の Extra に格納されて渡されます。


## メッセージの送信方法

### Firebase コンソールから送信

省略


### curl コマンドで FCM HTTP v1 API を使って送信

[事前準備](#事前準備) を参照してください。


#### 1. アクセストークンを取得（gcloud CLI または OAuth2 手動発行）

##### ✅ gcloud CLI から取得（推奨）

```sh
gcloud auth application-default print-access-token
```


#### 2. 送信リクエスト（データメッセージ）

```sh
curl -X POST \
    -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
    -H "Content-Type: application/json; UTF-8" \
    https://fcm.googleapis.com/v1/projects/YOUR_PROJECT_ID/messages:send \
    -d '{
        "message": {
            "token": "YOUR_DEVICE_TOKEN",
            "data": {
                "key1": "value1",
                "key2": "value2"
            }
        }
    }'
```


### 事前準備

#### 🔐 1. サービスアカウントの秘密鍵（JSON）を取得

- Firebase コンソール > プロジェクト設定 > サービスアカウント
- 「新しい秘密鍵を生成」から .json ファイルをダウンロード


#### 🆔 2. プロジェクトIDを確認

- サービスアカウント JSON 内の "project_id" を使います


## デフォルトアイコンとデフォルトカラーの指定

```xml
<!-- Set custom default icon. This is used when no icon is set for incoming notification messages.
     See README(https://goo.gl/l4GJaQ) for more. -->
<meta-data
    android:name="com.google.firebase.messaging.default_notification_icon"
    android:resource="@drawable/ic_stat_ic_notification" />

<!-- Set color used with incoming notification messages. This is used when no color is set for the incoming
     notification message. See README(https://goo.gl/6BKBk7) for more. -->
<meta-data
    android:name="com.google.firebase.messaging.default_notification_color"
    android:resource="@color/colorAccent" />
```


## メッセージで使用可能なキー

- message JSON で使用可能なキーは、 [こちら](https://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages?authuser=0&hl=ja&_gl=1*15cqa5v*_up*MQ..*_ga*MTI0NDIwMTYwNC4xNzM0NDQ0NjYz*_ga_CW55HF8NVT*czE3NDY1ODQxMzEkbzE3JGcwJHQxNzQ2NTg0MTMxJGowJGwwJGgw#resource:-message) のドキュメントを参照してください。
- notification JSON で使用可能なキーは、 [こちら](https://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages?authuser=0&hl=ja&_gl=1*15cqa5v*_up*MQ..*_ga*MTI0NDIwMTYwNC4xNzM0NDQ0NjYz*_ga_CW55HF8NVT*czE3NDY1ODQxMzEkbzE3JGcwJHQxNzQ2NTg0MTMxJGowJGwwJGgw#notification) のドキュメントを参照してください。


## 引用元資料

- ChatGPT
- [Firebase Cloud Messaging - 公式ドキュメント](https://firebase.google.com/docs/cloud-messaging?hl=ja&authuser=0&_gl=1*1ilu3f*_up*MQ..*_ga*MTI0NDIwMTYwNC4xNzM0NDQ0NjYz*_ga_CW55HF8NVT*czE3NDY1MzA0NzYkbzE2JGcwJHQxNzQ2NTMwNTA0JGozMiRsMCRoMA..)
- [Android で Firebase Cloud Messaging クライアント アプリを設定する - 公式ドキュメント](https://firebase.google.com/docs/cloud-messaging/android/client?hl=ja&authuser=0&_gl=1*13wz6b0*_up*MQ..*_ga*MTI0NDIwMTYwNC4xNzM0NDQ0NjYz*_ga_CW55HF8NVT*czE3NDY1OTIxMzMkbzE3JGcwJHQxNzQ2NTkyMTMzJGowJGwwJGgw)



