- [サーバー証明書による証明](#サーバー証明書による証明)
  - [サーバー証明書による証明方法](#サーバー証明書による証明方法)
  - [サーバー証明書によって防げる攻撃](#サーバー証明書によって防げる攻撃)
  - [Android アプリ開発で開発者が対応すべきこと](#android-アプリ開発で開発者が対応すべきこと)
  - [サーバー証明書は何をもって本物だと認定するのか](#サーバー証明書は何をもって本物だと認定するのか)
    - [証明書の種類と審査の厳しさ](#証明書の種類と審査の厳しさ)
      - [DV（ドメイン認証）](#dvドメイン認証)
      - [OV（組織認証）](#ov組織認証)
      - [EV（拡張認証）](#ev拡張認証)
  - [信頼される認証局のリストはデバイスにインストールされている](#信頼される認証局のリストはデバイスにインストールされている)
  - [証明書チェーン](#証明書チェーン)
  - [証明書の署名の仕組み](#証明書の署名の仕組み)
  - [引用元資料](#引用元資料)


# サーバー証明書による証明

サーバー証明書は、 SSL / TLS 証明書とも呼ばれます。


## サーバー証明書による証明方法

API クライアント（アプリや Web クライアントなど）が HTTPS のエンドポイントにアクセスする場合、以下の手順で、サーバーの正当性を確認します。

1. サーバーは、 SSL / TLS 証明書を提示する
2. クライアントはその証明書が信頼できるか検証する
   1. 証明書が **信頼された認証局（CA）** によって発行されているか？
   2. ドメイン名と証明書が一致しているか？
   3. 証明書の有効期限は切れていないか？
3. 問題がなければ暗号化された安全な通信が開始されます。


## サーバー証明書によって防げる攻撃

サーバー証明書の証明には、 SSL / TSL の技術が使用されており、 SSL / TLS で実現できることが、サーバー証明書でも実現できます。

- 盗聴防止
  - 通信内容を暗号化して、第三者が読めないようにします。
- なりすまし防止
  - 攻撃者が本人を偽装しても、正規の証明書がないため接続に失敗します。
- データの改ざん防止
  - ハッシュ関数を使用して、データの改ざんを検出します。
- 中間者攻撃（MITM）の防止
  - 攻撃者が間に割り込んでも、証明書が一致しなければクライアント側が検出できます。


## Android アプリ開発で開発者が対応すべきこと

基本的には、 Retrofit ライブラリを使用していれば、開発者が証明書のチェックを行う必要はありません。基本的な証明書チェック（ SSL / TLS 検証）は Retrofit によって自動で行われます。ただし、正確には Retrofit が依存している OkHttp ライブラリが、チェックを行います。

証明書が適切ではないと判断された場合、 OkHttp では、 `SSLHandshakeException` や、その下位の `CertificateExpiredException` がスローされ、接続は自動的に拒否されます。

具体的には、 Retrofit は、 「サーバーから送信された証明書が、信頼できる認証局によって認証されているか？」 を確認します。認証局がサーバー証明書に署名を行っているため、第三者のサーバーが、信頼されているサーバーになりすまして、偽のサーバー証明書を送ることはできません。


## サーバー証明書は何をもって本物だと認定するのか

認証局は、何をもって、そのサーバーが本物だと認定するのでしょうか？

認証局（ CA ）は、証明書を発行する前に「サーバーが本物かどうか」を審査します。この審査方法は、証明書の種類によって異なります。


### 証明書の種類と審査の厳しさ

| 証明書の種類                  | 審査レベル | 認証局が確認すること               | 主な用途                                       |
| ----------------------------- | ---------- | ---------------------------------- | ---------------------------------------------- |
| DV（Domain Validation）       | 最低限     | ドメインの所有者かどうか           | 一般的な Web サイトや API                      |
| OV（Organization Validation） | 中程度     | 組織の存在・正式な運営者か         | 企業サイトや行政向け                           |
| EV（Extended Validation）     | 高度       | 法的な組織情報・実在性の厳格な確認 | 銀行・ECサイトなど信頼性が極めて重要なサービス |


#### DV（ドメイン認証）

**確認内容：このドメインの所有者はあなただと証明できるか？**

例：

- example.com に特定のファイルを設置させる（CAが指示）
- DNSレコードにCA指定の情報を追加
- 指定のメールアドレスで認証メールを受信して返信

→ 最も手軽に取得できるが、運営者の情報までは確認されない。 DV 証明書がフィッシング詐欺に利用されたことも過去にあったため、証明書が信頼できる認証局に署名されているからといって、必ずしも安全とは言えない。


#### OV（組織認証）

**ドメイン + 組織の実在性をチェック**

- 登記簿や企業データベースと照合
- 電話で確認されることもある
- 組織名などが証明書に記載される

→ 「このドメインは○○株式会社が運営している」ことが明確にわかる。


#### EV（拡張認証）

**一番厳しい。金融・政府・大手企業で使用される。**

- 法的文書の提出
- 登記簿謄本や実在確認の書類
- 実在する担当者と連絡が取れること
- 電話で認証局と直接やりとり

→ EV 証明書は、追跡可能なため、この証明書で詐欺を起こすと捕まるレベル。


## 信頼される認証局のリストはデバイスにインストールされている

Android の場合、信頼される認証局のリストは、最初からデバイスにインストールされています。その認証局によって、サーバー証明書が署名されていれば、そのサーバー証明書は、間違いなく、本物のサーバーであることが証明されます。

**注意** : 認証局は、ユーザーが後から手動で追加 (インストール) することが可能です。もし、信頼できない認証局を、ユーザーが追加してしまった場合は、本来ならば、信用されてはいけないサーバー証明書が信用されてしまうことがあります。そのため、公共 Wi-Fi に接続したとき、「信頼できる証明書をインストールしてください」と言われて、うっかりインストールしてしまうことなどが、ないようにしましょう。


## 証明書チェーン

世界には、ルート認証局と呼ばれる最も信頼できる認証局が複数存在しており、その認証局は、自分自身の署名 (自己署名) により、その正当性を照明しています。自己署名は、普段は認められない行為ですが、ルート認証局だけは、これが認められています。

サーバー証明書は、ルート認証局が直接署名をしていることは、ほとんど存在せず、たいていは、中間認証局によって、署名されています。これは、ルート CA との直接のやりとりを減らしてリスクを回避するためなどの理由があります。証明書チェーンは、以下のように、チェーンしていることがほとんどです。

- サーバー証明書に、中間 CA が署名
- 中間 CA の証明書に、ルート CA が署名

こうして、ルート CA の署名にたどり着けば、サーバー証明書の正当性が間接的に保障されます。


## 証明書の署名の仕組み

サーバー証明書への署名は、その他の署名でもよく使用される 「公開鍵暗号化方式」 が使用されています。

「公開鍵暗号化方式」 を使用した電子署名について、詳しくは、 [こちら](../電子署名/電子署名.md/#電子署名の仕組みを表した図) を参照してください。


## 引用元資料

- ChatGPT



