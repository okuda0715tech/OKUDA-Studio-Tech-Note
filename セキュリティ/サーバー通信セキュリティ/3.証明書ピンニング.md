- [証明書ピンニング](#証明書ピンニング)
  - [証明書ピンニングとは](#証明書ピンニングとは)
  - [なぜ必要か](#なぜ必要か)
  - [ピニングのやり方（Androidの例）](#ピニングのやり方androidの例)
    - [証明書の SHA256 フィンガープリントを指定する方法（公開鍵ピンニング）](#証明書の-sha256-フィンガープリントを指定する方法公開鍵ピンニング)
  - [ポイント](#ポイント)
    - [openssl コマンドで `<pin>` の値を取得する](#openssl-コマンドで-pin-の値を取得する)
  - [注意点](#注意点)
  - [引用元資料](#引用元資料)


# 証明書ピンニング

## 証明書ピンニングとは

証明書ピンニングは、アプリやブラウザが特定のサーバー証明書や公開鍵とだけ通信を許可するセキュリティ対策の一つです。「このサーバーは、 **この証明書（または鍵）** じゃなきゃ信用しないよ！」という風に、事前にピン留め（＝pin）しておくイメージです。つまり、 **「信頼する相手をアプリ自身が決める」** という方針をとっています。


## なぜ必要か

通常、HTTPS通信ではサーバーの証明書が正当かどうかは**信頼された認証局（CA）**を使って確認するけど…

- ネットワークを乗っ取られて偽の証明書を使われたら？
- デバイスに悪意あるCAがインストールされていたら？

→ このとき、 **中間者攻撃（MITM）** が成立する可能性がある。でも、証明書ピンニングしておけば、事前に指定した証明書や公開鍵以外は信用しないから、防げます。


## ピニングのやり方（Androidの例）

### 証明書の SHA256 フィンガープリントを指定する方法（公開鍵ピンニング）

```xml
<!-- res/xml/network_security_config.xml -->
<network-security-config>
    <domain-config>
        <domain includeSubdomains="true">example.com</domain>
        <pin-set expiration="2026-01-01">
            <pin digest="SHA-256">sha256/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX=</pin>
        </pin-set>
    </domain-config>
</network-security-config>
```

AndroidManifest.xml に設定する。

```xml
<application
    android:networkSecurityConfig="@xml/network_security_config"
    ... />
```

上記の設定をすることにより、

- サーバーにアクセスして、証明書の公開鍵を取得し、それを SHA-256 でハッシュ化して、アプリに登録されたピンと比較します。
  - これは、 OkHttp などのライブラリが自動的にやってくれるため、上記以外の設定は不要らしいです。
- ピンの比較結果が一致しなければ、通信は失敗します。


## ポイント

- `<pin>` に書くのは 公開鍵のSHA-256ハッシュ（証明書全体ではない）
- 複数のピンを指定できる（将来の更新のため）
- `expiration` は古くなったピンの期限
- 公開鍵の取得は openssl コマンドなどで可能


### openssl コマンドで `<pin>` の値を取得する

たとえば、以下のように `openssl` コマンドを使ってピン用ハッシュを取得できます。

```bash
# サーバーの証明書から公開鍵を抽出して、そのSHA-256ハッシュを得る
openssl s_client -connect example.com:443 -servername example.com </dev/null 2>/dev/null | \
  openssl x509 -pubkey -noout | \
  openssl pkey -pubin -outform DER | \
  openssl dgst -sha256 -binary | \
  base64
```

出てきた Base64 の文字列が、 `<pin>` の値として使用できます。


## 注意点

- サーバー証明書を更新するときにピンが一致しないと通信できなくなる
- 新しい証明書のピンも事前に含めておく「ローテーション」戦略が必要
- デバッグ時に邪魔になる場合もあるので注意





## 引用元資料

- ChatGPT
