- [認証と認可](#認証と認可)
  - [認証と認可の違い](#認証と認可の違い)
    - [認証と認可のプロトコル](#認証と認可のプロトコル)
      - [【参考】プロトコルとスキームの違い](#参考プロトコルとスキームの違い)
  - [JWT（ Json Web Token ）](#jwt-json-web-token-)
    - [JWT とは](#jwt-とは)
    - [JWT の主な用途](#jwt-の主な用途)
    - [JWT の実際のデータ例](#jwt-の実際のデータ例)
      - [ヘッダーの例](#ヘッダーの例)
      - [ペイロードの例](#ペイロードの例)
      - [署名](#署名)
      - [最終的な JWT](#最終的な-jwt)
  - [PKCE（Proof Key for Code Exchange）（読み：ピクシー）](#pkceproof-key-for-code-exchange読みピクシー)
    - [PKCE とは](#pkce-とは)
    - [PKCE の仕組み](#pkce-の仕組み)
  - [引用元資料](#引用元資料)


# 認証と認可

## 認証と認可の違い

認証（ Authentication ）と認可（ Authorization ）は、異なる意味を持っています。

- 認証
  - 「あなたは誰ですか？」を確認すること
- 認可
  - 「あなたは何をする権限がありますか？」を確認すること

例えば、 `HTTPS` スキームは、認証の仕組みで、 `OAuth 2.0` は、認可の仕組みです。

ただし、実際には、 `OAuth` でログインもできてしまうため、混同されがちです。


### 認証と認可のプロトコル

- 認証
  - OIDC ( OpenID Connect )
    - ただし、 OAuth 2.0 を含んでいるため、 「認可」 にも対応しています。
- 認可
  - OAuth 2.0

近年では、認可だけではなく、認証も必要な場合には、 OAuth 2.0 よりも、 OIDC を


#### 【参考】プロトコルとスキームの違い

プロトコルとスキームは、以下のような意味があります。

- プロトコル
  - 具体的なルールや仕様
- スキーム
  - どのプロトコルを使用するかを示す記号

例えば、 HTTPS は、 「スキーム」 です。 HTTPS は、実際には、 HTTP プロトコルと SSL / TSL プロトコルを使用しています。


## JWT（ Json Web Token ）

### JWT とは

JWT は、 **ユーザーの認証情報や認可情報を安全にやりとりするための「トークン」 (※ 1 )** を保持するのに使用される **「データ形式」** のことです。

外見上の形式は、以下のようになっています。

```
ヘッダー.ペイロード.署名
```

実際のデータは、 JSON で表現しますが、それを Base64 で符号化（エンコード）したものが、上記のデータ形式で表現され、それが、サーバーとクライアント間で受け渡しされます。

(※ 1 ) トークンとは、 「何かを表す印（印は、多くの場合、文字列です。）」 という意味が込められています。 「 ID トークン」 と言えば、 「その人が誰か（= ID）」を表す文字列を示し、 「アクセストークン」 と言えば、 「どんな権限で、どこにアクセスできるか」を表す文字列を示します。


### JWT の主な用途

JWT は、主に、 OIDC の認証の場面で使用されます。


### JWT の実際のデータ例

#### ヘッダーの例

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```


#### ペイロードの例

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "iat": 1516239022
}
```

JSON の要素一つ一つを 「クレーム（claim）」 と呼びます。（ JSON の中身全体をクレームと呼ぶ場合もあります。） `sub` クレーム、 `name` クレームなどと呼びます。

「クレーム（claim）」 は、 「主張する」 という意味の単語ですが、これは、 JWT の内容が署名によって、改ざんされていないこと (正当性) を主張するというニュアンスで、この単語が使用されています。


#### 署名

ヘッダーとペイロードの Base64URL エンコードされた文字列を使って署名を作成します。この署名によって、 JWT が改ざんされていないことが保証されます。

署名は、ヘッダーの alg（アルゴリズム）で指定された方法で、秘密鍵、または、公開鍵を使って作成されます。

署名は、次の式で計算されます。

```scss
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret)
```

#### 最終的な JWT

最終的に、これらの部分をピリオド（ `.` ）でつなげたものが、 JWT となります。

```scss
<Base64UrlEncode(ヘッダー)>.<Base64UrlEncode(ペイロード)>.<署名>
```


## PKCE（Proof Key for Code Exchange）（読み：ピクシー）

### PKCE とは

OAuth 2.0 の拡張仕様で、認可コードがハッカーによって盗聴されていたとしても、認可コードをリクエストした本人しか、認可コードを使用できないようにする仕組み。


### PKCE の仕組み

PKCE は、以下の流れでサーバーとやりとりします。

1. アプリ側での処理
   1. ランダムな文字列を生成 → code_verifier
   2. それをSHA-256でハッシュ → code_challenge
   3. 認可リクエストで code_challenge を送る
2. サーバー側での処理
   1. 認可コードを発行
   2. アプリがアクセストークンを要求するときに、元の code_verifier を送る
   3. サーバーが code_challenge を再計算して一致を確認
   4. 一致したらトークン発行（なりすまし不可！）


## 引用元資料

- ChatGPT


