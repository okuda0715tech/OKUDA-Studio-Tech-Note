- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«)
  - [ã‚µãƒ³ãƒ—ãƒ«ï¼šFirebase Authentication ã¨é€£æºã—ã¦ã€è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹](#ã‚µãƒ³ãƒ—ãƒ«firebase-authentication-ã¨é€£æºã—ã¦è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹)
    - [ğŸ” Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆ Firebase Console ã§è¨­å®šï¼‰](#-firestore-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«-firebase-console-ã§è¨­å®š)
    - [Kotlin (Android) å´ã®ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«](#kotlin-android-å´ã®ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«)
      - [ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ãªã©ã§ã‚‚ OKï¼‰](#ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ãªã©ã§ã‚‚-ok)
      - [Firestore ã¸ã®èª­ã¿æ›¸ãå‡¦ç†](#firestore-ã¸ã®èª­ã¿æ›¸ãå‡¦ç†)
    - [ğŸ”’ è£œè¶³ï¼šèªè¨¼ã•ã‚Œã¦ã„ãªã„ã¨ã©ã†ãªã‚‹ï¼Ÿ](#-è£œè¶³èªè¨¼ã•ã‚Œã¦ã„ãªã„ã¨ã©ã†ãªã‚‹)
  - [å¼•ç”¨å…ƒè³‡æ–™](#å¼•ç”¨å…ƒè³‡æ–™)


# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

## ã‚µãƒ³ãƒ—ãƒ«ï¼šFirebase Authentication ã¨é€£æºã—ã¦ã€è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

### ğŸ” Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆ Firebase Console ã§è¨­å®šï¼‰

Firestore ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¯ã€ç‹¬è‡ªã®ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰è¨€èªï¼ˆDSL: Domain Specific Languageï¼‰ ã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®è¨€èªã¯ã€Firebase ãŒæä¾›ã™ã‚‹ã‚‚ã®ã§ã€ JavaScript ã«ä¼¼ãŸæ§‹æ–‡ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€å°‚ç”¨ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```js
rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        match /users/{userId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }
    }
}
```

- `request.auth`
  - Android å´ã§ Firebase Authentication ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚Œã°ã€ Firestore ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã€è‡ªå‹•çš„ã«èªè¨¼æƒ…å ±ï¼ˆ request.auth ã«ç›¸å½“ã™ã‚‹æƒ…å ±ï¼‰ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã¾ã‚Œã¾ã™ã€‚
    - ã‚ãªãŸãŒ Firebase.auth.signInWithEmailAndPassword() ã‚„ signInAnonymously() ãªã©ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨â€¦
    - Firebase SDK ã¯ã€å†…éƒ¨çš„ã«ã€Œèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆIDãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã€ã‚’ä¿æŒã—ã¾ã™ã€‚
    - ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ Firestore ã¸ã®é€šä¿¡æ™‚ã« è‡ªå‹•ã§ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ä¸ã•ã‚Œã¾ã™ã€‚
    - ã“ã®ä»•çµ„ã¿ã®ãŠã‹ã’ã§ã€Android å´ã§æ˜ç¤ºçš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Firestore ã«æ¸¡ã™å¿…è¦ã¯ãªã„ã‚“ã§ã™ã€‚
  - `request.auth` ã¯ã€ Firebase ãŒè£å´ã§é€ã£ã¦ãã‚ŒãŸ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰è§£æã—ãŸã€Œèªè¨¼æƒ…å ±ã€ã§ã™ã€‚
  - ä¾‹ãˆã°ï¼š
    - request.auth.uid â†’ ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® UID
    - request.auth.token.email â†’ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆï¼‰
    - request.auth.token.admin â†’ ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ã„ã‚Œã°ãã®å€¤

å…·ä½“çš„ã«ã¯ï¼š

```kotlin
val uid = Firebase.auth.currentUser?.uid ?: return
Firebase.firestore.collection("users").document(uid).get()
```

ã“ã® `.get()` ã®è£ã§ã€ Firebase SDK ãŒè‡ªå‹•çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ã‘ã¦ Firestore ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãŠã‚Šã€ Firestore ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å†…ã® `request.auth` ã«åæ˜ ã•ã‚Œã¾ã™ã€‚


### Kotlin (Android) å´ã®ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«

#### ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ãªã©ã§ã‚‚ OKï¼‰

ä»¥ä¸‹ã¯åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã®ä¾‹ã§ã™ãŒã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ãªã©ã€ä»–ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã§ã‚ã£ã¦ã‚‚ã€ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã€ Firebase SDK å†…éƒ¨ã«ã€ `request.auth` ã«ç›¸å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒã€ Firestore ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ã€è‡ªå‹•çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã¾ã‚Œã¾ã™ã€‚

```kotlin
Firebase.auth.signInAnonymously()
    .addOnSuccessListener {
        Log.d("Auth", "Signed in as ${it.user?.uid}")
    }
    .addOnFailureListener {
        Log.e("Auth", "Sign in failed", it)
    }
```


#### Firestore ã¸ã®èª­ã¿æ›¸ãå‡¦ç†

Firebase Authentication ã‚’ä½¿ç”¨ã—ã¦ã„ã‚Œã°ã€ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã¯ã€è‡ªå‹•çš„ã«ä»˜ä¸ã•ã‚Œã‚‹ãŸã‚ã€ Firestore ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã¯ã€æ™®æ®µã¨å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚

```kotlin
val firestore = Firebase.firestore
// return ã¯ã€ã“ã®å¤‰æ•°ãŒã€ä½•ã‹ã®é–¢æ•°å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¦ã€
// ãã®é–¢æ•°ã‚’æŠœã‘ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
val uid = Firebase.auth.currentUser?.uid ?: return

// ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿
val userDoc = firestore.collection("users").document(uid)
val userData = mapOf(
    "name" to "Taro",
    "age" to 25
)

userDoc.set(userData)
    .addOnSuccessListener { Log.d("Firestore", "Document written") }
    .addOnFailureListener { Log.e("Firestore", "Write failed", it) }

// ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š
userDoc.get()
    .addOnSuccessListener { document ->
        if (document.exists()) {
            val name = document.getString("name")
            val age = document.getLong("age")
            Log.d("Firestore", "User: $name, Age: $age")
        } else {
            Log.d("Firestore", "No such document")
        }
    }
    .addOnFailureListener {
        Log.e("Firestore", "Read failed", it)
    }
```


### ğŸ”’ è£œè¶³ï¼šèªè¨¼ã•ã‚Œã¦ã„ãªã„ã¨ã©ã†ãªã‚‹ï¼Ÿ

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„çŠ¶æ…‹ã§ Firestore ã® `.get()` ã‚„ `.set()` ã‚’å‘¼ã¶ã¨ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒã¤ã‹ãªã„ã®ã§ã€ `request.auth == null` ã¨ãªã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«å¼•ã£ã‹ã‹ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã•ã‚Œã¾ã™ã€‚


## å¼•ç”¨å…ƒè³‡æ–™

- ChatGPT



