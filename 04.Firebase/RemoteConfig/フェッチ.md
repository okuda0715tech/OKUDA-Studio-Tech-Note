<!-- TOC START min:1 max:3 link:true asterisk:false update:true -->
- [フェッチ](#フェッチ)
  - [フェッチとは](#フェッチとは)
  - [タイムアウト](#タイムアウト)
  - [フェッチの実装サンプル](#フェッチの実装サンプル)
    - [サーバーから値をフェッチする](#サーバーから値をフェッチする)
    - [サーバーからフェッチした値を有効化する](#サーバーからフェッチした値を有効化する)
    - [サーバーから値をフェッチしてすぐに有効化する](#サーバーから値をフェッチしてすぐに有効化する)
  - [最小フェッチ可能間隔](#最小フェッチ可能間隔)
    - [本番環境でのフェッチ可能回数の上限値（目安）](#本番環境でのフェッチ可能回数の上限値目安)
    - [テスト環境でのフェッチ可能回数の上限値（目安）](#テスト環境でのフェッチ可能回数の上限値目安)
    - [最小フェッチ可能間隔の決定優先順位](#最小フェッチ可能間隔の決定優先順位)
    - [サンプルコード](#サンプルコード)
  - [フェッチした値を有効化するタイミング](#フェッチした値を有効化するタイミング)
    - [フェッチした直後にすぐに有効化するパターン](#フェッチした直後にすぐに有効化するパターン)
    - [フェッチした直後にすぐに有効化するが、有効化が完了するまでローディング画面を表示するパターン](#フェッチした直後にすぐに有効化するが有効化が完了するまでローディング画面を表示するパターン)
    - [フェッチした直後には有効化せず、次回アプリ起動時に有効化するパターン](#フェッチした直後には有効化せず次回アプリ起動時に有効化するパターン)
<!-- TOC END -->


# フェッチ

## フェッチとは

フェッチとは、 Firebase サーバーから Remote Config パラメータを取得することを言います。  
この取得は、パラメータごとに行われるのではなく、すべてのパラメータを一括して取得します。

パラメータによっては、フェッチ条件を設定しているものもあります。  
その場合は、条件判定はサーバー側で行われ、  
判定に一致するパラメーターのみがフェッチされます。


## タイムアウト

フェッチリクエストを行ってからレスポンスが返ってくるまでのタイムアウト時間は 1 分に設定されています。


## フェッチの実装サンプル

### サーバーから値をフェッチする

```java
mFirebaseRemoteConfig = FirebaseRemoteConfig.getInstance();
mFirebaseRemoteConfig.fetch();
```


### サーバーからフェッチした値を有効化する

```java
mFirebaseRemoteConfig = FirebaseRemoteConfig.getInstance();
mFirebaseRemoteConfig.activate();
```


### サーバーから値をフェッチしてすぐに有効化する

```java
mFirebaseRemoteConfig = FirebaseRemoteConfig.getInstance();

mFirebaseRemoteConfig.fetchAndActivate()
        .addOnCompleteListener(this, new OnCompleteListener<Boolean>() {
            @Override
            public void onComplete(@NonNull Task<Boolean> task) {
                if (task.isSuccessful()) {
                    // Task が完全に成功した場合

                    boolean updated = task.getResult();
                    Log.d(TAG, "Config params updated: " + updated);
                    Toast.makeText(MainActivity.this, "Fetch and activate succeeded",
                            Toast.LENGTH_SHORT).show();

                } else {
                    Toast.makeText(MainActivity.this, "Fetch failed",
                            Toast.LENGTH_SHORT).show();
                }
                // ここでパラメータを使用した何らかの処理を行う。
            }
        });
```

**onComplete(Task\<Boolean\>) メソッドの Task について**

サーバーからフェッチしたパラメータが有効化された場合は、 `task.getResult()` で  
`true` を返す `Task` が `onComplete(Task<Boolean>)` に渡されます。

バックエンドからパラメータがフェッチされず、ローカルのパラメータがアクティブのままである場合、  
`false` を返す `Task` が `onComplete(Task<Boolean>)` に渡されます。


## 最小フェッチ可能間隔

デフォルトの最小フェッチ可能間隔は 12 時間です。  
12 時間の枠の中で 1 回だけフェッチが可能であるという意味になります。  
前回のフェッチから 12 時間経過するとフェッチが可能になるわけではありません。

また、フェッチは自動的に定期的に実行されるものではなく、  
毎回、 `fetch()` メソッド等を実行することでフェッチが行われます。

ウィンドウ (枠) 内で複数回フェッチリクエストが行われた場合は、最初の 1 回だけ実際に  
フェッチが行われ、次のウィンドウになるまでは、フェッチリクエストは無効になると思われます。


### 本番環境でのフェッチ可能回数の上限値（目安）

バージョン 17.0.0 よりも前の SDK では、フェッチ リクエストは 60 分間に 5 回まで  
と制限されていました (新しいバージョンでは制限が緩和されています) 。  
具体的な値は公開されていません。


### テスト環境でのフェッチ可能回数の上限値（目安）

テスト時には、頻繁にデータをフェッチする必要があります。  
設定を行うことで、本番環境での上限値を超えてデータをフェッチすることが可能になります。

ただし、開発環境でのテスト時にも、あまりに頻繁にフェッチを行うとテスト環境での上限値に  
達してしまう場合があります。

10 人程度の開発チームでテストするだけである場合、ほとんどの場合、上限値には達しませんが、  
数千人単位の公開テストでは、上限値に達してしまう可能性があります。


### 最小フェッチ可能間隔の決定優先順位

最小フェッチ可能間隔は設定で変更することができますが、設定方法には 2 種類の方法があり、  
優先順位が決められています。

優先順位が高い順に、以下に示します。

1. `fetch(long)` のパラメータ
2. `FirebaseRemoteConfigSettings.Builder` の `setMinimumFetchIntervalInSeconds(long)` のパラメータ
3. デフォルト値 ( 12 時間)

例えば、 `fetch(long)` で、最小フェッチ可能間隔が設定されている場合には、  
`FirebaseRemoteConfigSettings.Builder` の `setMinimumFetchIntervalInSeconds(long)` の設定は無視されます。


### サンプルコード

テスト時には、頻繁にデータをフェッチする必要があるため、以下のようにフェッチ間隔を変更すると良いです。

```java
mFirebaseRemoteConfig = FirebaseRemoteConfig.getInstance();
FirebaseRemoteConfigSettings configSettings = new FirebaseRemoteConfigSettings.Builder()
        .setMinimumFetchIntervalInSeconds(3600) // 単位：秒
        .build();
mFirebaseRemoteConfig.setConfigSettingsAsync(configSettings);
```


## フェッチした値を有効化するタイミング

### フェッチした直後にすぐに有効化するパターン

- メリット
  - 最新の値がすぐに反映される
  - 実装方法が簡単である
- デメリット
  - 初回起動時の待機時間が大きくなる可能性がある
  - フェッチにどれくらい時間がかかるかがわからない
  - 待機時間が長くなった場合、ユーザーがアプリの使用を開始している可能性が高く、  
    その際に UI が大きく変更されるパラメータが有効化されてしまうと、混乱を招く恐れがある


### フェッチした直後にすぐに有効化するが、有効化が完了するまでローディング画面を表示するパターン

この方法で実装する場合は、タイムアウトを設定する必要があります。  
なぜなら、 Remote Config のフェッチのタイムアウトは 1 分であるため、  
アプリが使用可能になるまで最大で 1 分待たされてしまう可能性があるためです。

- メリット
  - 最新の値がすぐに反映される可能性が高い
  - 最新の値がすぐに取得できなかった場合は、古い値ですぐにアプリが使用可能な状態になる
- デメリット
  - 実装方法が複雑である


### フェッチした直後には有効化せず、次回アプリ起動時に有効化するパターン

- メリット
  - 初回起動時の待機時間が短縮される
- デメリット
  - 最新の値が反映されるのが次回アプリ起動時になってしまう
  - 実装方法が複雑である？**もしかして、フェッチした値は自動的に永続化されている？**


公式ドキュメントには以下の記載があるため、フェッチした値は、自動的に永続化してくれている可能性があります。

```
ダウンロードした値は、次回のアプリ起動時に有効にするまでアプリで保持されます。
```
