<!-- TOC START min:1 max:3 link:true asterisk:false update:true -->
- [アプリの署名](#アプリの署名)
  - [用語](#用語)
  - [2つの署名の方法](#2つの署名の方法)
    - [1.Google Play アプリ署名](#1google-play-アプリ署名)
    - [2. 開発者自身によるアプリ署名](#2-開発者自身によるアプリ署名)
    - [途中で「 Google Play アプリ署名」方式に変更することも可能](#途中で-google-play-アプリ署名方式に変更することも可能)
  - [公開鍵証明書の作成方法](#公開鍵証明書の作成方法)
  - [release ビルド時に自動的に署名を付与する設定](#release-ビルド時に自動的に署名を付与する設定)
    - [1. KeyStore と KeyAlias を設定した署名セットを作成する](#1-keystore-と-keyalias-を設定した署名セットを作成する)
    - [2. 登録した署名セットを build.gradle の release ビルドの設定に組み込む](#2-登録した署名セットを-buildgradle-の-release-ビルドの設定に組み込む)
    - [自動署名の注意点](#自動署名の注意点)
    - [キーストアパスワード等の外部ファイル化](#キーストアパスワード等の外部ファイル化)
  - [キーストアはアプリ毎に個別に作成するべきか](#キーストアはアプリ毎に個別に作成するべきか)
  - [鍵はアプリ毎に変えるべきか](#鍵はアプリ毎に変えるべきか)
    - [アップロード鍵については基本的には同じで良い](#アップロード鍵については基本的には同じで良い)
    - [アプリ署名鍵については基本的には変えるべき](#アプリ署名鍵については基本的には変えるべき)
    - [アプリ署名鍵を複数アプリで共有する手順](#アプリ署名鍵を複数アプリで共有する手順)
  - [署名なしアプリの作成方法](#署名なしアプリの作成方法)
<!-- TOC END -->


# アプリの署名

## 用語

- 秘密鍵
  - Android アプリでは、 `アップロード鍵` と `アプリ署名鍵` が秘密鍵にあたる
  - 組織または個人を表す 「 判子 」 の役割をする
- アップロード鍵
  - 「 Google Play アプリ署名」方式でアップロードする前に、 App Bundle または APK への署名に使用する鍵
  - 一般に公開してはいけません
- アップロード鍵証明書
  - アップロード鍵が「誰の鍵なのか」を証明する証明書
  - アップロード鍵から自分で生成、それを Google Play に登録する
  - 「アップロード鍵の公開鍵証明書」と呼ぶ場合もある
- アプリ署名鍵
  - デバイスにインストールされる APK の署名に使用される鍵
  - 一般に公開してはいけません
  - アップロード鍵を使用せず既に自分でアプリに署名してリリースしている場合でも、アップロード鍵を使用する方式に変更することができます。その際は、使用中のアプリ署名鍵を暗号化し（拡張子：`.pepk`）サーバへ登録します。
- 公開鍵証明書
  - 拡張子は `.der` or `.pem` である
  - 公開鍵 / 秘密鍵が「誰の鍵なのか」を証明する証明書
  - 公開鍵証明書の中には、「公開鍵そのもの」と「 (名前、所在地などの) 所有者情報」が含まれる
  - アップロード鍵とアプリ署名鍵の証明書は、 Play Console からダウンロードすることができます。
  - アップロード鍵の証明書は、キーストア内にも保管されています。
  - 一般に公開しても問題ありません。
- (公開鍵) 証明書フィンガープリント
  - 公開鍵証明書ファイル ( `.der` ) をインプットにして計算したハッシュ値のこと
  - 公開鍵証明書をそのまま保存するよりも、ハッシュ値を保存する方がデータ容量が少なくて済むために利用される
  - API プロバイダにアプリを登録する場合に利用することが多い
  - MD5, SHA-1, SHA-256 の各フィンガープリントは、 Play Console の [リリース -> 設定 -> アプリの完全性 -> アプリの署名] ページで確認できる
  - 上記以外のアルゴリズムで計算したフィンガープリントが必要な場合は、証明書ファイルを使用して自分で計算する
- キーストア
  - 秘密鍵とその証明書を一つのセットとして管理するリポジトリである
  - キーストア内では、複数の 「鍵と証明書のセット」 を管理することができる
  - キーストアの実体はバイナリーファイルである
  - 拡張子は `.jks` or `.keystore` である
- エイリアス
  - 鍵につける名前のこと
  - 一つのエイリアスで複数のアプリに署名することが可能である
- 公開鍵
  - 公開鍵証明書の中に生成される
  - 一般的に、アプリをリリースするだけの場合、開発者が公開鍵を意識することはない


## 2つの署名の方法

### 1.Google Play アプリ署名

アップロード鍵とアプリ署名鍵を使用した二段階の署名方法である。  
開発者はアップロード専用の署名を行い、アプリへの直接的な署名は Google によって行われる。

- メリット
  - アップロード鍵を紛失したり不正利用された場合でも、アップロード鍵をリセットするだけで済む。
    - もしそれができない場合は、アプリ更新時に (別のパッケージ名の) 別のアプリとして公開する必要がある。
  - アプリ署名鍵の管理を Google が行ってくれるため、盗難にあいにくい。
  - アプリ署名鍵を途中で変更することができる
    - ただし、新しい鍵が使用されるのは、新規インストールの場合のみ。
    - 既に古い鍵でアプリをインストール済みのデバイスにおけるアプリアップデートでは、既存のアプリ署名鍵が使用され続けます。


### 2. 開発者自身によるアプリ署名

自分で行った署名がアプリへの直接的な署名になる方法である。


### 途中で「 Google Play アプリ署名」方式に変更することも可能

アップロード鍵を使用せず、既に自分でアプリに署名してリリースしている場合でも、  
アップロード鍵を使用する方式に変更することができます。その際は、使用中のアプリ署名鍵を  
暗号化 (拡張子： `.pepk` ) し、サーバへ登録します。


## 公開鍵証明書の作成方法

既存のアプリが 「自己署名」 によるアプリ署名にてリリースされており、  
それを 「 Google アプリ署名」 に変更する場合などの場合に、自分で公開鍵証明書を作成する必要があります。

「アップロード鍵 / 公開鍵」 と 「キーストア」 を作成した後に `keytool` コマンドを使用して  
アップロード鍵 / 公開鍵から、鍵証明書を作成します。

```bash
$ keytool -export -rfc
  -keystore your-keystore.jks
  -alias key-alias
  -file output_key_certificate.pem
```


## release ビルド時に自動的に署名を付与する設定

公式ドキュメントは、画面が古いので、以下を参照すると良い。


### 1. KeyStore と KeyAlias を設定した署名セットを作成する

Android Studio のメニューから、以下の操作を行う。

```
File  
-> Project Structure  
-> Modules  
-> app  
-> Signing Configs  
-> +  
-> 署名セットの名前を入力 ( release など)  
-> KeyStore 情報と KeyAlias 情報を登録する
```


### 2. 登録した署名セットを build.gradle の release ビルドの設定に組み込む

Android Studio のメニューから、以下の操作を行い、  
先ほど登録した **署名セット** を選択する。

```
File  
-> Project Structure  
-> Build Variants  
-> app  
-> Build Types  
-> release (組み込みたい Build Type を指定)  
-> Signing Config
```


### 自動署名の注意点

上記の方法で自動署名設定を行った場合、 build.gradle ファイルにキーストアパスワードなどが  
以下のようにプレーンテキストで記述されます。

```groovy
// GROOVY の場合
android {
  signingConfigs {
    release {
      storeFile file('E:\\xxx\\yyy\\zzz')
      storePassword 'xxxxxxxx'
      keyAlias 'yyyyyyyy'
      keyPassword 'zzzzzzzz'
    }
  }
}
```

APK には、 build.gradle ファイルが含まれないため、それ自体には問題はありません。

しかし、チームで作業する場合や、 build.gradle ファイルを  
Github 等にアップロードする場合には  
第三者に情報が漏洩しないように、以下の対応が必要です。

```
キーストアパスワード等のプロパティを別のファイルに書き出し、
そのファイルを読み込んで、自動署名する。

プロパティを別のファイルに書き出した場合、そのファイルを Git 管理の対象から外し、
また、そのファイルを権限のない人物と共有しない場所で保管するように注意してください。
```


### キーストアパスワード等の外部ファイル化

**1. keystore.properties ファイルを作成する**

keystore.properties ファイルには、以下 4 つのプロパティを記載します。

```
storePassword=xxxx
keyPassword=yyyy
keyAlias=zzzz
storeFile=E:\\aaa\\bbb\\ccc   <- キーストアファイルを参照する。
```

**2. keystore.properties ファイルを適切に配置し、管理する**

keystore.properties ファイルは Git の管理対象にせず、  
チーム内の権限を持たないメンバーが参照できない場所に格納します。


**3. build.gradle を編集する**

build.gradle から keystore.properties ファイルを読み込み、メモリ上に展開する。  
展開したデータを build.gradle に渡してビルドさせる。

**GROOVY の場合**

```groovy
def keystorePropertiesFile = file("C:\\xxx\\yyy\\keystore.properties")   <-- ファイルの格納場所に応じて変更する
def keystoreProperties = new Properties()
keystoreProperties.load(new FileInputStream(keystorePropertiesFile))

android {
    signingConfigs {
      release {
        keyAlias keystoreProperties['keyAlias']   <-- 連想配列のキーはこのままで OK
        keyPassword keystoreProperties['keyPassword']   <-- 連想配列のキーはこのままで OK
        storeFile file(keystoreProperties['storeFile'])   <-- 連想配列のキーはこのままで OK
        storePassword keystoreProperties['storePassword']   <-- 連想配列のキーはこのままで OK
    }
  }
    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
```

**Kotlin の場合**

```kotlin
import java.util.Properties
import java.io.FileInputStream

// 署名情報ファイルのロード
val keystorePropertiesFile = File("C:\\xxx\\yyy\\keystore.properties") // ファイルの格納場所に応じて変更する
val keystoreProperties = Properties()
keystoreProperties.load(FileInputStream(keystorePropertiesFile))

android {
    signingConfigs {
        // 署名構成の定義
        create("release") {
            keyAlias = keystoreProperties["keyAlias"] as String // キーはこのままでOK
            keyPassword = keystoreProperties["keyPassword"] as String // キーはこのままでOK
            storeFile = file(keystoreProperties["storeFile"] as String) // キーはこのままでOK
            storePassword = keystoreProperties["storePassword"] as String // キーはこのままでOK
        }
    }
}

    buildTypes {
        release {
            // 上記で定義した署名構成を適用
            signingConfig = signingConfigs.getByName("release")
        }
    }
```


## キーストアはアプリ毎に個別に作成するべきか

複数のアプリを開発する際には「ひとつのキーストアを複数のアプリで共有」します。  
キーストアというのは証明書を保管するための単なる入れ物なので、複数の入れ物を持っておく必要はありません。  
もし証明書が複数必要でも、入れ物（キーストア）はひとつで十分です。

## 鍵はアプリ毎に変えるべきか

### アップロード鍵については基本的には同じで良い

特に理由がなければ、鍵は共有するのが良いです。

これは、そもそも証明書の考え方が「開発をする法人や個人を表す印鑑証明書」なので、開発者が複数の証明書を  
使い分けるのは好ましくないという発想なのだと思います。

Google の 「Android Developers」 公式ドキュメントでも、開発者（個人も法人も）は唯一の証明書を  
使ったほうが良いと解説されています。

一方で、アプリごとにアップロード鍵を作って署名を行うと、以下の利点があります。

- グループで開発を行っている場合、開発者に特定のアプリのアップデート権限のみ与えることができる。
- アプリを譲渡したい場合、譲渡したいアプリの証明書のみを譲渡先に渡すことができる。


### アプリ署名鍵については基本的には変えるべき

アプリ署名鍵については、セキュリティの安全性を高めるために、基本的には変えるべきである。  
ただし、自分の他のアプリと連携をとりたい場合は、同じアプリ署名鍵を使用する必要がある。


### アプリ署名鍵を複数アプリで共有する手順

アップロード鍵は、自分で選択してビルドするため、同じアップロード鍵を適用することができます。  
しかし、アプリ署名鍵は、 Google 側で署名が行われるため、自分で選択することができません。  
同一アプリ署名鍵を使用するには、 Play Console から設定を行う必要があります。

Google Play Console からは、リリースの準備ページから、 App Bundle をアップロードすると、  
「アプリの完全性」 の欄に 「鍵の変更」 ボタンが現れるため、そこから手続きを行うはず。  
まだやったことがないため、実際にやる場合には、一度テストしてから実行したほうが良い。


## 署名なしアプリの作成方法

通常、リリースビルドは、そのアプリの公開段階で署名が必要になりますが、  
署名なしでアプリを生成すること自体は可能です。

署名なしのアプリは、開発段階でのテストやデバッグのために使用され、  
アプリストアへのアップロードなどはできません。

```kotlin
android {
    buildTypes {
        release {
            // ここで署名なしでビルドする設定を追加
            signingConfig = null
        }
    }
}
```


