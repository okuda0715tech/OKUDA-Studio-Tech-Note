<!-- TOC START min:1 max:3 link:true asterisk:false update:true -->
- [ビルドバリアント / ビルドタイプ / プロダクトフレーバーについて](#ビルドバリアント--ビルドタイプ--プロダクトフレーバーについて)
  - [ビルドバリアント](#ビルドバリアント)
    - [ビルドバリアントとは](#ビルドバリアントとは)
    - [ビルドバリアントの命名規則](#ビルドバリアントの命名規則)
    - [プロダクトフレーバーとビルドバリアントの適用順序](#プロダクトフレーバーとビルドバリアントの適用順序)
    - [ビルドバリアントが生成される数](#ビルドバリアントが生成される数)
  - [ビルドタイプ](#ビルドタイプ)
    - [ビルドタイプを使用する目的](#ビルドタイプを使用する目的)
    - [ビルドタイプの作成](#ビルドタイプの作成)
    - [ビルドタイプ debug をカスタマイズする方法](#ビルドタイプ-debug-をカスタマイズする方法)
  - [プロダクトフレーバー](#プロダクトフレーバー)
    - [プロダクトフレーバーを使用する目的](#プロダクトフレーバーを使用する目的)
    - [プロダクトフレーバーは defaultConfig の設定を上書きする](#プロダクトフレーバーは-defaultconfig-の設定を上書きする)
    - [フレーバーディメンションとは](#フレーバーディメンションとは)
    - [フレーバーディメンションの作成](#フレーバーディメンションの作成)
    - [プロダクトフレーバーの作成](#プロダクトフレーバーの作成)
    - [複数のフレーバーディメンションの作成例](#複数のフレーバーディメンションの作成例)
  - [不要なビルドバリアントの生成を抑制する](#不要なビルドバリアントの生成を抑制する)
<!-- TOC END -->


# ビルドバリアント / ビルドタイプ / プロダクトフレーバーについて

## ビルドバリアント

### ビルドバリアントとは

**ビルドタイプ** と **プロダクトフレーバー** を組み合わせたビルド設定の呼び方のことを  
**ビルドバリアント** と呼びます。

ビルドタイプとプロダクトフレーバーの組み合わせの数だけ、ビルドバリアントが自動生成されます。


### ビルドバリアントの命名規則

ビルドバリアントの名前は、 `プロダクトフレーバー + ビルドタイプ` になります。

例えば、 `demo` プロダクトフレーバーと `debug` ビルドタイプを組み合わせたビルドバリアントは、  
`demoDebug` という名前になります。

フレーバーディメンションが複数存在している場合には、優先度の高いフレーバーディメンションの  
プロダクトフレーバー名が先に付与され、以下のように命名されます。  
`プロダクトフレーバー (優先度 : 高) + プロダクトフレーバー (優先度 : 低) + ビルドタイプ`  


### プロダクトフレーバーとビルドバリアントの適用順序

プロダクトフレーバーとビルドバリアントでは、プロダクトフレーバーの設定が先に適用されます。

例えば、アプリケーション ID の接尾辞を、プロダクトフレーバーとビルドバリアントの両方で設定した場合には、  
`アプリケーション ID + プロダクトフレーバーの接尾辞 + ビルドバリアントの接尾辞`  
の順番で接尾辞が付与されます。


### ビルドバリアントが生成される数

Gradle で作成されるビルドバリアントの数は、各フレーバーディメンション内の  
プロダクトフレーバーの数と、設定したビルドタイプをすべて乗算した数となります。

例えば、

- フレーバーディメンション A に所属するプロダクトフレーバーの数が 3 個
- フレーバーディメンション B に所属するプロダクトフレーバーの数が 4 個
- ビルドタイプの数が 2 個

の場合は、 3 × 4 × 2 = 24 個のビルドバリアントが生成されます。


## ビルドタイプ

### ビルドタイプを使用する目的

ビルドタイプは、 debug 、 staging 、 release のように、開発の段階別に分類を設けるのに使用します。


### ビルドタイプの作成

モジュールレベルの `build.gradle` ファイルの `android` ブロック内で、ビルドタイプを作成することができます。

```java
android {
    buildTypes {
        release {
          ...
        }
    }
}
```

ビルドタイプ `release` と `debug` は、プロジェクトを新規作成した時に、自動的に作成されます。  
ただし、 `build.gradle` に記述されるのは `release` タイプのみです。  

`debug` タイプは `build.gradle` に記述されませんが、裏で自動生成は行われているため、  
ビルドバリアントの選択画面から選択することが可能です。


### ビルドタイプ debug をカスタマイズする方法

`debug` ビルドをカスタマイズするには、対象のビルドタイプに `debuggable true` を記述します。  
これにより、裏で生成された `debug` ビルドを継承したビルドタイプを作成することができます。

```
android {
  buildTypes {
    // debug ビルドをカスタマイズしたビルドタイプ mydebug を定義
    mydebug {
      debuggable true      
    }
  }
}
```

`debuggable true` を記述したビルドタイプの名前が `debug` である場合、ビルドバリアントで  
`debug` を選択すると、自分でカスタマイズした `debug` ビルドが選択されます。

```
android {
  buildTypes {
    // ビルドバリアントで debug を選択した場合、ここで定義した debug が選択されます。
    debug {
      debuggable true
    }
  }
}
```


## プロダクトフレーバー

### プロダクトフレーバーを使用する目的

プロダクトフレーバは、一言でいうと、「製品の特徴」と言えます。

free / trial / paid や demo / full のように、ユーザーが製品を選択する分類として使用されます。



### プロダクトフレーバーは defaultConfig の設定を上書きする

`defaultConfig` は、 `ProductFlavor` クラスに属しています。

`defaultConfig` ブロックですべてのプロダクトフレーバーに共通の設定を行い、  
独自の値を設定したい項目は、各 `productFlavors` ブロックで上書き設定をします。


### フレーバーディメンションとは

フレーバーディメンションは、プロダクトフレーバーをグルーピングするグループのことです。  
プロダクトフレーバーの中には、同じ基準で分類されるために、重複することがないプロダクトフレーバーが存在します。  
それらのプロダクトフレーバーが重複するのを防ぐ役割があります。  
(Gradle では、同じフレーバーディメンションに属するプロダクトフレーバー同士が組み合わされることはありません。)

例えば、 free / trial / paid / demo / full の 5 つのプロダクトフレーバーを作成したとします。  
free / trial / paid の 3 つについては、料金に関する分類であるため、 charges という分類名を付けたとします。  
demo / full の 2 つについては、機能に関する分類であるため、 function という分類名を付けたとします。  
アプリは、 3 つの料金体系のうち、どれか 1 つの料金体系に所属し、  
2 つの機能体系のうち、どれか 1 つの機能体系に所属していることが考えられます。  
したがって、このアプリは、 3 × 2 = 6 通りのアプリが生成されればすべての製品特性を網羅した  
ビルドが行われていることになります。

以下の表は、上記の例に基づいたビルドバリアント一覧です。  
（実際には、さらにビルドタイプを考慮する必要があり、ビルドバリアントの数は増えるでしょう。）

charges | function | ビルドバリアント
--------|----------|-----------------
free    | demo     | freeDemo
free    | full     | freeFull
trial   | demo     | trialDemo
trial   | full     | trialFull
paid    | demo     | paidDemo
paid    | full     | paidFull


### フレーバーディメンションの作成

すべてのプロダクトフレーバーは、必ず一つのフレーバーディメンションに所属しなければいけません。  
所属していない場合、ビルドエラーが発生します。

例えば、 `version` という名前のフレーバーディメンションを定義するには、以下のようにします。

```
android {
  flavorDimensions "version"
}
```


### プロダクトフレーバーの作成

モジュールレベルの `build.gradle` ファイルの `android` ブロック内で、  
プロダクトフレーバーを作成することができます。

`version` という名前のフレーバーディメンションを定義し、そのディメンションに  
`demo` 、 `full` という二つのプロダクトフレーバーを所属させる例を示します。

```java
android {
  flavorDimensions "version"
  productFlavors {
    demo {
      // フレーバーディメンションの定義が一つしか存在しない場合は、 dimension の指定は省略可能です。
      dimension "version"
    }
    full {
      dimension "version"
    }
  }
}
```


### 複数のフレーバーディメンションの作成例

```java
android {
  buildTypes {
    debug {}
    release {}
  }

  // 優先順位が高い順にパラメータを設定します。（左にいくほど優先順位が高い）
  flavorDimensions "api", "mode"

  productFlavors {
    // defaultConfig の設定を mode ディメンションの設定で上書きします。
    demo {
      dimension "mode"
    }

    full {
      dimension "mode"
    }

    // api フレーバーディメンションの方が、 mode フレーバーディメンションよりも優先順位が高いため、
    // mode ディメンションの設定を api ディメンションの設定で上書きします。
    minApi24 {
      dimension "api"
      // Android App Bundle (AAB) 形式でリリースする場合は API レベルごとにアプリを
      // リリースする必要がないため、この分類のプロダクトフレーバーは必要ないと思われる。
      // APK 形式でリリースする場合には、 API レベル別に APK を作成することがある。
      minSdkVersion 24
      versionCode 30000 + android.defaultConfig.versionCode
      versionNameSuffix "-minApi24"
    }

    minApi23 { <--- minApi23 の A は、ビルドバリアント名の中でも大文字のまま残ります。
      dimension "api"
      minSdkVersion 23
      versionCode 20000  + android.defaultConfig.versionCode
      versionNameSuffix "-minApi23"
    }

    minApi21 {
      dimension "api"
      minSdkVersion 21
      versionCode 10000  + android.defaultConfig.versionCode
      versionNameSuffix "-minApi21"
    }
  }
}
```


## 不要なビルドバリアントの生成を抑制する

以下の例では、 「 minApi21 」 と 「 demo 」 のプロダクトフレーバーを組み合わせたすべての  
ビルドバリアント (ビルドタイプが何であろうと) を除外できます。

```java
android {

  buildTypes {}

  flavorDimensions "api", "mode"
  productFlavors {
    demo {}
    full {}
    minApi24 {}
    minApi23 {}
    minApi21 {}
  }

  variantFilter { variant ->
      // プロダクトフレーバーの一覧を取得する
      def names = variant.flavors*.name
      // if 文の条件内で特定のビルドタイプを判定したい場合には、
      // variant.buildType.name == "<buildType>"
      // のように記述します。
      if (names.contains("minApi21") && names.contains("demo")) {
          // Gradle は、 if 文の条件に一致する全てのビルドバリアントの生成を抑止します。
          setIgnore(true)
      }
  }
}
```
