- [よくあるエラーとその対処方法](#よくあるエラーとその対処方法)
  - [Use JsonReader.setLenient(true) エラー](#use-jsonreadersetlenienttrue-エラー)
    - [エラー詳細](#エラー詳細)
    - [原因](#原因)
    - [対処方法](#対処方法)
  - [Expected BEGIN\_OBJECT but was STRING エラー](#expected-begin_object-but-was-string-エラー)
    - [エラー詳細](#エラー詳細-1)
    - [原因](#原因-1)
    - [対処方法](#対処方法-1)
  - [Xxxx requires explicit JsonAdapter to be registered エラー](#xxxx-requires-explicit-jsonadapter-to-be-registered-エラー)
    - [エラー詳細](#エラー詳細-2)
    - [原因](#原因-2)
    - [対処方法](#対処方法-2)


# よくあるエラーとその対処方法

## Use JsonReader.setLenient(true) エラー

### エラー詳細

```
Use JsonReader.setLenient(true) to accept malformed JSON at line 1 column 1 path $
```


### 原因

未調査


### 対処方法

`setLenient()` を有効にした Gson オブジェクトを `GsonConverterFactory.create()` に渡す。

```java
Gson gson = new GsonBuilder()
        .setLenient()
        .create();

Retrofit retrofit = new Retrofit.Builder()
        .baseUrl(URL)
        .client(client)
        .addConverterFactory(GsonConverterFactory.create(gson))
        .build();
```


## Expected BEGIN_OBJECT but was STRING エラー

### エラー詳細

```
java.lang.IllegalStateException: Expected BEGIN_OBJECT but was STRING at line 1 column 1 path $
```

上記エラーの日本語訳は、

```
BEGIN_OBJECT を期待したが、 1 行目 1 列目のパスで String だった。
```

となります。


### 原因

レスポンスボディが `String` で返ってきているにも関わらず、アプリ側では、 `BEGIN_OBJECT` を期待している。  
`BEGIN_OBJECT` とは、中括弧 `{` を意味する。  
アプリ側で、レスポンスボディは `JSON` 形式であると想定しており、実際には `String` 形式だった場合などに  
発生するエラーである。


### 対処方法

レスポンスボディが `JSON` 形式の場合は、 `GsonConverterFactory` を指定する。  
レスポンスボディが `String` 形式の場合は、 `ScalarsConverterFactory` を指定する。

**java**

```java
// 変更前
Retrofit retrofit = new Retrofit.Builder()
    .baseUrl(TwitterApiBaseUrl)
    .addConverterFactory(GsonConverterFactory.create(gson))
    .build();

// 変更後
Retrofit retrofit = new Retrofit.Builder()
    .baseUrl(TwitterApiBaseUrl)
    .addConverterFactory(ScalarsConverterFactory.create())
    .build();
```

**build.gradle**

```java
def retrofit_version = "2.9.0"
implementation "com.squareup.retrofit2:retrofit:$retrofit_version"
// GsonConverterFactory の場合は、以下が必要
implementation "com.squareup.retrofit2:converter-gson:$retrofit_version"
// ScalarsConverterFactory の場合は、以下が必要
implementation "com.squareup.retrofit2:converter-scalars:$retrofit_version"
```


## Xxxx requires explicit JsonAdapter to be registered エラー

### エラー詳細

```
Caused by: java.lang.IllegalArgumentException: Platform class java.net.URI requires explicit JsonAdapter to be registered
```


### 原因

JSON コンバーターが URI クラスの変換方法を知らないため、開発者が定義する必要がある。


### 対処方法

コンバーターを定義して、 Moshi オブジェクトの構築時に渡してあげる。

```kotlin
private val moshi = Moshi.Builder()
    // 基本的なコンバーター
    .add(KotlinJsonAdapterFactory())
    // 自分で定義したコンバーターを追加
    .add(UriJsonAdapter())
    .build()

// コンバーターを定義する。
private class UriJsonAdapter {
    @ToJson
    fun toJson(uri: URI): String {
        return uri.toString()
    }

    @FromJson
    fun fromJson(uriString: String): URI {
        return URI(uriString)
    }
}
```
