- [02.フィクスチャのセットアップパターン](#02フィクスチャのセットアップパターン)
  - [インラインセットアップ](#インラインセットアップ)
  - [暗黙的セットアップ](#暗黙的セットアップ)
  - [生成メソッドでセットアップ](#生成メソッドでセットアップ)
  - [外部リソースからのセットアップ](#外部リソースからのセットアップ)


# 02.フィクスチャのセットアップパターン

フィクスチャのセットアップが簡単なものであれば、テストメソッド内でセットアップを行っても、テストコードの可読性を下げることはありません。しかし、セットアップが複雑な処理の場合は、何らかの対策を行って、可読性が上がる工夫を行った方が良いでしょう。このドキュメントでは、その方法をいくつか説明します。


## インラインセットアップ

インラインセットアップは、テストメソッド内で、フィクスチャをセットアップする方法です。

セットアップ処理が簡単な場合は、積極的にこの方法を採用すると良いでしょう。セットアップ処理と検証内容が一ヶ所に定義されていることで、可読性が良い方法となります。


## 暗黙的セットアップ

暗黙的セットアップは、 @Before アノテーションを付与したメソッド (セットアップメソッド) 内で、フィクスチャをセットアップする方法です。

この方法を使用すると、特定のテストクラス内の共通処理を抽出することができます。

暗黙的セットアップは、 Enclosed テストランナーと組み合わせると相性が良いです。 Enclosed テストランナーでは、共通のフィクスチャでクラスをネストするため、ネストされたクラス内で、抽出可能な共通処理が存在している可能性が高いためです。

セットアップメソッド内で、すべてのフィクスチャを準備する必要はないため、インラインセットアップと暗黙的セットアップを組み合わせて使用することも可能です。


## 生成メソッドでセットアップ

生成メソッドでのセットアップとは、テストクラスの外部に定義した static メソッドで、フィクスチャをセットアップする方法です。

この方法を使用すると、暗黙的セットアップでは実現できなかった、 「クラスをまたぐ共通処理」 を抽出することができます。

以下の例では、 Book インスタンスの生成処理を BookStoreTestHelper クラスの static メソッドに抽出した例です。以下では、同一クラス内からしか、共通メソッドを呼び出していませんが、実践では、複数のクラスから呼び出すことで効果を発揮します。

```java
public class BookStoreTest {

    @Test
    public void getTotalPrice() throws Exception {
        // SetUp
        BookStore sut = new BookStore();
        Book book = Bookオブジェクトの作成_MartinFowlerのRefactoring();
        sut.addToCart(book, 1);
        // Exercise & Verify
        assertThat(sut.getTotalPrice(), is(4500));
    }

    @Test
    public void get_0() throws Exception {
        // SetUp
        BookStore sut = new BookStore();
        Book book = Bookオブジェクトの作成_MartinFowlerのRefactoring();
        sut.addToCart(book, 1);
        // Exercise & Verify
        assertThat(sut.get(0), is(sameInstance(book)));
    }
}
```

```java
public class BookStoreTestHelper {

    public static Book Bookオブジェクトの作成_MartinFowlerのRefactoring() {
        Book book = new Book();
        book.setTitle("Refactoring");
        book.setPrice(4500);
        Author author = new Author();
        author.setFirstName("Martin");
        author.setLastName("Fowler");
        book.setAuthor(author);
        return book;
    }
}
```


## 外部リソースからのセットアップ

外部リソースからのセットアップとは、 JSON / XML / YAML / CSV などの外部ファイルに定義したデータを Java や Kotlin で読み込んで、フィクスチャをセットアップする方法です。

データの特徴にあった適切なフォーマットを選択すれば、データの視認性や生成などが簡単になるでしょう。

以下の例は、 YAML ファイルでデータを定義して、それを読み込む例です。 ( YAML を読み書きする SnakeYaml というライブラリを使用しています。)

```yaml
!!ch07.Book
title: Refactoring
price: 4500
author: !!ch07.Author
  firstName: Martin
  lastName: Fowler
```

```java
public class BookStoreYamlTest {

    @Test
    public void getTotalPrice() throws Exception {
        // SetUp
        BookStore sut = new BookStore();
        Book book = (Book) new Yaml().load(getClass().getResourceAsStream("book_fixtures.yaml"));
        sut.addToCart(book, 1);
        // Exercise & Verify
        assertThat(sut.getTotalPrice(), is(4500));
    }

    @Test
    public void get_0() throws Exception {
        // SetUp
        BookStore sut = new BookStore();
        Book book = (Book) new Yaml().load(getClass().getResourceAsStream("book_fixtures.yaml"));
        sut.addToCart(book, 1);
        // Exercise & Verify
        assertThat(sut.get(0), is(sameInstance(book)));
    }
}
```






