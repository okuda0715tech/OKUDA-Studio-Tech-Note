# リポジトリ

## リポジトリの役割

- ネットワークアクセスAPIやDBアクセスAPIを隠蔽することで、APIを利用する側のクラスとAPIを実装する側のクラスを疎結合にする
  - APIを利用する側と利用される側のクラスを別々にテストすることができる
  - リポジトリを利用する側のクラスを変更した際に、リポジトリ内の実装を変更せずに済む
- WebサーバへのアクセスとDBへのアクセスを連携させてデータ取得を行うことができる
  - (例)Webから最新のデータを取得するが、取得後はDBにキャッシュとして保存することで、次回キャッシュデータを使用することができる


## DBを唯一の信頼できるデータソースとする

異なるREST APIが同じデータを返すことはよくあります。
2ペインの画面で両方に友人リストが表示される画面を想像してください。
一方の画面ではAというREST APIにリクエストをし、もう一方の画面ではBと言うREST APIにリクエストします。
AとBのREST APIは異なりますが、同じ友人リストのオブジェクトをレスポンスに含みます。
Aのレスポンスを受け取り、Bがリクエストする最中にサーバ側で友人リストに変更があったとします。
レスポンスの結果を直接UIに反映していた場合、左右の画面に表示されている友人リストは不整合な状態になります。

このため、Repositoryの実装ではWebサービスからのレスポンスをDBに保存するだけにします。
DBを更新することによって、LiveDataオブジェクトのコールバックがトリガされて、左右どちらの画面も整合性のとれた友人リストを表示することができます。
リポジトリがWebとDBの二つのデータソースを持つ場合、１つのデータソース(上記の例では、DB)を"信頼できる唯一の情報源"として指定することをお勧めします。


## サンプルコード

ネットワークから取得したデータをLiveDataを使用してDBに保存するリポジトリのサンプル

[リンク](https://qiita.com/oya-t/items/e4f65ec42de9ee65d6f1)

一番下の`Appendix：ネットワーク状態を公開する`の章の本当に最後の2,3個のコードスニペットがそのソースコードです。

