<!-- TOC START min:1 max:3 link:true asterisk:false update:true -->
- [Google One バックアップ（自動バックアップ）](#google-one-バックアップ自動バックアップ)
  - [概要](#概要)
  - [対応 API レベル](#対応-api-レベル)
  - [エンドツーエンドの暗号化](#エンドツーエンドの暗号化)
  - [バックアップの対象となるファイル](#バックアップの対象となるファイル)
  - [バックアップが保存される場所](#バックアップが保存される場所)
  - [保存可能なデータ容量](#保存可能なデータ容量)
  - [バックアップデータの保存期間](#バックアップデータの保存期間)
  - [バックアップ可能なのは一世代のみ](#バックアップ可能なのは一世代のみ)
  - [第三者のバックアップデータへのアクセス権](#第三者のバックアップデータへのアクセス権)
  - [バックアップが作成されているかどうかを確認する](#バックアップが作成されているかどうかを確認する)
  - [一つの Google アカウントで、複数デバイスにてバックアップを行った場合](#一つの-google-アカウントで複数デバイスにてバックアップを行った場合)
  - [バックアップ実行条件](#バックアップ実行条件)
  - [復元実行条件](#復元実行条件)
    - [インストール時の復元における制約](#インストール時の復元における制約)
    - [セットアップウィザード実行時の復元における制約](#セットアップウィザード実行時の復元における制約)
  - [バックアップを有効または無効にする](#バックアップを有効または無効にする)
<!-- TOC END -->


# Google One バックアップ（自動バックアップ）

## 概要

Google One バックアップは、自動バックアップと呼ばれることもあります。  
ユーザーの Google ドライブ上にアプリのバックアップデータが保存されます。


## 対応 API レベル

Android 6.0 ( API レベル 23 ) 以降のデバイスに対応しています。


## エンドツーエンドの暗号化

Android 9 以降を搭載したデバイスでのバックアップは、デバイスの PIN、パターン、  
またはパスワードを使用してエンドツーエンドで暗号化されます。


## バックアップの対象となるファイル

以下のファイルはバックアップの対象となります

- `SharedPreference` のファイル
- `getFilesDir()` または `getDir(String, int)` によってアクセスされる、アプリの内部ストレージに保存されているファイル
- `getDatabasePath(String)` から返されるディレクトリ内のファイル ( SQLiteOpenHelper クラスで作成されたファイルも含む)
- 外部ストレージ上の、 `getExternalFilesDir(String)` から返されるディレクトリ内のファイル

以下のファイルはバックアップの対象となりません。

- `getCacheDir()` 、`getCodeCacheDir()` 、`getNoBackupFilesDir()` から返されるディレクトリ内のファイル

これらの場所に保存されているファイルは、一時的に必要なファイル、  
バックアップ処理から意図的に除外されたファイルです。


## バックアップが保存される場所

バックアップデータは、ユーザーの Google ドライブアカウントのプライベートフォルダに保存されます。  
保存されたデータは、ユーザー個人の Google ドライブの容量にカウントされません。


## 保存可能なデータ容量

アプリ一つにつき 25 MB まで保存可能です。  
デバイス内にアプリがいくつインストールされていても、この上限は変わりません。

データの量が 25 MB を超えると、システムによって `onQuotaExceeded()` が呼び出され、  
データがクラウドにバックアップされなくなります。その後、データの量が 25 MB のしきい値より  
少なくなったかどうかがシステムによって定期的にチェックされ、  
少なくなった場合は自動バックアップが再開されます。


## バックアップデータの保存期間

たしか、 180 日間アクセスがないと削除されるんだったかなぁ？  
よく覚えていないので、正確な情報は別途調査が必要。


## バックアップ可能なのは一世代のみ

保存されるのは最新のバックアップのみです。  
バックアップが作成されると、以前のバックアップが存在する場合は削除されます。


## 第三者のバックアップデータへのアクセス権

ユーザーやデバイス上の他のアプリがバックアップデータを読み取ることはできません。


## バックアップが作成されているかどうかを確認する

Google ドライブアプリを使用して、バックアップが作成されているアプリを確認することができます。

`ドロワーメニュー -> バックアップ -> [デバイス名] のバックアップ -> アプリのデータ`

から、バックアップされたアプリ名と最終バックアップ実行日時を確認することができます。


## 一つの Google アカウントで、複数デバイスにてバックアップを行った場合

一つの Google アカウントで、複数デバイスにてバックアップを行った場合は、  
各デバイスごとにバックアップデータが保存されます。

復元処理時に、複数のバックアップが存在する場合は、次のようなルールで復元されるデータセットが決まります。

```
バックアップデータセットの中に自分のアカウント、かつ、自分のデバイスで作成したバックアップが含まれているか？
　├ (Yes) 自分自身のバックアップから復元が行われる。
　└ (No) 工場出荷状態に初期化されているデバイスで、デバイス設定ウィザードを使用してセットアップをしているか？
　　├ (Yes) デバイス設定ウィザード内で、どのデータセットから復元するかをユーザーが選択する。
　　└ (No) データの復元は行われない。
```


## バックアップ実行条件

以下の条件をすべて満たしている場合、 **バックアップ** が自動的に行われます。

- ユーザーによってデバイスでバックアップが有効化されている。
  - Android 9 では、この設定は [設定] > [システム] > [バックアップ] にあります。
- 前回のバックアップから少なくとも 24 時間経過している。
- デバイスがアイドル状態である。
  - バックアップの最中にアプリがフォアグラウンドになった場合は、そのアプリのバックアップを行いません。
  - その理由は、ファイルへの読み書きが同時に発生して、ロック等がかかるのを回避するためです。
  - ただし、 `android:backupInForeground` 属性を `true` に設定すると、アプリをシャットダウンして、バックアップを行うように変更できます。
- デバイスが Wi-Fi ネットワークに接続されている
  - ただし、デバイスのユーザーがモバイルデータのバックアップを有効にしていない場合に限る

ただし、 **アップロード** は、アプリデータが変更された場合にのみ行われます。


## 復元実行条件

データの復元が実行されるタイミングには、以下の二つがあります。

1. アプリのインストール時 ( adb install の実行によるインストールを含む)
2. 工場出荷状態に初期化されたデバイスのセットアップ (初期設定) ウィザード実行時

復元処理は、ユーザーがアプリを起動できるようになる前に行われます。


### インストール時の復元における制約

アプリのインストール時における復元処理には、制約があります。 **バックアップデータが自分のアカウントで作成され、かつ、復元したいデバイスと同一デバイスでバックアップが作成された場合のみ、データが復元されます。** つまり、同一アカウントでログインしていない場合や、機種変更の場合には、アプリをインストールしても、データは復元されません。そのため、 **機種変更の場合は、必ず、デバイスのセットアップウィザードの中で復元処理を行う必要があります。**


### セットアップウィザード実行時の復元における制約

**セットアップウィザード実行中にデータを復元できるチャンスは一度のみです。** アプリのコピー自体をスキップした場合は、後からもう一度復元できるチャンスが少しの間はあります。しかし、一つでもアプリをコピーしてしまうと、それ以降、アプリのコピーのウィザードを表示することはできません。また、少し時間が経った場合もウィザードを表示することができなくなります。そのため、最初のセットアップウィザードでのコピーの機会を逃すと、その後、データ移行する機会が保証されません。

セットアップウィザード実行時にデータを復元するには、 **アプリが Play Store に公開されている必要があると思われます。** そう推測する根拠は、新しいデバイスのセットアップウィザードで、アプリをコピーするには、インストール候補のアプリを Play Store から見つけ出す必要があります。アプリを見つけ出すのに、古いスマホにインストールされているアプリの署名情報を使用しているものと思われます。パッケージ名が一致していても、署名が一致していないアプリは、セットアップウィザードのアプリのコピー時に、候補として表示されませんでした。


## バックアップを有効または無効にする

次のように、 `android:allowBackup` 属性を `true` にすると、  
アプリが Google One バックアップの対象となり、 `false` にするとバックアップの対象から外れます。

```xml
<manifest>
    <application android:allowBackup="true">

    </application>
</manifest>
```

Android でバックアップすべきでない機密情報をアプリで扱っている場合は、  
バックアップを無効することをおすすめします。
