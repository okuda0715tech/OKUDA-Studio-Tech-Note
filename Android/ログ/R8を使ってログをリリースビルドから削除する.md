- [R8を使ってログをリリースビルドから削除する](#r8を使ってログをリリースビルドから削除する)
  - [概要](#概要)
  - [R8 の有効化](#r8-の有効化)
  - [proguard-rules.pro の編集](#proguard-rulespro-の編集)
    - [基本的な編集方法](#基本的な編集方法)
  - [maximumremovedandroidloglevel の設定について](#maximumremovedandroidloglevel-の設定について)
  - [ログの削除のみ実施し、 R8 の圧縮を実施したくない場合](#ログの削除のみ実施し-r8-の圧縮を実施したくない場合)


# R8を使ってログをリリースビルドから削除する

## 概要

R8 の機能を使用して、特定のレベルのログを  
リリースビルドから削除する方法について説明します。


## R8 の有効化

R8 を有効化するには、 build.gradle に以下を記述します。  

**build.gradle.kts**

```kotlin
android {
    buildTypes {
        release {
            // true にする必要があります。
            isMinifyEnabled = true
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
}
```

上記の設定では、リリースビルドに対してのみ R8 が有効になるため、  
ログの削除はリリースビルドにつていのみ行われます。


## proguard-rules.pro の編集

### 基本的な編集方法

`proguard-rules.pro` に以下を追記します。

```
# デバッグログを無効にする
-assumenosideeffects class android.util.Log {
    public static boolean isLoggable(java.lang.String, int);
    public static int e(...);
    public static int w(...);
    public static int i(...);
    public static int d(...);
    public static int v(...);
}
```

`assumenosideeffects` コマンドには、  
「削除しても副作用がないため、ブロック内に記述したメソッドやフィールドを削除してください」  
という意味が含まれています。

上記の例では、 ERROR レベルから VERBOSE レベルまで  
全てのレベルのログ出力処理が R8 実行時に削除されます。  
削除したくないレベルのメソッドは `#` でコメントアウト等を行ってください。


## maximumremovedandroidloglevel の設定について

以下の公式ドキュメントには、 `-maximumremovedandroidloglevel 4` のように  
`maximumremovedandroidloglevel` コマンドを記載するように指示されています。

[公式ドキュメント](https://source.android.com/docs/core/tests/debug/understanding-logging?hl=ja#log-level-guidelines)

しかし、簡単に調べてみたところ、このコマンドは不要のようです。  
あまり詳しい情報もないため、今のところ、詳しくは調べなくて大丈夫かと思います。


## ログの削除のみ実施し、 R8 の圧縮を実施したくない場合

不要なログを削除するためには、 build.gradle で `isMinifyEnabled = true`  
を設定することで、 R8 の圧縮機能を有効化する必要があります。

しかし、場合によっては、圧縮機能を有効化したくない場合もあるでしょう。

そのような場合には、 proguard-rules.pro ファイルに以下を追加してください。

```
-dontwarn **
-dontusemixedcaseclassnames
-dontskipnonpubliclibraryclasses
-dontpreverify
-verbose

-optimizations !code/simplification/arithmetic,!code/allocation/variable
-keep class **
-keepclassmembers class *{*;}
-keepattributes *
```


