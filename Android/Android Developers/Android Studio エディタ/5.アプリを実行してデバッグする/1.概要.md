- [アプリをビルドして実行する](#アプリをビルドして実行する)
  - [基本的なビルドと実行](#基本的なビルドと実行)
  - [ビルドプロセスをモニタリングする](#ビルドプロセスをモニタリングする)
  - [発展的なビルドと実行の機能](#発展的なビルドと実行の機能)
    - [変更を適用して段階的にデプロイする](#変更を適用して段階的にデプロイする)
      - [要件](#要件)
      - [Apply Changes の使用](#apply-changes-の使用)
      - [変更を適用の実行フォールバックを有効にする](#変更を適用の実行フォールバックを有効にする)
      - [プラットフォームに依存する変更](#プラットフォームに依存する変更)
      - [Apply Changes の制限](#apply-changes-の制限)
        - [アプリの再起動が必要なコード変更](#アプリの再起動が必要なコード変更)
        - [ライブラリとプラグイン](#ライブラリとプラグイン)
        - [インストールされた APK のコンテンツを直接参照するコード](#インストールされた-apk-のコンテンツを直接参照するコード)


# アプリをビルドして実行する

## 基本的なビルドと実行
## ビルドプロセスをモニタリングする
## 発展的なビルドと実行の機能

### 変更を適用して段階的にデプロイする

Android Studio 3.5 以降では、変更を適用することで、アプリを再起動せずに、また場合によっては現在のアクティビティを再起動せずに、実行中のアプリにコードとリソースの変更をプッシュできます。この柔軟性により、デバイスの現在の状態を維持しながら小さな増分変更をデプロイしてテストする場合に、アプリをどの程度再起動するかを制御できます。

Apply Changes では、Android 8.0 (API レベル 26) 以降を実行しているデバイスでサポートされている [Android JVMTI 実装の機能](https://docs.oracle.com/javase/8/docs/platform/jvmti/jvmti.html#bci) を使用します。 Apply Changes の仕組みの詳細については、 [Android Studio Project Marble: Apply Changes](https://medium.com/androiddevelopers/android-studio-project-marble-apply-changes-e3048662e8cd) をご覧ください。


#### 要件

変更を適用アクションは、次の条件を満たしている場合にのみ使用できます:

- デバッグ ビルド バリアントを使用してアプリの APK をビルドします。

- Android 8.0 (API レベル 26) 以上を実行するターゲット デバイスまたはエミュレーターにアプリをデプロイします。


#### Apply Changes の使用

変更を互換性のあるデバイスにデプロイする場合は、次のオプションを使用します。

- **変更を適用してアクティビティを再起動** (※ 1 )
  - アクティビティを再起動することで、アプリを再起動せずにリソースとコードの両方の変更を適用しようとします。通常、 **このオプションは、メソッド本体のコードを変更した場合や既存のリソースを変更した場合に使用できます。**
  - このアクションは、Control+Alt+F10 (macOS では Control+Command+Shift+R) を押して実行することもできます。

(※ 1 )  
<img src="./画像/toolbar-apply-changes.png" width="200">


- **コードの変更を適用** (※ 2 )
  - 何も再起動せずにコードの変更のみを適用しようとします。通常、 **このオプションは、メソッド本体のコードを変更したがリソースを変更していない場合に使用できます。** コードとリソースの両方を変更した場合は、代わりに変更を適用してアクティビティを再起動を使用してください。
  - このアクションは、Control+F10 (macOS では Control+Command+R) を押して実行することもできます。

(※ 2 )  
<img src="./画像/toolbar-apply-code-changes.png" width="200">


- **実行** (※ 3 )
  - すべての変更をデプロイし、アプリを再起動します。このオプションは、変更を適用オプションのいずれを使用しても、行った変更を適用できない場合に使用します。アプリの再起動が必要な変更の種類の詳細については、 [「変更を適用」の制限事項]() のセクションをご覧ください。

(※ 3 )  
<img src="./画像/toolbar-run.png" width="200">


#### 変更を適用の実行フォールバックを有効にする

「変更を適用してアクティビティを再起動」または「コードの変更を適用」のいずれかをクリックすると、Android Studio は新しい APK をビルドし、変更を適用できるかどうかを判断します。変更を適用できず、変更を適用が失敗する場合は、Android Studio は代わりにアプリを再度実行するようにプロンプ​​トを表示します。

この操作が発生するたびにプロンプ​​トを表示したくない場合は、変更を適用できない場合にアプリを自動的に再実行するように Android Studio を構成できます。この動作を有効にするには、次の手順に従います。

1. 設定または環境設定ダイアログを開きます。

    - Windows または Linux では、メニューから [ファイル] > [設定] を選択します。

    - macOS では、メニューから [Android Studio] > [環境設定] を選択します。

2. [ビルド、実行、デプロイ] > [デプロイ] に移動します。

3. チェックボックスをオンにして、変更の適用アクションのいずれかまたは両方に対して自動実行フォールバックを有効にします。

4. [OK] をクリックします。

注: 変更の種類によっては、Apply Changes が失敗することはありませんが、変更を確認するにはアプリを手動で再起動する必要があります。たとえば、アクティビティの onCreate() メソッドに変更を加えた場合、その変更はアクティビティの再起動後にのみ有効になるため、変更を確認するにはアプリを再起動する必要があります。


#### プラットフォームに依存する変更

Apply Changes の一部の機能は、Android プラットフォームの特定のバージョンに依存します。これらの種類の変更を適用するには、そのバージョンの Android (またはそれ以降) を実行しているデバイスにアプリをデプロイする必要があります。たとえば、メソッドを追加するには Android 11 以降が必要です。


#### Apply Changes の制限

Apply Changes は、アプリのデプロイ プロセスを高速化するように設計されています。ただし、使用できるタイミングにはいくつかの制限があります。


##### アプリの再起動が必要なコード変更

次のような一部のコードおよびリソースの変更は、アプリを再起動するまで適用できません:

- フィールドの追加または削除
- メソッドの削除
- メソッド シグネチャの変更
- メソッドまたはクラスの修飾子の変更
- クラス継承の変更
- 列挙型の値の変更
- リソースの追加または削除
- アプリ マニフェストの変更
- ネイティブ ライブラリ (SO ファイル) の変更


##### ライブラリとプラグイン

一部のライブラリとプラグインは、アプリのマニフェスト ファイルまたはマニフェストで参照されているリソースを自動的に変更します。これらの自動更新は、次の方法で変更の適用に干渉する可能性があります:

- ライブラリまたはプラグインがアプリのマニフェストに変更を加えた場合、変更の適用は使用できません。変更を確認するには、アプリを再起動する必要があります。

- ライブラリまたはプラグインがアプリのリソース ファイルに変更を加えた場合、コード変更の適用 (※ 1 ) は使用できません。変更を確認するには、変更を適用してアクティビティを再起動 (※ 2 ) アイコン (またはアプリを再起動) を使用する必要があります。

(※ 1 )  
<img src="./画像/toolbar-apply-code-changes.png" width="200">

(※ 2 )  
<img src="./画像/toolbar-apply-changes.png" width="200">

これらの制限を回避するには、デバッグ ビルド バリアントのすべての自動更新を無効にします。

たとえば、 [Firebase Crashlytics](https://firebase.google.com/products/crashlytics) は、ビルドごとに一意のビルド ID を使用してアプリ リソースを更新します。これにより、コード変更の適用 コード変更アイコン を使用できなくなり、変更を確認するにはアプリのアクティビティを再起動する必要があります。デバッグ ビルドでコード変更の適用を Crashlytics と一緒に使用するには、この動作を無効にします。


##### インストールされた APK のコンテンツを直接参照するコード

デバイスにインストールされているアプリの APK のコンテンツをコードが直接参照している場合、コード変更を適用 (※ 1 ) アイコンをクリックした後に、そのコードがクラッシュしたり、誤動作したりする可能性があります。この動作は、コード変更を適用 をクリックすると、インストール中にデバイス上の基礎となる APK が置き換えられるため発生します。このような場合は、代わりに変更を適用してアクティビティを再開 (※ 2 ) アイコンまたは実行 (※ 3 ) アイコンをクリックできます。

(※ 1 )  
<img src="./画像/toolbar-apply-code-changes.png" width="200">

(※ 2 )  
<img src="./画像/toolbar-apply-changes.png" width="200">

(※ 3 )  
<img src="./画像/toolbar-run.png" width="200">

変更を適用 の使用中に他の問題が発生した場合は、バグを報告してください。




