- [デバイスのすべてのファイルを管理する](#デバイスのすべてのファイルを管理する)
  - [すべてのファイルへのアクセスをリクエストする](#すべてのファイルへのアクセスをリクエストする)
  - [MANAGE\_EXTERNAL\_STORAGE で許可されるオペレーション](#manage_external_storage-で許可されるオペレーション)
  - [別のアプリのストレージ管理アクティビティを呼び出す](#別のアプリのストレージ管理アクティビティを呼び出す)
  - [テストのために MANAGE\_EXTERNAL\_STORAGE を有効にする](#テストのために-manage_external_storage-を有効にする)
  - [Google Play に関する注意事項](#google-play-に関する注意事項)


# デバイスのすべてのファイルを管理する

共有ストレージへのアクセスを必要とするアプリの大半では、 [メディアファイルの共有](./8.ストレージのユースケースとベストプラクティス.md#メディアファイルを他のアプリと共有する) と [メディア以外のファイルの共有](./8.ストレージのユースケースとベストプラクティス.md/#コンテンツを他のアプリと共有する) に関するおすすめの方法に沿って設定できます。しかし、 **一部のアプリでは、重要なユースケースでデバイス上のファイルへの幅広いアクセスが必要** な場合に、プライバシーに配慮したストレージのおすすめの方法を使用して効率的にアクセスすることができません。Android では、このような状況を考慮して **「すべてのファイルへのアクセス」という特別なアプリアクセスが用意されています。**

たとえば、ウイルス対策アプリの主要なユースケースでは、さまざまなディレクトリで多数のファイルを定期的にスキャンする必要があります。このスキャンで、ユーザーがシステムファイル選択ツールを使用して繰り返しディレクトリを選択する必要があるとすれば、ユーザーエクスペリエンスが低下します。他のユースケース（ファイルマネージャーアプリ、バックアップと復元を行うアプリ、ドキュメント管理アプリなど）でも、同様の状況を考慮する必要があります。


## すべてのファイルへのアクセスをリクエストする

アプリでは、以下の手順を使用して、すべてのファイルへのアクセスをユーザーにリクエストできます。

1. マニフェストで [MANAGE_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja&_gl=1*1kvn7yf*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..#MANAGE_EXTERNAL_STORAGE) 権限を宣言します。

2. [ACTION_MANAGE_ALL_FILES_ACCESS_PERMISSION](https://developer.android.com/reference/android/provider/Settings?hl=ja&_gl=1*1kvn7yf*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..#ACTION_MANAGE_ALL_FILES_ACCESS_PERMISSION) インテントのアクションを使用してユーザーをシステム設定のページに移動します。そのページでユーザーは **[すべてのファイルを管理できるアクセス権を付与]** オプションを有効にすることができます。
アプリに MANAGE_EXTERNAL_STORAGE 権限が付与されているかどうかを判断するには、 [Environment.isExternalStorageManager()](https://developer.android.com/reference/android/os/Environment?hl=ja&_gl=1*1cve88e*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..#isExternalStorageManager()) を呼び出します。


## MANAGE_EXTERNAL_STORAGE で許可されるオペレーション

MANAGE_EXTERNAL_STORAGE 権限により、以下の権限が付与されます。

- [共有ストレージ](./4.共有ストレージに保存する/1.共有ストレージについて.md) 内のすべてのファイルへの読み取りアクセス権と書き込みアクセス権。

**注**: /sdcard/Android/media ディレクトリは共有ストレージの一部です。

- [MediaStore.Files](https://developer.android.com/reference/android/provider/MediaStore.Files?hl=ja&_gl=1*1jldu9s*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..) テーブルの内容へのアクセス権。

- USB On The Go（OTG）ドライブと SD カードの両方のルート ディレクトリへのアクセス権。

- /Android/data/、/sdcard/Android、および /sdcard/Android のほとんどのサブディレクトリを除く、すべての内部ストレージ ディレクトリへの書き込みアクセス権。この書き込みアクセス権には、 [直接ファイルパス](./4.共有ストレージに保存する/2.メディア.md/#直接ファイルパス) のアクセス権が含まれています。

この権限を付与されたアプリでも、他のアプリに属する [アプリ専用ディレクトリ](./3.アプリ固有のストレージに保存する.md) にはアクセスできません。このようなディレクトリは、ストレージ ボリューム上で Android/data/ のサブディレクトリとして表示されるためです。

アプリに MANAGE_EXTERNAL_STORAGE 権限がある場合は、 [MediaStore](https://developer.android.com/reference/android/provider/MediaStore?hl=ja&_gl=1*1g9fmn6*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..) API または直接ファイルパスを使用して、これらの追加のファイルとディレクトリにアクセスできます。ただし、 [ストレージアクセスフレームワーク](./4.共有ストレージに保存する/4.ドキュメントおよび他のファイル.md) を使用している場合は、MANAGE_EXTERNAL_STORAGE 権限がなくてもアクセスできるファイルまたはディレクトリにしかアクセスできません。


## 別のアプリのストレージ管理アクティビティを呼び出す

Android 12（API レベル 31）以降では、 [MANAGE_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?_gl=1*mbatw4*_up*MQ..*_ga*MTkwNjYyMDc4OS4xNzIyOTI1OTI5*_ga_6HH9YJMN9M*MTcyMjkyNTkyOS4xLjAuMTcyMjkyNTkyOS4wLjAuMA..#MANAGE_EXTERNAL_STORAGE) 権限と [QUERY_ALL_PACKAGES](https://developer.android.com/reference/android/Manifest.permission?_gl=1*mbatw4*_up*MQ..*_ga*MTkwNjYyMDc4OS4xNzIyOTI1OTI5*_ga_6HH9YJMN9M*MTcyMjkyNTkyOS4xLjAuMTcyMjkyNTkyOS4wLjAuMA..#QUERY_ALL_PACKAGES) 権限の両方を持つアプリ（ファイル管理アプリなど）は、getManageSpaceActivityIntent() を使用してユーザーを別のアプリのカスタム スペース管理アクティビティに送ることができます。

getManageSpaceActivityIntent() メソッドはパッケージ名とリクエスト コードを受け取り、次のいずれかを返します。

- 指定されたパッケージ名のアプリがカスタムの「スペース管理」アクティビティを定義している場合は、PendingIntent。getManageSpaceActivityIntent() メソッドを呼び出したファイル管理アプリは、返されたインテントを呼び出して、ユーザーをカスタム アクティビティに送ることができます。

- 指定されたパッケージ名のアプリが「スペース管理」アクティビティを定義していない場合は null。


## テストのために MANAGE_EXTERNAL_STORAGE を有効にする

MANAGE_EXTERNAL_STORAGE 権限がアプリに及ぼす影響を調べるには、テスト目的で権限を有効にします。これを行うには、テストデバイスに接続されているマシンで次のコマンドを実行します。

```
adb shell appops set --uid PACKAGE_NAME MANAGE_EXTERNAL_STORAGE allow
```


## Google Play に関する注意事項

このセクションでは、Google Play でアプリを公開するデベロッパー向けの注意事項について説明します。

共有ストレージへの広範なアクセスを制限するため、Google Play ストアでは、Android 11（API レベル 30）以降をターゲットとするアプリを評価し、MANAGE_EXTERNAL_STORAGE 権限を介して「すべてのファイルへのアクセス」をリクエストするようにポリシーをアップデートしました。このポリシーは 2021 年 5 月から有効です。

Android 11 以降をターゲットとするアプリで MANAGE_EXTERNAL_STORAGE 権限を宣言すると、Android Studio に図 1 のような lint 警告が表示されます。これは、この権限の「使用を制限するポリシーが Google Play ストアにある」ことを注意喚起する警告です。

<img src="./画像/MANAGE_EXTERNAL_STORAGE 権限に関する注意喚起.svg" width="600">

ストレージ アクセス フレームワークや Media Store API など、よりプライバシーに配慮した API をアプリで効果的に利用できない場合にのみ、MANAGE_EXTERNAL_STORAGE 権限をリクエストしてください。アプリによる権限の用途は、許容される用途に該当し、アプリのコア機能に直接関連している必要があります。次のようなユースケースがアプリに含まれている場合、MANAGE_EXTERNAL_STORAGE 権限をリクエストできる可能性があります。

- ファイル マネージャー
- バックアップと復元のアプリ
- ウイルス対策アプリ
- ドキュメント管理アプリ
- デバイス上のファイル検索
- ディスクとファイルの暗号化
- デバイス間のデータ移行


