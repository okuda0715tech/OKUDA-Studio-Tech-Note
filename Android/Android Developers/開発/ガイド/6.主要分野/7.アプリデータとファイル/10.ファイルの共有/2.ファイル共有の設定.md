- [ファイル共有の設定（セットアップ）](#ファイル共有の設定セットアップ)
  - [FileProvider を指定する](#fileprovider-を指定する)
  - [共有可能なディレクトリを指定する](#共有可能なディレクトリを指定する)
  - [コンテンツ URI の例](#コンテンツ-uri-の例)
  - [引用元資料](#引用元資料)


# ファイル共有の設定（セットアップ）

アプリから別のアプリにファイルを安全に提供するには、ファイルへのセキュアなハンドルをコンテンツ URI 形式で提供するようにアプリを構成する必要があります。 Android [FileProvider](https://developer.android.com/reference/androidx/core/content/FileProvider?hl=ja) コンポーネントは、 XML で指定した仕様に基づいてファイルのコンテンツ URI を生成します。このレッスンでは、 FileProvider のデフォルトの実装をアプリに追加する方法と、他のアプリに提供するファイルを指定する方法について説明します。

**注** : [FileProvider](https://developer.android.com/reference/androidx/core/content/FileProvider?hl=ja) クラスは [AndroidX Core Library](https://developer.android.com/jetpack/androidx/releases/core?hl=ja) の一部です。このライブラリをアプリに含める方法については、 [依存関係を宣言する](https://developer.android.com/jetpack/androidx/releases/core?hl=ja#declaring_dependencies) をご覧ください。


## FileProvider を指定する

アプリに対して [FileProvider](https://developer.android.com/reference/androidx/core/content/FileProvider?hl=ja) を定義するには、マニフェストにエントリが必要です。このエントリでは、コンテンツ URI の生成に使用するオーソリティ (コンテンツプロバイダ名) と、アプリが共有できるディレクトリを指定する XML ファイルの名前を指定します。

次のスニペットは、 FileProvider クラス、オーソリティ (コンテンツプロバイダ名) 、 XML ファイル名を指定する [`<provider>`](https://developer.android.com/guide/topics/manifest/provider-element?hl=ja) 要素を、マニフェストに追加する方法を示しています。

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.myapp">
    <application
        ...>
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="com.example.myapp.fileprovider"
            android:grantUriPermissions="true"
            android:exported="false">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/filepaths" />
        </provider>
        ...
    </application>
</manifest>
```

- `android:name` 属性
  - ContentProvider を実装しているクラスを指定します。
  - FileProvider は、自分で実装する必要はなく、ライブラリが提供しているクラス ( `androidx.core.content.FileProvider` ) をそのまま利用可能です。

- `android:authorities` 属性
  - コンテンツ URI に使用する URI オーソリティ (コンテンツプロバイダ名) を指定します。
  - この例のオーソリティは com.example.myapp.fileprovider です。
  - 実際のアプリでは、アプリのパッケージ名 ( [android:package](https://developer.android.com/guide/topics/manifest/manifest-element?hl=ja#package) ) の末尾に「 fileprovider 」という文字列を付与するのが一般的です。
  - オーソリティについて詳しくは、 [コンテンツ URI](../12.コンテンツプロバイダ/2.コンテンツプロバイダの基本.md/#コンテンツ-uri) に関するトピックと、 [android:authorities](https://developer.android.com/guide/topics/manifest/provider-element?hl=ja#auth) 属性のドキュメントをご覧ください。

- [`<provider>`](https://developer.android.com/guide/topics/manifest/provider-element?hl=ja) の [`<meta-data>`](https://developer.android.com/guide/topics/manifest/meta-data-element?hl=ja) 子要素
  - `<meta-data>` は、キー＆バリュー形式でデータを保持するものです。
    - `android:name` がキーです。
    - `androdi:value` or `android:resource` がバリューです。
  - `<meta-data>` には、共有するディレクトリを記載した XML ファイルを指定します。
  - `android:resource` 属性は、ファイルのパスと名前です（ .xml 拡張子を除く）。
  - この xml ファイルの中身については、次のセクションで説明します。


## 共有可能なディレクトリを指定する

[FileProvider](https://developer.android.com/reference/androidx/core/content/FileProvider?hl=ja) をアプリマニフェストに追加したら、共有するディレクトリを指定する必要があります。ディレクトリを指定するには、まず、プロジェクトの res/xml/ サブディレクトリに filepaths.xml ファイルを作成します。このファイル内で、共有するディレクトリを指定します。次のスニペットは、 res/xml/filepaths.xml の内容の例を示しています。また、内部ストレージ領域の files/ ディレクトリのサブディレクトリを共有する方法も示しています。

```xml
<paths>
    <files-path path="images/" name="myimages" />
</paths>
```

- `<files-path>` タグ
  - アプリの固有ストレージである `files/` ディレクトリを示します。
- `path` 属性
  - `images/` サブディレクトリを示します。
  - つまり、この例では、 `files/images/` ディレクトリを共有ディレクトリとして指定します。
- `name` 属性
  - 共有ディレクトリへの別名を指定します。
  - この例では、 `files/images/` ディレクトリにコンテンツ URI でアクセスする際は、 `myimages` というパス (テーブル名) でアクセスします。

- `<paths>` 要素
  - 複数の子を指定して、それぞれ異なる共有ディレクトリを指定できます。
    - `<external-path>` 要素
      - 外部ストレージでディレクトリを共有できます。
    - `<cache-path>` 要素
      - 内部キャッシュディレクトリでディレクトリを共有できます。
    - その他の要素について詳しくは、 [FileProvider](https://developer.android.com/reference/androidx/core/content/FileProvider?hl=ja) リファレンスドキュメントをご覧ください。

**注** : 共有ディレクトリを指定するには、必ず XML ファイルを使用します。プログラムでディレクトリを追加することはできません。

これで、アプリの内部ストレージの files/ ディレクトリにあるファイル、または files/ のサブディレクトリにあるファイルに対して、コンテンツ URI を生成する FileProvider の完全な仕様を利用できるようになりました。アプリがファイルのコンテンツ URI を生成するときに、 `<provider>` 要素で指定されたオーソリティ（ com.example.myapp.fileprovider ）、パス ( myimages/ ) 、ファイル名が含まれます。


## コンテンツ URI の例

たとえば、このレッスンのスニペットに従って FileProvider を定義し、ファイル default_image.jpg のコンテンツ URI をリクエストすると、FileProvider によって次の URI が返されます。

```
content://com.example.myapp.fileprovider/myimages/default_image.jpg
```

その他の関連情報については、以下をご覧ください。

- [ストレージオプション](https://developer.android.com/guide/topics/data/data-storage?hl=ja)


## 引用元資料

- [ファイル共有の設定](https://developer.android.com/training/secure-file-sharing/setup-sharing?hl=ja)

