- [他のアプリからシンプルなデータを受信する](#他のアプリからシンプルなデータを受信する)
  - [MIME タイプのサポート](#mime-タイプのサポート)
  - [優れた共有ターゲットを作成する](#優れた共有ターゲットを作成する)
  - [アクティビティでデータを受信する](#アクティビティでデータを受信する)
    - [マニフェストを更新する](#マニフェストを更新する)
    - [受信コンテンツの処理](#受信コンテンツの処理)
    - [ユーザーがアプリを認識できるようにする](#ユーザーがアプリを認識できるようにする)
  - [引用元資料](#引用元資料)


# 他のアプリからシンプルなデータを受信する

アプリが他のアプリにデータを送信できるのと同様に、他のアプリからデータを受信することもできます。ユーザーがアプリとどのようにやり取りするか、他のアプリからどのようなデータタイプを受信したいかを考えてください。たとえば、ソーシャルネットワーキングアプリケーションは、別のアプリから興味深い Web URL などのテキストコンテンツを受信することに興味があるかもしれません。

他のアプリのユーザーは、 Android Sharesheet 、または、インテントリゾルバを介してアプリにデータを頻繁に送信します。アプリにデータを送信するアプリは、そのデータの MIME タイプを設定する必要があります。アプリは、次の方法で別のアプリから送信されたデータを受信できます。

- マニフェストの `<activity>` に、一致するインテントフィルタタグがある場合
- アプリによって公開された共有ショートカット

ダイレクトシェアターゲットは、アプリ内の特定のアクティビティへのディープリンクです。多くの場合、これらは人物、または、グループを表し、 Android Sharesheet に表示されます。たとえば、メッセージングアプリは、その人との会話に直接ディープリンクする人物のダイレクトシェアターゲットを提供できます。詳細な手順については、 [ダイレクトシェアターゲットを提供する](./4.ダイレクト共有ターゲットを提供する.md) を参照してください。


## MIME タイプのサポート

理想的には、アプリは可能な限り幅広い MIME タイプを受信できる必要があります。たとえば、テキスト、画像、ビデオの送信用に設計されたメッセージングアプリは、 `text/*` 、 `image/*` 、 `video/*` の受信をサポートするのが理想的です。 Android で単純なデータを送受信するための一般的な MIME タイプをいくつか示します。

| 受信側                           | 送信側          |
| -------------------------------- | --------------- |
| text/*                           | text/plain      |
| 〃                               | text/rtf        |
| 〃                               | text/html       |
| 〃                               | text/json       |
| image/*                          | image/jpg       |
| 〃                               | image/png       |
| 〃                               | image/gif       |
| video/*                          | video/mp4       |
| 〃                               | video/3gp       |
| サポートされているファイル拡張子 | application/pdf |

MIME タイプの詳細については、 MIME メディアタイプの [IANA](https://www.iana.org/assignments/media-types/media-types.xhtml) 公式レジストリを参照してください。

**注意** : 受信側のアプリで MIME タイプに `*/*` を指定することは可能ですが、アプリがあらゆる種類の受信コンテンツを完全に処理できる場合を除き、これを行わないことを強くお勧めします。


## 優れた共有ターゲットを作成する

ユーザーが特定のアクティビティに関連付けられた共有ターゲットをタップすると、共有先のアプリは、共有コンテンツを使用する前に、共有コンテンツを確認して編集できる必要があります。これは、テキストデータの場合に特に重要です。

例えば、 Web サイト上の 「共有する」 ボタンをタップして、 SNS で、その URL に関する投稿を行いたいとします。その際、 SNS では、投稿する前に、 URL を確認したり、投稿する際に自分のコメントを記述できる必要があるでしょう。


## アクティビティでデータを受信する

アクティビティでデータを受信するには、マニフェストを更新し、受信するコンテンツを処理して、ユーザーがアプリを認識できるようにする必要があります。


### マニフェストを更新する

インテントフィルターは、アプリコンポーネントが受け入れるインテントをシステムに通知します。 [他のアプリへのシンプルなデータの送信](./2.他のアプリへのシンプルなデータの送信.md) レッスンで ACTION_SEND アクションを使用してインテントを作成したのと同様に、このアクションを使用してインテントを受信するためのインテントフィルターを作成します。マニフェストでインテントフィルターを定義するには、 `<intent-filter>` 要素を使用します。たとえば、アプリがテキストコンテンツの受信を処理する場合、任意のタイプの 1 つ以上の画像を含むマニフェストは次のスニペットのようになります。

```xml
<activity android:name=".ui.MyActivity" >
    <!-- 一つの画像を受信するインテントフィルター -->
    <intent-filter>
        <action android:name="android.intent.action.SEND" />
        <!-- カテゴリーは必須となっているため、 -->
        <!-- 送信側でカテゴリーが何も設定されていない場合は、 -->
        <!-- 受信側では DEFAULT を設定する。 -->
        <category android:name="android.intent.category.DEFAULT" />
        <data android:mimeType="image/*" />
    </intent-filter>
    <!-- 文字列を受信するインテントフィルター -->
    <intent-filter>
        <action android:name="android.intent.action.SEND" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:mimeType="text/plain" />
    </intent-filter>
    <!-- 複数の画像を受信するインテントフィルター -->
    <intent-filter>
        <action android:name="android.intent.action.SEND_MULTIPLE" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:mimeType="image/*" />
    </intent-filter>
</activity>
```

別のアプリがインテントを作成し、それを [startActivity()](https://developer.android.com/reference/android/content/Context#startActivity(android.content.Intent)) に渡すことで、これらのいずれかを共有しようとすると、あなたのアプリは Android Sharesheet 、または、インテントリゾルバのターゲットとして表示されます。ユーザーがあなたのアプリを選択すると、対応するアクティビティ (前の例では .ui.MyActivity) が開始されます。その後、コードと UI 内でコンテンツを適切に処理するのはあなたの責任です。

**注** : インテントフィルタとインテント解決の詳細については、 [インテントとインテントフィルタ](https://developer.android.com/guide/components/intents-filters#ifs) を参照してください。


### 受信コンテンツの処理

[Intent](https://developer.android.com/reference/android/content/Intent) によって配信されるコンテンツを処理するには、 [getIntent()](https://developer.android.com/reference/android/content/Intent#getIntent(java.lang.String)) を呼び出してインテントオブジェクトを取得します。オブジェクトを取得したら、その内容を調べて、次に何をするかを決定できます。このアクティビティをシステムの他の部分 (ランチャーなど) から開始できる場合は、インテントを調べるときにこれを考慮してください。

受信データは、特に注意深く確認してください。他のアプリケーションから何が送信されるかはわかりません。たとえば、間違った MIME タイプが設定されていたり、送信される画像が非常に大きい場合があります。また、バイナリデータはメインスレッドではなく、別のスレッドで処理することを忘れないでください。

```kotlin
override fun onCreate(savedInstanceState: Bundle?) {
    ...
    when {
        intent?.action == Intent.ACTION_SEND -> {
            if ("text/plain" == intent.type) {
                handleSendText(intent)
            } else if (intent.type?.startsWith("image/") == true) {
                handleSendImage(intent)
            }
        }
        intent?.action == Intent.ACTION_SEND_MULTIPLE
                && intent.type?.startsWith("image/") == true -> {
                handleSendMultipleImages(intent)
        }
        else -> {
            // Handle other intents, such as being started from the home screen
            // 他の Intent を処理します。例えば、ホームからアプリアイコンをタップして起動された場合など。
        }
    }
    ...
}

private fun handleSendText(intent: Intent) {
    intent.getStringExtra(Intent.EXTRA_TEXT)?.let {
        // 受信したテキストを画面に反映するなど。
    }
}

private fun handleSendImage(intent: Intent) {
    (intent.getParcelableExtra<Parcelable>(Intent.EXTRA_STREAM) as? Uri)?.let {
        // 受信した画像を画面に反映するなど。
    }
}

private fun handleSendMultipleImages(intent: Intent) {
    intent.getParcelableArrayListExtra<Parcelable>(Intent.EXTRA_STREAM)?.let {
        // 受信した画像を画面に反映するなど。
    }
}
```

データを受信した後の UI の更新は、 EditText を入力するだけの簡単なものから、画像に興味深い写真フィルターを適用するような複雑なものまでさまざまです。次に何が起こるかはアプリ次第です。


### ユーザーがアプリを認識できるようにする

あなたのアプリは、 Android Sharesheet とインテントリゾルバーのターゲット選択 UI 内で、マニフェストで定義されたアイコン ( [`<application android:icon>`](https://developer.android.com/guide/topics/manifest/application-element#icon) ) とラベル ( [`<application android:label>`](https://developer.android.com/guide/topics/manifest/application-element#label) ) で表示されます。アクティビティフィルター、または、インテントフィルターのラベルを設定して、より多くのコンテキストを提供できます。

Android 10 未満では、 `<activity>` タグ内の `android:label` 属性や `android:icon` 属性で、 Sharesheet やインテントリゾルバーのターゲット選択 UI に表示されるラベルやアイコンをカスタマイズできていました。しかし、 Android 10 (API レベル 29) 以降は、それができなくなり、 `<application>` タグのラベルとアイコンのみが使用されるようになりました。

**注** : 共有時に何が起こるかをユーザーが理解するには、受信側アプリの名前とアイコンだけで十分です。


## 引用元資料

- [他のアプリからシンプルなデータを受信する](https://developer.android.com/training/sharing/receive?hl=ja)


