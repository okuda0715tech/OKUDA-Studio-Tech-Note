- [循環型ナビゲーション](#循環型ナビゲーション)
  - [シナリオ](#シナリオ)
  - [解決策](#解決策)
    - [Compose の実装](#compose-の実装)
    - [Android View の実装](#android-view-の実装)
  - [引用元資料](#引用元資料)


# 循環型ナビゲーション

デスティネーションにポップバックする必要がある例としてわかりやすいのは、ナビゲーションが循環型の場合です。このドキュメントでは、そのようなユースケースの概要を示します。


## シナリオ

アプリに A、B、C の 3 つのデスティネーションがあるとします。また、A から B、B から C、C から A に移動するアクションもあります。対応するナビゲーション グラフは次のようになります。

<img src="./画像/3 つのデスティネーション（A、B、C）がある循環型ナビゲーションのグラフ.png" width="600">

NavController は、 **ナビゲーション アクションごとに新しいデスティネーションをバックスタックに追加します。** そのため、図のフローで移動を繰り返すと、バックスタックに各デスティネーションの複数のセット（A、B、C、A、B、C、A、B、C）が含まれることになります。


## 解決策

バックスタックでの繰り返しを回避するには、NavController.navigate() の呼び出し、または、ナビゲーション アクションで、 [popUpTo()](https://developer.android.com/guide/navigation/backstack?hl=ja&_gl=1*sw6h2*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczNDA1NDAxOC41LjAuMTczNDA1NDAxOC4wLjAuMjA4MDY4NTc5#pop) と [inclusive](https://developer.android.com/guide/navigation/backstack?hl=ja&_gl=1*sw6h2*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczNDA1NDAxOC41LjAuMTczNDA1NDAxOC4wLjAuMjA4MDY4NTc5#pop-back-destination) を指定します。

デスティネーション C に到達した後、バックスタックに各デスティネーション（A、B、C）のインスタンスが 1 つ含まれているとします。ユーザーをデスティネーション C からデスティネーション A に移動させるアクション、または、 navigate() の呼び出しで、 popUpTo() と inclusive を指定するようにします。

この場合、ユーザーがデスティネーション C からデスティネーション A に戻ると、 NavController も A にポップアップされます。つまり、スタックから B と C が削除されます。また、 `inclusive = true` の場合、最初の A がポップされ、実質的にスタックがクリアされます。

注: これは、 [popBackStack() を呼び出して inclusive を渡す](./1.概要.md/#特定のデスティネーションにポップバックする) ( [引用元はこちら](https://developer.android.com/guide/navigation/backstack?hl=ja&_gl=1*raacfp*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczNDA1NDAxOC41LjAuMTczNDA1NDAxOC4wLjAuMjA4MDY4NTc5#pop-back-destination) ) 場合と同様です。


### Compose の実装

循環型の popUpTo() を Compose で解決する場合の実装は、次のとおりです。型安全なルートの実装例は、 [Compose の例](1.概要.md/#compose-の例) を参照してください。

```kotlin
// NavHost の中で NavGraph を生成する場合
composable("c") {
    DestinationC(
        onNavigateToA = {
            navController.navigate("a") {
                popUpTo("a") {
                    // a もクリアする場合は true を指定する。
                    inclusive = true
                }
            }
        },
    )
}
```


### Android View の実装

循環型の popUpTo をビューで解決する場合の実装は、次のとおりです。

```xml
<fragment
    android:id="@+id/c"
    android:name="com.example.myapplication.C"
    android:label="fragment_c"
    tools:layout="@layout/fragment_c">

    <action
        android:id="@+id/action_c_to_a"
        app:destination="@id/a"
        app:popUpTo="@+id/a"
        app:popUpToInclusive="true"/>

</fragment>
```


## 引用元資料

- [循環型ナビゲーション](https://developer.android.com/guide/navigation/backstack/circular?hl=ja&_gl=1*1f8zf5p*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczMzk2ODExNi40LjAuMTczMzk2ODExNi4wLjAuNzA3MDg4ODI5)


