- [前提知識](#前提知識)
  - [複数のバックスタックとは](#複数のバックスタックとは)
  - [何の状態が保存されるのか](#何の状態が保存されるのか)
  - [複数のデスティネーションを一度にポップした場合](#複数のデスティネーションを一度にポップした場合)
- [複数のバックスタックをサポートする](#複数のバックスタックをサポートする)
  - [NavigationUI を使用してサポートを自動的に実装する](#navigationui-を使用してサポートを自動的に実装する)
  - [基盤となる API を使用してサポートを手動で実装する](#基盤となる-api-を使用してサポートを手動で実装する)
    - [Navigation XML](#navigation-xml)
    - [NavOptions](#navoptions)


# 前提知識

## 複数のバックスタックとは

複数のバックスタックとは、実際にバックスタックが複数存在しているわけではありません。

アプリ内に、バックスタックは一つだけ存在しており、そのバックスタックからポップされたデスティネーションの状態を保存したり、復元することで、あたかもポップされたデスティネーションが、別のバックスタックに退避されたかのように見えるだけです。


## 何の状態が保存されるのか

複数のバックスタックによって、 Jetpack Compose の State が保存・復元されます。

ただし、 remember{} ラムダラップした State は保存・復元されません。 rememberSaveable{} ラムダでラップした State のみが保存・復元の対象となります。


## 複数のデスティネーションを一度にポップした場合

ChatGPT や Gemini によると、複数のデスティネーションを一度にポップした場合、最後にポップされたデスティネーションの状態のみが保存・復元の対象になるそうです。ただし、それだと開発者やユーザーの意図している状態の保存と復元とは異なると思うので、実際には、複数のデスティネーションを同時にポップした際には、それら全てのデスティネーションが保存・復元されるのではないかと思っています。


# 複数のバックスタックをサポートする

Navigation コンポーネントは、Android オペレーティング システムと連携し、ユーザーのアプリ内での移動に応じてバックスタックを保持します。複数のバックスタックを同時に保持することにより、ユーザーがバックスタック間を行き来できて、便利になる場合があります。たとえば、ボトム ナビゲーション、または、ナビゲーション ドロワーを使用するアプリの場合、複数のバックスタックをサポートすることで、ユーザーはアプリ内の複数のフローを、それぞれの中での場所を維持したまま、自由に切り替えられるようになります。

Navigation コンポーネントには、複数のバックスタックをサポートする API が用意されています。これらの API は、ナビゲーション グラフを使用して、デスティネーションの状態を保存、復元する仕組みになっています。 [NavigationUI](https://developer.android.com/reference/androidx/navigation/ui/NavigationUI?hl=ja&_gl=1*1z9y8h*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczNDA1NDAxOC41LjAuMTczNDA1NDAxOC4wLjAuMjA4MDY4NTc5) クラスには、これを自動的に処理するメソッドが含まれています。また、その基盤となる API を手動で利用すれば、よりカスタマイズした実装を行うこともできます。

注: Navigation コンポーネントが複数のバックスタックをサポートするのは、バージョン 2.4.0 以降のみです。


## NavigationUI を使用してサポートを自動的に実装する

[NavigationUI](https://developer.android.com/reference/androidx/navigation/ui/NavigationUI?hl=ja&_gl=1*gu1cwz*_up*MQ..*_ga*OTU4MTMxOTg2LjE3MjM3MTM4MTM.*_ga_6HH9YJMN9M*MTcyMzcyNjM2NC4yLjAuMTcyMzcyNjM2NC4wLjAuMA..) クラスには、ユーザーのメニュー項目間の移動に応じて、メニュー項目の状態の保存と復元を自動的に行う API が含まれています。これらの API は、次の場合に複数のバックスタックのサポートをデフォルトで実装します。

- [ナビゲーションドロワーを追加する](https://developer.android.com/guide/navigation/navigation-ui?hl=ja&_gl=1*gu1cwz*_up*MQ..*_ga*OTU4MTMxOTg2LjE3MjM3MTM4MTM.*_ga_6HH9YJMN9M*MTcyMzcyNjM2NC4yLjAuMTcyMzcyNjM2NC4wLjAuMA..#add_a_navigation_drawer) 、または、 [ボトムナビゲーション](https://developer.android.com/guide/navigation/navigation-ui?hl=ja&_gl=1*ek33hk*_up*MQ..*_ga*OTU4MTMxOTg2LjE3MjM3MTM4MTM.*_ga_6HH9YJMN9M*MTcyMzcyNjM2NC4yLjAuMTcyMzcyNjM2NC4wLjAuMA..#bottom_navigation) で説明されているとおり、 [setupWithNavController()](https://developer.android.com/reference/androidx/navigation/ui/NavigationUI?hl=ja&_gl=1*ek33hk*_up*MQ..*_ga*OTU4MTMxOTg2LjE3MjM3MTM4MTM.*_ga_6HH9YJMN9M*MTcyMzcyNjM2NC4yLjAuMTcyMzcyNjM2NC4wLjAuMA..#setupWithNavController(com.google.android.material.navigation.NavigationView,androidx.navigation.NavController)) の適切なオーバーロードを使用して、NavigationView または BottomNavigationView のインスタンスを NavController インスタンスに関連付ける場合。

- [onNavDestinationSelected()](https://developer.android.com/reference/androidx/navigation/ui/NavigationUI?hl=ja&_gl=1*ek33hk*_up*MQ..*_ga*OTU4MTMxOTg2LjE3MjM3MTM4MTM.*_ga_6HH9YJMN9M*MTcyMzcyNjM2NC4yLjAuMTcyMzcyNjM2NC4wLjAuMA..#onNavDestinationSelected(android.view.MenuItem,androidx.navigation.NavController)) を使用して、NavController インスタンスがホストするデスティネーションに結び付けられた [カスタムナビゲーションメニュー UI](https://developer.android.com/guide/navigation/navigation-ui?hl=ja&_gl=1*k5ty69*_up*MQ..*_ga*OTU4MTMxOTg2LjE3MjM3MTM4MTM.*_ga_6HH9YJMN9M*MTcyMzcyNjM2NC4yLjAuMTcyMzcyNjM2NC4wLjAuMA..#Tie-navdrawer) を作成する場合。

これらの API を使用すれば、それ以上のコード変更をせずに、複数のバックスタックのサポートを実装できます。アプリで複数のバックスタックをサポートする場合に推奨される方法です。


## 基盤となる API を使用してサポートを手動で実装する

NavigationUI の要素では、要件を満たせない場合、 Navigation コンポーネントが提供する別の API サーフェスから、基盤となる API を使用してバックスタックの保存、復元を行えます。


### Navigation XML

Navigation XML 内で、ナビゲーション グラフの <action> 要素に app:popUpToSaveState 属性を設定して、アクションが app:popUpTo でポップしたデスティネーションの状態を保存するよう指定できます。また、 app:restoreState 属性を設定することで、 app:destination 属性で定義したデスティネーションについて、保存されている状態を復元するよう指定できます。

これらの属性を使用して、複数のバックスタックをサポートできます。ナビゲーション アクションが、ユーザーをあるバックスタックから、別のバックスタックに移動する必要がある場合は、対応する `<action>` 要素で app:popUpToSaveState と app:restoreState の両方を true に設定します。そうすることで、このアクションは現在のバックスタックの状態を保存すると同時に、以前に保存したデスティネーションのバックスタックの状態も復元します（存在する場合）。

両方の属性を使用するアクションの例を次に示します。

```xml
<action
  android:id=”@+id/swap_stack”
  app:destination=”@id/second_stack”
  app:restoreState=”true”
  app:popUpTo=”@id/first_stack_start_destination”
  app:popUpToSaveState=”true” />
```


### NavOptions

[NavOptions](https://developer.android.com/reference/kotlin/androidx/navigation/NavOptions?hl=ja&_gl=1*15wrnnf*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczNDA1NDAxOC41LjAuMTczNDA1NDAxOC4wLjAuMjA4MDY4NTc5) クラスを使用すると、 NavController を使用した移動の際に、特別なナビゲーション オプションを渡してバックスタックの保存、復元を行えます。これは、 NavOptions インスタンスの作成に Kotlin DSL を使用する場合、 [NavOptions.Builder](https://developer.android.com/reference/kotlin/androidx/navigation/NavOptions.Builder?hl=ja&_gl=1*15wrnnf*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczNDA1NDAxOC41LjAuMTczNDA1NDAxOC4wLjAuMjA4MDY4NTc5) を使用する場合のどちらにも当てはまります。

```kotlin
// navOptions DSL ビルダーを引数にとる navigate() 関数を使用します。
navController.navigate(selectedBottomNavRoute) {
    // このラムダが navOptions DSL ビルダーです。

    launchSingleTop = true
    restoreState = true
    popUpTo(navController.graph.findStartDestination().id) {
        saveState = true
    }
}
```

より詳しい説明は、 [ポップアップ時に状態を保存する](./1.概要.md/#ポップアップ時に状態を保存する) [引用元はこちら](https://developer.android.com/guide/navigation/backstack?hl=ja&_gl=1*1mdqj7f*_up*MQ..*_ga*MTg4MzU5OTUxMy4xNzM0MDU3NTQ0*_ga_6HH9YJMN9M*MTczNDA1NzU0NC4xLjAuMTczNDA1NzU0NC4wLjAuMzU3NDk4NDc.#pop) をご覧ください。


