- [ViewModel スコープ用 API](#viewmodel-スコープ用-api)
  - [最も近い ViewModelStoreOwner をスコープとする ViewModel](#最も近い-viewmodelstoreowner-をスコープとする-viewmodel)
  - [任意の ViewModelStoreOwner をスコープとする ViewModel](#任意の-viewmodelstoreowner-をスコープとする-viewmodel)
    - [親 Fragment をスコープとする ViewModel](#親-fragment-をスコープとする-viewmodel)
    - [Activity をスコープとする ViewModel](#activity-をスコープとする-viewmodel)
  - [ナビゲーショングラフをスコープとする ViewModel](#ナビゲーショングラフをスコープとする-viewmodel)
  - [引用元資料](#引用元資料)


# ViewModel スコープ用 API

スコープは、ViewModel を効果的に使用するうえで重要です。各 ViewModel は、ViewModelStoreOwner インターフェースを実装するオブジェクトをスコープとしています。ViewModel のスコープを簡単に管理できる API がいくつかあります。このドキュメントでは、知っておくべき主要な手法について説明します。

ViewModelProvider.get() メソッドを使用すると、任意の ViewModelStoreOwner をスコープとする ViewModel のインスタンスを取得できます。Kotlin ユーザーには、最も一般的なユースケースで使用できるさまざまな拡張関数があります。すべての Kotlin 拡張関数の実装では、内部で ViewModelProvider API が使用されます。


## 最も近い ViewModelStoreOwner をスコープとする ViewModel

ViewModel をアクティビティ、フラグメント、またはナビゲーショングラフのデスティネーションにスコープ設定できます。アクティビティ、フラグメント、Navigation ライブラリによって提供される viewModels() 拡張関数と、Compose の viewModel() 関数を使用すると、最も近い ViewModelStoreOwner をスコープとする ViewModel のインスタンスを取得できます。

```kotlin
// Android View の例

import androidx.activity.viewModels

class MyActivity : AppCompatActivity() {
    // ViewModel API は activity.activity-ktx に存在します。
    // この ViewModel は、 MyActivity にスコープされます。
    val viewModel: MyViewModel by viewModels()
}

import androidx.fragment.app.viewModels

class MyFragment : Fragment() {
    // ViewModel API は fragment.fragment-ktx に存在します。
    // この ViewModel は、 MyFragment にスコープされます。
    val viewModel: MyViewModel by viewModels()
}
```

```kotlin
// Compose の例

import androidx.lifecycle.viewmodel.compose.viewModel

@Composable
fun MyScreen(
    modifier: Modifier = Modifier,
    // ViewModel API は lifecycle.lifecycle-viewmodel-compose に存在します。
    // ViewModel は、 LocalViewModelStoreOwner の CompositionLocal によって提供される一番近くの ViewModelStoreOwner にスコープされます。
    // 近い順に、ナビゲーショングラフの宛先、ホストフラグメント、ホストアクティビティになります。
    viewModel: MyViewModel = viewModel()
) { /* ... */ }
```

注: Hilt と Jetpack Compose を使用している場合は、 [Compose + Hilt のドキュメント](https://developer.android.com/develop/ui/compose/libraries?hl=ja&_gl=1*1nrgb63*_up*MQ..*_ga*MTE3NjE0ODY1NC4xNzIxOTcyNjA1*_ga_6HH9YJMN9M*MTcyMTk3MjYwNC4xLjAuMTcyMTk3MjYwNC4wLjAuMA..#hilt) で説明されているように ViewModel クラスに @hiltViewModel() アノテーションを付与します。

別の画面に遷移した際に、それまで表示されていたアクティビティやフラグメントやナビゲーションデスティネーションは、バックスタックに積まれます。バックスタックに積まれたそれらがメモリ不足によって破棄された場合は、そのスコープに紐づけられた ViewModel も破棄されます。ただし、 SavedStateHandle 等を使用して、状態を保存することが可能です。


## 任意の ViewModelStoreOwner をスコープとする ViewModel

View システムの ComponentActivity.viewModels() 関数と Fragment.viewModels() 関数、Compose の viewModel() 関数は、ViewModel のインスタンスがどの ViewModelStoreOwner にスコープ設定されるかを指定するオプションの ownerProducer パラメータを取ります。


### 親 Fragment をスコープとする ViewModel

次のサンプルは、親フラグメント (※ 1 ) をスコープとする ViewModel のインスタンスを取得する方法を示しています。

(※ 1 ) this で取得できる直近のフラグメントではなく、その親フラグメントのことです。 DialogFragment から親のフラグメントを取得する場合などです。

```kotlin
// Android View の例

import androidx.fragment.app.viewModels

class MyFragment : Fragment() {

    // ViewModel API は fragment.fragment-ktx に存在します。
    // MyFragment の親 Fragment にスコープ化されます。
    val viewModel: SharedViewModel by viewModels(
        ownerProducer = { requireParentFragment() }
    )
}
```

```kotlin
// Compose の例

import androidx.lifecycle.viewmodel.compose.viewModel

@Composable
fun MyScreen(
    context: Context = LocalContext.current,

    // ViewModel API は lifecycle.lifecycle-viewmodel-compose に存在します。
    // この Composable 関数を呼び出した Fragment の親 Fragment にスコープ化されます。
    viewModel: SharedViewModel = viewModel(
        viewModelStoreOwner = (context as Fragment).requireParentFragment()
    )
) { /* ... */ }
```


### Activity をスコープとする ViewModel

フラグメントからアクティビティをスコープとする ViewModel を取得することは、一般的なユースケースです。これを行う場合は、 `activityViewModels()` という Android View システムの拡張関数を使用します。 Jetpack Compose を使用する場合は、前述した方法 ( ownerProducer を渡す方法) で、適切なオーナーを渡します。

```kotlin
// Android View の例

import androidx.fragment.app.activityViewModels

class MyFragment : Fragment() {

    val viewModel: SharedViewModel by activityViewModels()
}
```

```kotlin
// Compose の例

import androidx.lifecycle.viewmodel.compose.viewModel

@Composable
fun MyScreen(
    context: Context = LocalContext.current,
    viewModel: SharedViewModel = viewModel(
        viewModelStoreOwner = (context as Fragment).requireActivity()
    )
) { /* ... */ }
```

注: Hilt と Jetpack Compose を使用している場合は、 [Compose + Hilt のドキュメント](https://developer.android.com/develop/ui/compose/libraries?hl=ja&_gl=1*1nrgb63*_up*MQ..*_ga*MTE3NjE0ODY1NC4xNzIxOTcyNjA1*_ga_6HH9YJMN9M*MTcyMTk3MjYwNC4xLjAuMTcyMTk3MjYwNC4wLjAuMA..#hilt) で説明されているように ViewModel クラスに @hiltViewModel() アノテーションを付与します。


## ナビゲーショングラフをスコープとする ViewModel

ナビゲーショングラフも ViewModel のストアオーナーです。 Navigation Fragment または Navigation Compose を使用している場合は、 navGraphViewModels(graphId) View 拡張関数を使用してナビゲーショングラフをスコープとする ViewModel のインスタンスを取得できます。

```kotlin
// Android View の例

import androidx.navigation.navGraphViewModels

class MyFragment : Fragment() {

    // ViewModel API は navigation.navigation-fragment 内にあります。
    // ViewModel は `nav_graph` ナビゲーショングラフにスコープされます。
    val viewModel: SharedViewModel by navGraphViewModels(R.id.nav_graph)

    // navGraphViewModels を使用しなくても、 viewModels 関数でも
    // 上記と同じことが実現できます。
    val viewModel: SharedViewModel by viewModels(
        { findNavController().getBackStackEntry(R.id.nav_graph) }
    )
}
```

```kotlin
// Compose の例

import androidx.lifecycle.viewmodel.compose.viewModel

@Composable
fun MyAppNavHost() {
    // ...
    composable("myScreen") { backStackEntry ->

        // "parentNavigationRoute" の NavBackStackEntry を取得する。
        val parentEntry = remember(backStackEntry) {
            navController.getBackStackEntry("parentNavigationRoute")
        }

        // 'parentNavigationRoute' ナビゲーショングラフに
        // スコープされた ViewModel を取得する。
        val parentViewModel: SharedViewModel = viewModel(parentEntry)
        // ...
    }
}
```

Jetpack Navigation に加えて Hilt を使用している場合は、次のように hiltNavGraphViewModels(graphId) API を使用できます。

```kotlin
// Android View の例

import androidx.hilt.navigation.fragment.hiltNavGraphViewModels

class MyFragment : Fragment() {

    // ViewModel API は hilt.hilt-navigation-fragment 内にあります。
    // ViewModel は 'nav_graph' ナビゲーショングラフにスコープされ、
    // Hilt によって生成された ViewModel ファクトリを使用して提供されます。
    val viewModel: SharedViewModel by hiltNavGraphViewModels(R.id.nav_graph)
}
```


```kotlin
// Compose の例

import androidx.hilt.navigation.compose.hiltViewModel

@Composable
fun MyAppNavHost() {
    // ...
    composable("myScreen") { backStackEntry ->
        val parentEntry = remember(backStackEntry) {
            navController.getBackStackEntry("parentNavigationRoute")
        }

        // ViewModel API は hilt.hilt-navigation-compose 内にあります。
        // ViewModel は、 'parentNavigationRoute' ナビゲーショングラフにスコープされ、
        // Hilt によって生成された ViewModel ファクトリを使用して提供されます。
        val parentViewModel: SharedViewModel = hiltViewModel(parentEntry)
        // ...
    }
}
```


## 引用元資料

- [ViewModel スコープ用 API](https://developer.android.com/topic/libraries/architecture/viewmodel/viewmodel-apis?hl=ja)


