- [依存関係を使用して ViewModel を作成する](#依存関係を使用して-viewmodel-を作成する)
  - [CreationExtras の ViewModel](#creationextras-の-viewmodel)
  - [2.5.0 より前のバージョンの ViewModel のファクトリ](#250-より前のバージョンの-viewmodel-のファクトリ)


# 依存関係を使用して ViewModel を作成する

依存関係注入のベストプラクティスに基づいて、 ViewModel はコンストラクタのパラメータを使用して依存関係を注入できます。ほとんどの場合、これらはドメインレイヤまたはデータレイヤのオブジェクトです。フレームワークは ViewModel を提供しているため、ViewModel のインスタンスを作成するには特別なメカニズムが必要です。そのメカニズムとは、 `ViewModelProvider.Factory` インターフェースです。 **このインターフェースの実装のみが、適切なスコープで ViewModel をインスタンス化することができます。**

以下のいずれかの場合は、 ViewModel のインスタンスを生成する際に、フレームワークのファクトリを提供する必要はありません。

- ViewModel が依存関係を取得しない場合
- 依存関係として SavedStateHandle タイプのみを取得する場合

注: 依存関係注入のソリューションとして Hilt を使用して ViewModel を注入する場合は、 **ViewModel のファクトリを手動で定義する必要はありません。** Hilt はファクトリを生成しますが、このファクトリは、コンパイル時に @HiltViewModel アノテーションが付いたすべての ViewModel を作成する方法を認識します。通常の ViewModel API を呼び出したとき、 @AndroidEntryPoint アノテーションが付いたクラスは Hilt によって生成されたファクトリに直接アクセスできます。


## CreationExtras の ViewModel

ViewModel クラスがコンストラクタ内で依存関係を受け取る場合は、ViewModelProvider.Factory インターフェースを実装するファクトリを提供してください。create(Class<T>, CreationExtras) 関数をオーバーライドして、ViewModel のインスタンスを生成する方法を定義できます。

CreationExtras を使用すると、ViewModel のインスタンス化に役立つ関連情報にアクセスできます。エクストラ内の各要素には、キーを使用してアクセスします。キーとそのキーで取得できる内容は次のとおりです。

- ViewModelProvider.NewInstanceFactory.VIEW_MODEL_KEY
  - ViewModelProvider.get() に渡したカスタムキー
- ViewModelProvider.AndroidViewModelFactory.APPLICATION_KEY	
  - Application クラスのインスタンス
- SavedStateHandleSupport.DEFAULT_ARGS_KEY
  - SavedStateHandle の作成に使用する引数のバンドル
- SavedStateHandleSupport.SAVED_STATE_REGISTRY_OWNER_KEY
  - ViewModel の作成に使用されている SavedStateRegistryOwner
- SavedStateHandleSupport.VIEW_MODEL_STORE_OWNER_KEY
  - ViewModel の作成に使用されている ViewModelStoreOwner

SavedStateHandle の新しいインスタンスを作成するには、 [CreationExtras.createSavedStateHandle()](https://developer.android.com/reference/androidx/lifecycle/SavedStateHandleSupport?_gl=1*7qazkw*_up*MQ..*_ga*MTE3NjE0ODY1NC4xNzIxOTcyNjA1*_ga_6HH9YJMN9M*MTcyMTk3MjYwNC4xLjAuMTcyMTk3MjYwNC4wLjAuMA..#(androidx.lifecycle.viewmodel.CreationExtras).createSavedStateHandle()) 関数を使用して ViewModel に渡します。

次の例は、Application クラスをスコープとするリポジトリと SavedStateHandle を依存関係として取得する ViewModel のインスタンスを提供する方法を示しています。

```kotlin
import androidx.lifecycle.SavedStateHandle
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.ViewModelProvider.ndroidViewModelFactory.Companion.APPLICATION_KEY
import androidx.lifecycle.createSavedStateHandle
import androidx.lifecycle.viewmodel.CreationExtras

class MyViewModel(
    private val myRepository: MyRepository,
    private val savedStateHandle: SavedStateHandle
) : ViewModel() {

    // ViewModel logic
    // ...

    // コンパニオンオブジェクトの内部で ViewModel ファクトリーを定義します。
    companion object {

        val Factory: ViewModelProvider.Factory = object : ViewModelProvider.Factory {
            @Suppress("UNCHECKED_CAST")
            override fun <T : ViewModel> create(
                modelClass: Class<T>,
                extras: CreationExtras
            ): T {
                // extras から Application オブジェクトを取得
                val application = checkNotNull(extras[APPLICATION_KEY])
                // extras から、この ViewModel 用の SavedStateHandle を生成する
                val savedStateHandle = extras.createSavedStateHandle()
                return MyViewModel(
                    (application as MyApplication).myRepository,
                    savedStateHandle
                ) as T
            }
        }
    }
}
```

注: コンテキストをわかりやすくし、可読性を高めて、検索を容易にするために、ViewModel ファクトリを ViewModel ファイル内に配置することをおすすめします。依存関係を共有している場合は、同じ ViewModel ファクトリを複数の ViewModel で使用できます。 [アーキテクチャブループリントのサンプル](https://github.com/android/architecture-samples/blob/views/app/src/main/java/com/example/android/architecture/blueprints/todoapp/ViewModelFactory.kt) を参照してください。

次に、 ViewModel のインスタンスを取得するときに、このファクトリを使用できます。

```kotlin
// Android View の場合
import androidx.activity.viewModels

class MyActivity : AppCompatActivity() {

    private val viewModel: MyViewModel by viewModels { MyViewModel.Factory }

    // Rest of Activity code
}
```

```kotlin
// Jetpack Compose の場合
import androidx.lifecycle.viewmodel.compose.viewModel

@Composable
fun MyScreen(
    modifier: Modifier = Modifier,
    viewModel: MyViewModel = viewModel(factory = MyViewModel.Factory)
) {
    // ...
}
```

ViewModel ファクトリは、 `viewModelFactory` 関数を使用して定義することも可能です。

```kotlin
import androidx.lifecycle.SavedStateHandle
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.ViewModelProvider.AndroidViewModelFactory.Companion.APPLICATION_KEY
import androidx.lifecycle.createSavedStateHandle
import androidx.lifecycle.viewmodel.initializer
import androidx.lifecycle.viewmodel.viewModelFactory

class MyViewModel(
    private val myRepository: MyRepository,
    private val savedStateHandle: SavedStateHandle
) : ViewModel() {

    // ViewModel logic

    // コンパニオンオブジェクトの内部で ViewModel ファクトリーを定義します。
    companion object {
        val Factory: ViewModelProvider.Factory = viewModelFactory {
            initializer {
                val savedStateHandle = createSavedStateHandle()
                val myRepository = (this[APPLICATION_KEY] as MyApplication).myRepository
                MyViewModel(
                    myRepository = myRepository,
                    savedStateHandle = savedStateHandle
                )
            }
        }
    }
}
```

## 2.5.0 より前のバージョンの ViewModel のファクトリ

古い実装方法なので、スキップします。必要に応じて、 [公式ドキュメント](https://developer.android.com/topic/libraries/architecture/viewmodel/viewmodel-factories?hl=ja&_gl=1*7ppgyv*_up*MQ..*_ga*MTE3NjE0ODY1NC4xNzIxOTcyNjA1*_ga_6HH9YJMN9M*MTcyMTk3MjYwNC4xLjAuMTcyMTk3MjYwNC4wLjAuMA..#viewmodel-factories-old) を参照してください。









