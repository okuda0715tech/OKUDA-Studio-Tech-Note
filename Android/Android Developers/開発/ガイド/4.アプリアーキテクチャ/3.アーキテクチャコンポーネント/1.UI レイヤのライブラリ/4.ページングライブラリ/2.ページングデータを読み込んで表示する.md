- [ページングデータを読み込んで表示する](#ページングデータを読み込んで表示する)
  - [データソースを定義する](#データソースを定義する)
    - [キーと値の型を選択する](#キーと値の型を選択する)
    - [PagingSource を定義する](#pagingsource-を定義する)
    - [エラーを処理する](#エラーを処理する)
  - [PagingData のストリームを設定する](#pagingdata-のストリームを設定する)
  - [RecyclerView アダプターを定義する](#recyclerview-アダプターを定義する)
  - [UI でページング データを表示する](#ui-でページング-データを表示する)


# ページングデータを読み込んで表示する

このガイドでは、ページングライブラリを使用し、ネットワークデータソースからのページングデータのストリームを設定して RecyclerView で表示する方法について説明します。


## データソースを定義する

最初のステップは、データソースを識別する PagingSource 実装を定義することです。PagingSource API クラスには load() メソッドが含まれています。このメソッドをオーバーライドして、対応するデータソースからページング データを取得する方法を示します。

非同期読み込みに Kotlin コルーチンを使用するには、PagingSource クラスを直接使います。ページング ライブラリには、他の非同期フレームワークをサポートするクラスも用意されています。

- RxJava を使用する場合は、RxPagingSource を実装します。
- Guava の ListenableFuture を使用する場合は、ListenableFuturePagingSource を実装します。

注: RxJava または Guava でページング ライブラリを使用するには、追加の依存関係を含める必要があります。


### キーと値の型を選択する

`PagingSource<Key, Value>` には、 Key と Value の 2 種類のパラメータがあります。キーは、データの読み込みに使用される識別子を定義します。値はデータ自体の型です。たとえば、 Int 型のページ番号を Retrofit に渡してネットワークから User オブジェクトのページを読み込む場合は、 Key 型として Int を選択し、 Value 型として User を選択します。


### PagingSource を定義する

次の例では、ページ番号ごとにアイテムのページを読み込む PagingSource を実装します。Key 型は Int、Value 型は User です。

```kotlin
class ExamplePagingSource(
    val backend: ExampleBackendService,
    val query: String
) : PagingSource<Int, User>() {
    override suspend fun load(
        params: LoadParams<Int>
    ): LoadResult<Int, User> {
        try {
            // ページ番号が null の場合は 1 ページ目の更新を開始する。
            val nextPageNumber = params.key ?: 1
            val response = backend.searchUsers(query, nextPageNumber)
            return LoadResult.Page(
                data = response.users,
                prevKey = null, // Only paging forward.
                nextKey = response.nextPageNumber
            )
        } catch (e: Exception) {
            // このブロックでエラーハンドリングを行います。
            // ネットワークエラーなどの予測可能なエラーに対して、
            // LoadResult.Error を返します。
        }
    }

    // データが更新された場合に、画面を更新すべきページのキーを返す関数
    // データが更新される度に呼び出される。
    override fun getRefreshKey(state: PagingState<Int, User>): Int? {
        // prevKey または nextKey のいずれかから、
        // anchorPosition に最も近いページのページキーを見つけようとします。
        // ここでは、null 可能性を考慮する必要があります。
        //  * prevKey == null -> アンカーページが最初のページ
        //  * nextKey == null -> アンカーページが最後のページ
        //  * prevKey と nextKey が両方とも null
        //     -> anchorPage は初期ページなので、null を返します。
        return state.anchorPosition?.let { anchorPosition ->
            val anchorPage = state.closestPageToPosition(anchorPosition)
            anchorPage?.prevKey?.plus(1) ?: anchorPage?.nextKey?.minus(1)
        }
    }
}
```

一般的な PagingSource 実装では、コンストラクタで提供されたパラメータを load() メソッドに渡して、クエリに適切なデータを読み込みます。上記の例では、これらのパラメータは次のとおりです。

- `backend` : データを提供するバックエンドサービスのインスタンス。
- `query` : backend サービスに送信する検索クエリ。

LoadParams オブジェクトには、実行する読み込みオペレーションに関する情報が含まれます。これには、読み込むキーと、読み込むアイテムの数が含まれます。

LoadResult オブジェクトには、読み込みオペレーションの結果が含まれます。 LoadResult は、 load() の呼び出しが成功したかどうかに応じて、次の 2 つの形式のいずれかになるシールクラスです。

- 読み込みが正常に完了すると、 LoadResult.Page オブジェクトが返されます。
- 読み込みが成功しなかった場合は、 LoadResult.Error オブジェクトが返されます。

次の図は、この例の load() 関数が各読み込みのキーを受け取り、後続の読み込みのキーを提供する方法を示しています。

<img src="./画像/load() がキーをどのように使用および更新するかを示す図.svg" width="400">

PagingSource の実装では、 PagingState オブジェクトをパラメータとして受け取る getRefreshKey() メソッドも実装する必要があります。初期読み込み後にデータが更新または無効化されたときに load() メソッドに渡すキーが返されます。その後データが更新されると、ページングライブラリは自動的にこのメソッドを呼び出します。

`anchorPosition` : リスト内で最近アクセスされたページのインデックス (プレースホルダーを含む)。 PagingData でまだアクセスが行われていない場合は null。たとえば、このスナップショットが最初のロードの前またはロード中に生成された場合などです。

`closestPageToPosition()` : リスト内のインデックス（プレースホルダーを含む）を、ページ内の最も近いロードされたページに強制変換します。この関数は、 anchorPosition で呼び出すことで、リスト内の最後にアクセスされたインデックスに最も近いロードされたページを取得できます。

### エラーを処理する

特にネットワーク経由でデータを読み込む場合、読み込みリクエストがさまざまな原因で失敗することがあります。load() メソッドから LoadResult.Error オブジェクトを返すことにより、読み込み中に発生したエラーを報告できます。

たとえば、load() メソッドに以下を追加することで、前の例の ExamplePagingSource での読み込みエラーをキャッチして報告できます。

```kotlin
catch (e: IOException) {
    // IOException : ネットワークの接続問題
    return LoadResult.Error(e)
} catch (e: HttpException) {
    // HttpException : HTTP ステータスコードが 2XX でない場合
    return LoadResult.Error(e)
}
```

Retrofit エラーの処理について詳しくは、PagingSource API リファレンスのサンプルをご覧ください。

PagingSource は、LoadResult.Error オブジェクトを収集して UI に配信し、ユーザーがそれらを操作できるようにします。UI で読み込み状態を公開する方法について詳しくは、 [読み込み状態の管理と表示](./5.読み込み状態の管理と表示.md) をご覧ください。


## PagingData のストリームを設定する
## RecyclerView アダプターを定義する
## UI でページング データを表示する



