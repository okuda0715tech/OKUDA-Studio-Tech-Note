- [アプリの起動](#アプリの起動)
  - [Hilt と Initializer の違い](#hilt-と-initializer-の違い)
    - [目的](#目的)
    - [使用場面](#使用場面)
  - [セットアップ](#セットアップ)
  - [アプリ起動時にコンポーネントを初期化する](#アプリ起動時にコンポーネントを初期化する)
    - [コンポーネント初期化子を実装する](#コンポーネント初期化子を実装する)
    - [マニフェストエントリを設定する](#マニフェストエントリを設定する)
    - [lint チェックを実行する](#lint-チェックを実行する)
  - [コンポーネントを手動で初期化する（遅延初期化）](#コンポーネントを手動で初期化する遅延初期化)
    - [個々のコンポーネントに対して自動初期化を無効にする](#個々のコンポーネントに対して自動初期化を無効にする)
    - [すべてのコンポーネントに対して自動初期化を無効にする](#すべてのコンポーネントに対して自動初期化を無効にする)
    - [コンポーネント初期化子を手動で呼び出す](#コンポーネント初期化子を手動で呼び出す)


# アプリの起動

App Startup ライブラリは、アプリの起動時にコンポーネントを初期化する簡単で効率的な方法を提供します。ライブラリデベロッパーとアプリ デベロッパーのどちらも、 App Startup を使用して起動シーケンスを簡素化し、初期化の順序を明示的に設定できます。

初期化する必要があるコンポーネントごとに個別のコンテンツプロバイダを定義する代わりに、 App Startup では、単一のコンテンツプロバイダを共有するコンポーネント初期化子を定義できます。これにより、アプリの起動時間が大幅に短縮されます。


## Hilt と Initializer の違い

### 目的

Hiltは依存性注入のためのライブラリであり、コードのモジュール化とテストの容易さを促進します。一方、Initializerはアプリ起動時の初期化処理を効率的に管理するためのツールです。

### 使用場面

Hiltは、コンポーネント間での依存関係を明確にして管理したい場合に使用します。Initializerは、アプリ起動時に実行すべき処理を整理・最適化したい場合に使用します。

## セットアップ

ライブラリまたはアプリで Jetpack Startup を使用するには、Gradle ファイルに次の行を追加します。

```kotlin
dependencies {
    implementation("androidx.startup:startup-runtime:1.1.1")
}
```


## アプリ起動時にコンポーネントを初期化する

アプリとライブラリは、多くの場合、アプリの起動時に直ちにコンポーネントを初期化する必要があります。このニーズを満たすには、コンテンツ プロバイダを使用して各依存関係を初期化する必要がありますが、コンテンツ プロバイダはインスタンス化のコストが高くなり、起動シーケンスが不必要に遅くなる可能性があります。また、Android はコンテンツ プロバイダを不確定の順序で初期化します。App Startup では、アプリの起動時にコンポーネントを初期化し、依存関係を明示的に定義するための効率的な方法が提供されます。

アプリの起動を使用して起動時にコンポーネントを自動的に初期化するには、アプリの初期化が必要なコンポーネントごとにコンポーネント初期化子を定義する必要があります。


### コンポーネント初期化子を実装する

Initializer<T> インターフェースを実装するクラスを作成して、各コンポーネント イニシャライザを定義します。このインターフェースは、次の 2 つの重要なメソッドを定義します。

create() メソッド。コンポーネントの初期化に必要なすべてのオペレーションが含まれ、T のインスタンスを返します。
dependencies() メソッド。イニシャライザが依存する他の Initializer<T> オブジェクトのリストを返します。このメソッドを使用すると、アプリが起動時にイニシャライザを実行する順序を制御できます。
たとえば、アプリが WorkManager に依存し、起動時に初期化する必要があるとします。Initializer<WorkManager> を実装する WorkManagerInitializer クラスを定義します。

```kotlin
// WorkManager を初期化する。
class WorkManagerInitializer : Initializer<WorkManager> {
    override fun create(context: Context): WorkManager {
        val configuration = Configuration.Builder().build()
        WorkManager.initialize(context, configuration)
        return WorkManager.getInstance(context)
    }
    override fun dependencies(): List<Class<out Initializer<*>>> {
        // WorkManager は他のライブラリに依存していないため、
        // emptyList() を返します。
        return emptyList()
    }
}
```

WorkManager は他のライブラリに依存しないため、dependencies() メソッドは空のリストを返します。

アプリが ExampleLogger というライブラリにも依存しているとします。このライブラリは WorkManager に依存します。この依存関係は、App Startup が最初に WorkManager を初期化するようにする必要があります。 `Initializer<ExampleLogger>` を実装する ExampleLoggerInitializer クラスを定義します。

```kotlin
class ExampleLoggerInitializer : Initializer<ExampleLogger> {
    override fun create(context: Context): ExampleLogger {
        // WorkManager.getInstance() は、 WorkManager が初期化された後にのみ、 non-null になります。
        return ExampleLogger(WorkManager.getInstance(context))
    }

    override fun dependencies(): List<Class<out Initializer<*>>> {
        // WorkManagerInitializer への依存を定義します。
        // これにより、 ExampleLogger は、 WorkManager が
        // 初期化された後に初期化されます。
        return listOf(WorkManagerInitializer::class.java)
    }
}
```

dependencies() メソッドに WorkManagerInitializer が含まれているため、App Startup は ExampleLogger の前に WorkManager を初期化します。

**注** : 以前にコンテンツプロバイダを使用してアプリのコンポーネントを初期化していた場合は、アプリの起動を使用する際にそれらのコンテンプロバイダを削除してください。


### マニフェストエントリを設定する

App Startup には、InitializationProvider という特別なコンテンツ プロバイダが含まれています。これを使用して、コンポーネント初期化子を検出して呼び出します。App Startup は、まず InitializationProvider マニフェスト エントリの <meta-data> エントリを確認することで、コンポーネント初期化子を検出します。次に、App Startup は、すでに検出しているイニシャライザに対して dependencies() メソッドを呼び出します。

つまり、App Startup がコンポーネント イニシャライザを検出できるようにするには、次のいずれかの条件を満たす必要があります。

コンポーネント イニシャライザには、InitializationProvider マニフェスト エントリの下に、対応する <meta-data> エントリがあります。
コンポーネント イニシャライザは、すでに検出可能なイニシャライザから dependencies() メソッドにリストされます。
WorkManagerInitializer と ExampleLoggerInitializer の例をもう一度考えてみましょう。App Startup がこれらのイニシャライザを検出できるようにするには、マニフェスト ファイルに次の行を追加します。

```xml
<provider
    android:name="androidx.startup.InitializationProvider"
    android:authorities="${applicationId}.androidx-startup"
    android:exported="false"
    tools:node="merge">
    <!-- このエントリは ExampleLoggerInitializer を検出可能にします。 -->
    <meta-data  android:name="com.example.ExampleLoggerInitializer"
          android:value="androidx.startup" />
</provider>
```

WorkManagerInitializer は ExampleLoggerInitializer の依存関係であるため、WorkManagerInitializer に <meta-data> エントリを追加する必要はありません。つまり、ExampleLoggerInitializer が検出可能であれば、WorkManagerInitializer も検出可能です。

tools:node="merge" 属性を使用すると、競合するエントリが [マニフェストマージツール](https://developer.android.com/studio/build/manage-manifests?hl=ja&_gl=1*1wll7ou*_up*MQ..*_ga*ODAyOTUxNTg4LjE3MjIzMTEwNTU.*_ga_6HH9YJMN9M*MTcyMjMxMTA1NS4xLjAuMTcyMjMxMTA1NS4wLjAuMA..#merge-manifests) によって適切に解決されるようになります。


### lint チェックを実行する

App Startup ライブラリには、コンポーネント初期化子が正しく定義されているかどうかを確認するために使用できる一連の lint ルールが含まれています。これらの lint チェックを実行するには、コマンドラインから ./gradlew :app:lintDebug を実行します。


## コンポーネントを手動で初期化する（遅延初期化）

通常、 App Startup を使用する場合、アプリの起動時にコンポーネント初期化子を自動的に検出して実行します。ただし、起動時にアプリが必要としないコンポーネントを後で手動で初期化することもできます。これは遅延初期化と呼ばれ、起動コストを最小限に抑えるのに役立ちます。

通常は、 AppInitializer が、 InitializationProvider によって、自動的に初期化処理が実行されますが、この AppInitializer を手動で実行することで、遅延初期化を行います。

そのためには、まず、手動で初期化するコンポーネントの自動初期化を無効にする必要があります。


### 個々のコンポーネントに対して自動初期化を無効にする

単一のコンポーネントの自動初期化を無効にするには、そのコンポーネントのイニシャライザの `<meta-data>` エントリをマニフェストから削除します。

たとえば、マニフェストファイルに次の行を追加すると、 ExampleLogger の自動初期化が無効になります。

```xml
<provider
    android:name="androidx.startup.InitializationProvider"
    android:authorities="${applicationId}.androidx-startup"
    android:exported="false"
    tools:node="merge">
    <meta-data android:name="com.example.ExampleLoggerInitializer"
              tools:node="remove" />
</provider>
```

マージツールが他のすべてのマージマニフェストファイルからエントリを削除できるように、 **単純にエントリを削除するのではなく、tools:node="remove" を使用して削除します。**

注: コンポーネントの自動初期化を無効にすると、そのコンポーネントの依存関係の自動初期化も無効になります。


### すべてのコンポーネントに対して自動初期化を無効にする

すべての自動初期化を無効にするには、マニフェストから InitializationProvider のエントリ全体を削除します。

```xml
<provider
    android:name="androidx.startup.InitializationProvider"
    android:authorities="${applicationId}.androidx-startup"
    tools:node="remove" />
```


### コンポーネント初期化子を手動で呼び出す

コンポーネントの自動初期化が無効になっている場合、AppInitializer を使用してそのコンポーネントと依存関係を手動で初期化できます。

たとえば、次のコードは AppInitializer を呼び出し、手動で ExampleLogger を初期化します。

```kotlin
AppInitializer.getInstance(context)
    .initializeComponent(ExampleLoggerInitializer::class.java)
```

その結果、WorkManager は ExampleLogger の依存関係であるため、App Startup は WorkManager も初期化します。




