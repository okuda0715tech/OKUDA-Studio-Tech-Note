- [ドラッグ \& ドロップ](#ドラッグ--ドロップ)


# ドラッグ & ドロップ

Jetpack Compose は、次の 2 つの修飾子を使用してドラッグ アンド ドロップをサポートします。

- [dragAndDropSource](https://developer.android.com/reference/kotlin/androidx/compose/foundation/draganddrop/package-summary?_gl=1*1fjqump*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2#(androidx.compose.ui.Modifier).dragAndDropSource(kotlin.coroutines.SuspendFunction1)): ドラッグ ジェスチャの開始点となるコンポーザブルを指定します

- [dragAndDropTarget](https://developer.android.com/reference/kotlin/androidx/compose/foundation/draganddrop/package-summary?_gl=1*1fjqump*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2#(androidx.compose.ui.Modifier).dragAndDropTarget(kotlin.Function1,androidx.compose.ui.draganddrop.DragAndDropTarget)): ドロップされたデータを受け入れるコンポーザブルを指定します

たとえば、ユーザーがアプリ内で画像をドラッグできるようにするには、画像コンポーザブルを作成し、dragAndDropSource 修飾子を追加します。ドロップ ターゲットを設定するには、別の画像コンポーザブルを作成し、dragAndDropTarget 修飾子を追加します。

修飾子は、複数のドラッグ ソースと複数のドロップ ターゲットに適用できます。

修飾子により、アプリは、 [View](https://developer.android.com/reference/kotlin/android/view/View?_gl=1*1fjqump*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2) 実装と相互運用可能な [ClipData](https://developer.android.com/reference/kotlin/android/content/ClipData?_gl=1*1fjqump*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2) を使用して、2 つ以上のコンポーザブル間でデータを共有できます。

注: ドラッグ アンド ドロップは、一般的なリスト パターンである [ピックアップして移動する](https://m3.material.io/foundations/interaction/gestures#af76950f-a24c-43bd-bfcd-a9eb15768142) とは異なります。


## ドラッグイベントを開始する

コンポーネント内でドラッグ イベントを有効にするには、 suspend 関数をパラメータとして受け取る dragAndDropSource 修飾子を追加します。

この関数は、ドラッグ操作を開始するユーザー操作を定義します。 dragAndDropSource 修飾子は、ポインター入力イベントを受信するまで待機し、イベント ハンドラーに渡されたラムダを実行します。ラムダを使用して、タップや長押しなどのさまざまな入力イベントを検出します。詳細については、 [Compose での pointer input](../2.ポインタ入力/) をご覧ください。

ポインター入力イベントは通常、次のように実装される長押しです。

```kotlin
Modifier.dragAndDropSource {
    detectTapGestures(onLongPress = {
        // Transfer data here.
    })
}
```

ドラッグ アンド ドロップ セッションを開始するには、 [startTransfer()](https://developer.android.com/reference/kotlin/androidx/compose/foundation/draganddrop/DragAndDropSourceScope?_gl=1*7kiq1j*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2#startTransfer(androidx.compose.ui.draganddrop.DragAndDropTransferData)) 関数を呼び出します。このスコープ内では、 [DragAndDropTransferData](https://developer.android.com/reference/kotlin/androidx/compose/ui/draganddrop/DragAndDropTransferData?_gl=1*7kiq1j*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2) を使用して転送可能なデータを表します。データは、リモート URI、クリップボード上のリッチ テキスト データ、ローカル ファイルなどですが、すべて ClipData オブジェクトにラップする必要があります。たとえば、次のようにプレーン テキストを指定します。

```kotlin
Modifier.dragAndDropSource {
    detectTapGestures(onLongPress = {
        startTransfer(
            DragAndDropTransferData(
                // 第一引数はラベルで、第二引数が実際に渡すデータです。
                ClipData.newPlainText(
                    "image Url", url
                )
            )
        )
    })
}
```

ドラッグ アクションがアプリの境界を越えることを可能にするために、DragAndDropTransferData コンストラクターは flags 引数を受け入れます。次の例では、 [DRAG_FLAG_GLOBAL](https://developer.android.com/reference/kotlin/android/view/View?_gl=1*c8rbqk*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2#drag_flag_global) 定数は、データをあるアプリから別のアプリにドラッグできることを指定します。

```kotlin
Modifier.dragAndDropSource {
    detectTapGestures(onLongPress = {
        startTransfer(
            DragAndDropTransferData(
                ClipData.newPlainText(
                    "image Url", url
                ),
                flags = View.DRAG_FLAG_GLOBAL
            )
        )
    })
}
```

DragAndDropTransferData は、Android View システムでサポートされているフラグを受け入れます。使用可能なフラグの完全なリストについては、 [View の定数リスト](https://developer.android.com/reference/kotlin/android/view/View?_gl=1*c8rbqk*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2#drag_flag_global) を参照してください。


## ドロップデータを受信する

コンポーザブルに dragAndDropTarget 修飾子を割り当てると、コンポーザブルがドラッグ アンド ドロップ イベントを受信できるようになります。この修飾子には 2 つのパラメータがあります。1 つ目はフィルタとして機能し、修飾子が受け入れ可能なデータの種類を指定します。2 つ目はコールバックでデータを配信します。

コールバック インスタンスは記憶しておく必要があることに注意してください。次のスニペットは、コールバックを記憶する方法を示しています。

```kotlin
val callback = remember {
    object : DragAndDropTarget {
        override fun onDrop(event: DragAndDropEvent): Boolean {
            // Parse received data
            return true
        }
    }
}
```

次のスニペットは、ドロップされたプレーン テキストを処理する方法を示しています。

```kotlin
Modifier.dragAndDropTarget(
    shouldStartDragAndDrop = { event ->
        event.mimeTypes().contains(ClipDescription.MIMETYPE_TEXT_PLAIN)
    }, target = callback
)
```

コールバック関数は、イベントが消費された場合は true を返し、イベントが拒否されて親コンポーネントに伝播しない場合は false を返す必要があります。


## ドラッグ & ドロップイベントを処理する

DragAndDropTarget インターフェースのコールバックをオーバーライドして、ドラッグ アンド ドロップ イベントがいつ開始、終了するか、またはコンポーネントに出入りするかを監視し、UI とアプリの動作を正確に制御します。

```kotlin
object : DragAndDropTarget {
    override fun onStarted(event: DragAndDropEvent) {
        // ドラッグイベントが開始されたとき
    }

    override fun onEntered(event: DragAndDropEvent) {
        // ドラッグされているオブジェクトが、ドロップ可能なターゲット内に入ったとき
    }

    override fun onEnded(event: DragAndDropEvent) {
        // ドラッグイベントが停止したとき
    }

    override fun onExited(event: DragAndDropEvent) {
        // ドラッグされているオブジェクトが、ドロップ可能なターゲットの外に出たとき
    }

    override fun onDrop(event: DragAndDropEvent): Boolean = true
}
```


## 追加の情報

Codelab: [Drag and drop in Compose](https://developer.android.com/codelabs/codelab-dnd-compose?_gl=1*kj8yjf*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzQwNjYwNi4zLjAuMTcyNzQwNjYwNi4wLjAuOTIyMDk1MzI2)


