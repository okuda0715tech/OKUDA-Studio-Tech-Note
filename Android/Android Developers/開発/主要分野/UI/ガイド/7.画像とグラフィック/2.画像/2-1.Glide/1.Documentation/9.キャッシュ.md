- [キャッシュ](#キャッシュ)
  - [Glide でのキャッシュ](#glide-でのキャッシュ)
  - [キャッシュ キー](#キャッシュ-キー)
  - [キャッシュ構成](#キャッシュ構成)
    - [ディスク キャッシュ戦略](#ディスク-キャッシュ戦略)
    - [キャッシュからのみロード](#キャッシュからのみロード)
    - [キャッシュをスキップする（そもそもキャッシュしない）](#キャッシュをスキップするそもそもキャッシュしない)
    - [実装](#実装)
  - [キャッシュを無効化する（キャッシュをクリアする）](#キャッシュを無効化するキャッシュをクリアする)
    - [キャッシュの無効化をカスタマイズする](#キャッシュの無効化をカスタマイズする)
  - [リソース管理](#リソース管理)
    - [メモリ キャッシュ](#メモリ-キャッシュ)
      - [永続的なサイズの変更](#永続的なサイズの変更)
      - [一時的なサイズの変更](#一時的なサイズの変更)
      - [メモリのクリア](#メモリのクリア)
    - [ディスク キャッシュ](#ディスク-キャッシュ)
      - [永続的なサイズの変更](#永続的なサイズの変更-1)
      - [ディスク キャッシュのクリア](#ディスク-キャッシュのクリア)


# キャッシュ

## Glide でのキャッシュ

デフォルトでは、 Glide は、画像の新しいリクエストを開始する前に、複数のキャッシュ レイヤーをチェックします。

1. **アクティブリソース** - この画像は現在別のビューに表示されていますか?
2. **メモリキャッシュ** - この画像は最近読み込まれ、まだメモリ内にありますか?
3. **リソース** - この画像は以前にデコード、変換され、ディスク キャッシュに書き込まれましたか?
4. **データ** - この画像が取得されたデータは以前にディスク キャッシュに書き込まれましたか?

前半の 2 つのチェックでは、リソースがメモリ内にあるかどうかを確認し、ある場合はすぐに画像を返します。後半の 2 つのチェックでは、画像がディスク上にあるかどうかを確認し、すぐに非同期で返します。

4 つの手順すべてで画像が見つからない場合、Glide は元のソースに戻ってデータ (元のファイル、URI、URL など) を取得します。

Glide のキャッシュのデフォルトのサイズと場所の詳細、またはそれらのパラメータを構成する方法については、 [構成ページ](./8.構成.md/#ディスク-キャッシュ) を参照してください。


## キャッシュ キー

Glide 4 では、すべてのキャッシュ キーに少なくとも 2 つの要素が含まれます:

1. ロードが要求されるモデル (ファイル、URI、URL)。カスタム モデルを使用している場合は、hashCode() と equals() を正しく実装する必要があります
2. オプションの [署名](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/request/RequestOptions.html#signature-com.bumptech.glide.load.Key-)

実際、キャッシュレイヤーのチェックステップ 1 ～ 3 (アクティブ リソース、メモリ キャッシュ、リソース ディスク キャッシュ) のキャッシュ キーには、次のデータもいくつか含まれています:

1. 幅と高さ
2. オプションの変換
3. 追加された [オプション](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/Option.html)
4. 要求されたデータ タイプ (ビットマップ、GIF など)

細かい点になりますが、アクティブ リソースとメモリ キャッシュに使用されるキーは、リソース ディスク キャッシュから使用されるキーとは若干異なります。なぜなら、ビットマップの構成に影響するオプションや、その他のデコード時間のみのパラメータなどのメモリ オプションが必要とされるかされないかの違いがあるためです。

ディスク上のディスク キャッシュ キーの名前を生成するには、キーの個々の要素をハッシュして 1 つの文字列キーを作成し、それをディスク キャッシュのファイル名として使用します。


## キャッシュ構成

Glide には、リクエストごとにロードが Glide のキャッシュとどのようにやり取りするかを選択できるオプションが多数用意されています。


### ディスク キャッシュ戦略

[DiskCacheStrategy](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/DiskCacheStrategy.html) は、 [diskCacheStrategy](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/request/RequestOptions.html#diskCacheStrategy-com.bumptech.glide.load.engine.DiskCacheStrategy-) メソッドを使用して個々のリクエストに適用できます。使用可能な戦略により、ロードがディスク キャッシュを使用したりディスク キャッシュに書き込んだりしないようにしたり、ロードをバックアップする変更されていない元のデータのみ、ロードによって生成された変換されたサムネイルのみ、またはその両方をキャッシュするように選択できます。

デフォルトの戦略である [AUTOMATIC](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/DiskCacheStrategy.html#AUTOMATIC) は、ローカルおよびリモート イメージに最適な戦略を使用しようとします。リモート データ (URL など) をロードするときには、AUTOMATIC はロードをバックアップする変更されていないデータのみを保存します。これは、リモート データのダウンロードは、すでにディスク上にあるデータのサイズ変更に比べてコストがかかるためです。ローカル データの場合、AUTOMATIC は変換されたサムネイルのみを保存します。これは、2 番目のサムネイル サイズまたはタイプを生成する必要がある場合に元のデータを取得する方がコストがかからないためです。

DiskCacheStrategy を適用するには:

```java
Glide.with(fragment)
    .load(url)
    .diskCacheStrategy(DiskCacheStrategy.ALL)
    .into(imageView);
```


### キャッシュからのみロード

状況によっては、画像がまだキャッシュにない場合はロードを失敗させたい場合があります。これを行うには、リクエストごとに [onlyRetrieveFromCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/request/RequestOptions.html#onlyRetrieveFromCache-boolean-) メソッドを使用します:

```java
Glide.with(fragment)
    .load(url)
    .onlyRetrieveFromCache(true)
    .into(imageView);
```

画像がメモリ キャッシュまたはディスク キャッシュに見つかった場合は、ロードされます。それ以外の場合、このオプションが true に設定されていると、ロードは失敗します。


### キャッシュをスキップする（そもそもキャッシュしない）

特定のリクエストでディスク キャッシュまたはメモリ キャッシュのいずれか、または両方をスキップするようにしたい場合は、Glide にはいくつかの代替手段があります。

メモリ キャッシュのみをスキップするには、 [skipMemoryCache()](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/request/RequestOptions.html#skipMemoryCache-boolean-) を使用します:

```java
Glide.with(fragment)
    .load(url)
    .skipMemoryCache(true)
    .into(view);
```

ディスク キャッシュのみをスキップするには、 [DiskCacheStrategy.NONE](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/DiskCacheStrategy.html#NONE) を使用します。

```java
Glide.with(fragment)
    .load(url)
    .diskCacheStrategy(DiskCacheStrategy.NONE)
    .into(view);
```

上記のオプションは同時に使用できます:

```java
Glide.with(fragment)
    .load(url)
    .diskCacheStrategy(DiskCacheStrategy.NONE)
    .skipMemoryCache(true)
    .into(view);
```

一般的に、キャッシュをスキップしないようにする必要があります。キャッシュから画像をロードする方が、画像を取得、デコード、変換して新しいサムネイルを作成するよりもはるかに高速です。

キャッシュ内のアイテムのエントリを更新するだけの場合は、以下の [無効化に関するドキュメント](#キャッシュの無効化) を参照してください。


### 実装

利用可能なオプションがニーズに十分でない場合は、独自の [DiskCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.html) 実装を作成することもできます。詳細については、 [構成ページ](./8.構成.md/#ディスク-キャッシュ) を参照してください。


## キャッシュを無効化する（キャッシュをクリアする）

ディスク キャッシュはハッシュ キーであるため、特定の URL またはファイル パスに対応するディスク上のキャッシュされたファイルをすべて単純に削除する適切な方法はありません。元の画像のロードまたはキャッシュのみが許可されていれば問題は単純になりますが、Glide はサムネイルもキャッシュし、さまざまな変換も提供しているため、それぞれがキャッシュ内に新しいファイルを生成するため、画像のキャッシュされたバージョンをすべて追跡して削除することは困難です。

実際には、キャッシュ ファイルを無効にする最善の方法は、コンテンツ (URL、URI、ファイル パスなど) が変更されたときに、可能な場合は識別子を変更することです。


### キャッシュの無効化をカスタマイズする

識別子を変更することは困難または不可能な場合が多いため、 Glide では、制御する追加データをキャッシュ キーに組み込むための [signature()](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/request/RequestOptions.html#signature-com.bumptech.glide.load.Key-) API も提供しています。署名は、メディア ストア コンテンツだけでなく、バ​​ージョン管理メタデータを維持できるコンテンツにも適しています。

- メディア ストア コンテンツ - メディア ストア コンテンツの場合、署名として Glide の [MediaStoreSignature](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/signature/MediaStoreSignature.html) クラスを使用できます。MediaStoreSignature を使用すると、メディア ストア アイテムの変更日時、MIME タイプ、および方向をキャッシュ キーに組み込むことができます。これら 3 つの属性により、編集と更新を確実にキャッチして、メディア ストアのサムネイルをキャッシュできます。

- ファイル - [ObjectKey](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/signature/ObjectKey.html) を使用して、ファイルの変更日時を組み込むことができます。

- URL - URL を無効にする最善の方法は、URL のコンテンツが変更されたときにサーバーが URL を変更し、クライアントを更新するようにすることですが、代わりに [ObjectKey](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/signature/ObjectKey.html) を使用して任意のメタデータ (バージョン番号など) を混ぜることもできます。

署名をロードに渡すのは簡単です。


```java
Glide.with(yourFragment)
    .load(yourFileDataModel)
    .signature(new ObjectKey(yourVersionMetadata))
    .into(yourImageView);
```

必要なデータを事前に MediaStore から一括ロードしておけば、メディア ストアの署名も簡単です。

```java
Glide.with(fragment)
    .load(mediaStoreUri)
    .signature(new MediaStoreSignature(mimeType, dateModified, orientation))
    .into(view);
```

Key インターフェイスを実装して独自の署名を定義することもできます。equals()、hashCode()、updateDiskCacheKey() メソッドを必ず実装してください。

```java
public class IntegerVersionSignature implements Key {
    private int currentVersion;

    public IntegerVersionSignature(int currentVersion) {
         this.currentVersion = currentVersion;
    }
   
    @Override
    public boolean equals(Object o) {
        if (o instanceof IntegerVersionSignature) {
            IntegerVersionSignature other = (IntegerVersionSignature) o;
            return currentVersion == other.currentVersion;
        }
        return false;
    }
 
    @Override
    public int hashCode() {
        return currentVersion;
    }

    @Override
    public void updateDiskCacheKey(MessageDigest md) {
        messageDigest.update(ByteBuffer.allocate(Integer.SIZE).putInt(signature).array());
    }
}
```

パフォーマンスの低下を避けるには、イメージをロードするときに利用できるように、バックグラウンドでバージョン管理メタデータを一括ロードする必要があることに注意してください。

他の方法がすべて失敗し、識別子を変更できず、適切なバージョン メタデータを追跡できない場合は、 [diskCacheStrategy()](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/request/RequestOptions.html#diskCacheStrategy-com.bumptech.glide.load.engine.DiskCacheStrategy-) と [DiskCacheStrategy.NONE](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/DiskCacheStrategy.html#NONE) を使用してディスク キャッシュを完全に無効にすることもできます。


## リソース管理

Glide のディスク キャッシュとメモリ キャッシュは LRU です。つまり、メモリやディスク領域をどんどん消費し、限界に達すると、限界近くまで継続的に消費します。柔軟性を高めるために、Glide では、アプリケーションが使用するリソースを管理するための追加の方法をいくつか提供しています。

メモリ キャッシュ、ビットマップ プール、ディスク キャッシュが大きいほど、通常は、少なくともある程度までは、パフォーマンスがいくらか向上することに注意してください。キャッシュ サイズを変更する場合は、変更の前後でパフォーマンスを慎重に測定し、パフォーマンスとサイズのトレードオフが妥当であることを確認する必要があります。


### メモリ キャッシュ

デフォルトでは、Glide のメモリ キャッシュと [BitmapPool](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/bitmap_recycle/BitmapPool.html) は [ComponentCallbacks2](https://d.android.com/reference/android/content/ComponentCallbacks2.html?is-external=true) に応答し、フレームワークが提供するレベルに応じてさまざまな程度にその内容を自動的に削除します。そのため、通常はキャッシュや BitmapPool を動的に監視またはクリアする必要はありません。ただし、必要が生じた場合に備えて、Glide はいくつかの手動オプションを提供します。


#### 永続的なサイズの変更

アプリケーション全体で Glide が使用できる RAM の量を変更するには、 [構成ページ](./8.構成.md/#メモリ-キャッシュ) を参照してください。


#### 一時的なサイズの変更

アプリの特定の部分で Glide がメモリを一時的に増減できるようにするには、 [setMemoryCategory](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/Glide.html#setMemoryCategory-com.bumptech.glide.MemoryCategory-) を使用します。

```java
Glide.get(context).setMemoryCategory(MemoryCategory.LOW);
// Or:
Glide.get(context).setMemoryCategory(MemoryCategory.HIGH);
```

アプリのメモリやパフォーマンスに敏感な領域を離れるときには、必ずメモリ カテゴリをリセットし直してください。

```java
Glide.get(context).setMemoryCategory(MemoryCategory.NORMAL);
```


#### メモリのクリア

Glide のメモリ内キャッシュと [BitmapPool](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/bitmap_recycle/BitmapPool.html) を単純にクリアするには、 [clearMemory](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/Glide.html#clearMemory--) を使用します:

```java
// このメソッドはメイン スレッドで呼び出す必要があります。
Glide.get(context).clearMemory();
```

すべてのメモリをクリアすることは特に効率的ではないため、ジャンクや読み込み時間の増加を避けるために、可能な限り避けてください。


### ディスク キャッシュ

Glide は実行時にディスク キャッシュ サイズを限定的に制御するだけですが、サイズと構成は AppGlideModule で変更できます。


#### 永続的なサイズの変更

アプリケーション全体で Glide のディスク キャッシュに使用できる SD カード領域の量を変更するには、 [構成ページ](./8.構成.md/#ディスク-キャッシュ) を参照してください。


#### ディスク キャッシュのクリア

ディスク キャッシュ内のすべてのアイテムをクリアするには、 [clearDiskCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/Glide.html#clearDiskCache--) を使用できます:

```java
new AsyncTask<Void, Void, Void> {
    @Override
    protected Void doInBackground(Void... params) {
        // This method must be called on a background thread.
        Glide.get(applicationContext).clearDiskCache();
        return null;
    }
}
```


