- [構成](#構成)
  - [セットアップ](#セットアップ)
    - [アプリケーション](#アプリケーション)
    - [ラ​​イブラリ](#ライブラリ)
      - [ライブラリで AppGlideModule を避ける](#ライブラリで-appglidemodule-を避ける)
  - [アプリケーション オプション](#アプリケーション-オプション)
    - [メモリ キャッシュ](#メモリ-キャッシュ)
    - [ビットマップ プール](#ビットマップ-プール)
    - [ディスク キャッシュ](#ディスク-キャッシュ)


# 構成

## セットアップ

Glide 4.9.0 以降、このページで説明されているセットアップは、いくつかの場合にのみ必要です。

アプリケーションの場合、セットアップは、アプリケーションが次の操作を実行する場合にのみ必要です。

- 1 つ以上の統合ライブラリを使用する
- Glide の構成を変更する (ディスク キャッシュのサイズ/場所、メモリ キャッシュのサイズなど)

ライブラリの場合、セットアップは、ライブラリが 1 つ以上のコンポーネントを登録する場合にのみ必要です。


### アプリケーション

統合ライブラリや Glide の API 拡張機能を使用するアプリケーションでは、次の操作を行う必要があります。

1. [AppGlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/AppGlideModule.html) 実装を 1 つだけ追加する
2. オプションで、 [LibraryGlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/LibraryGlideModule.html) 実装を 1 つ以上追加する。
3. [@GlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/annotation/GlideModule.html) アノテーションを AppGlideModule 実装とすべての LibraryGlideModule 実装に追加する。
4. [Glide のアノテーション プロセッサへの依存関係を追加する。](https://bumptech.github.io/glide/doc/download-setup.html#configuring-glide--annotation-processors)

Glide の [Flickr サンプル アプリ](https://github.com/bumptech/glide/blob/master/samples/flickr/src/main/java/com/bumptech/glide/samples/flickr/FlickrGlideModule.java) の AppGlideModule の例は次のようになります:

```java
@GlideModule
public class FlickrGlideModule extends AppGlideModule {
    @Override
    public void registerComponents(Context context, Glide glide, Registry registry) {
        registry.append(Photo.class, InputStream.class, new FlickrModelLoader.Factory());
    }
}
```

Glide の注釈プロセッサを含めるには、Glide の注釈プロセッサが必要です。その依存関係を設定する方法の詳細については、 [ダウンロードとセットアップ ページ](https://bumptech.github.io/glide/doc/download-setup.html#configuring-glide--annotation-processors) を参照してください。


### ラ​​イブラリ

カスタム コンポーネントを登録しないライブラリでは、構成手順を実行する必要がなく、このページのセクションを完全にスキップできます。

ModelLoader などのカスタム コンポーネントを登録する必要があるライブラリでは、次の操作を実行できます:

1. 新しいコンポーネントを登録する 1 つ以上の [LibraryGlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/LibraryGlideModule.html) 実装を追加します。
2. すべての [LibraryGlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/LibraryGlideModule.html) 実装に [@GlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/annotation/GlideModule.html) アノテーションを追加します。
3. [Glide のアノテーション プロセッサへの依存関係を追加します。](https://bumptech.github.io/glide/doc/download-setup.html#configuring-glide--annotation-processors)

Glide の [OkHttp 統合ライブラリ](https://github.com/bumptech/glide/blob/master/integration/okhttp3/src/main/java/com/bumptech/glide/integration/okhttp3/OkHttpLibraryGlideModule.java) の [LibraryGlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/LibraryGlideModule.html) の例は次のようになります。

```java
@GlideModule
public final class OkHttpLibraryGlideModule extends LibraryGlideModule {
    @Override
    public void registerComponents(Context context, Glide glide, Registry registry) {
        registry.replace(GlideUrl.class, InputStream.class, new OkHttpUrlLoader.Factory());
    }
}
```

[@GlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/annotation/GlideModule.html) アノテーションを使用するには、Glide のアノテーションへの依存関係が必要です:

```
compile 'com.github.bumptech.glide:annotations:4.14.2'
```


#### ライブラリで AppGlideModule を避ける

ライブラリには AppGlideModule 実装を含めないでください。そうすると、ライブラリに依存するアプリケーションが依存関係を管理したり、Glide のキャッシュ サイズや場所などのオプションを設定したりできなくなります。

さらに、2 つのライブラリに AppGlideModule が含まれている場合、アプリケーションは両方に依存しているとコンパイルできず、どちらか一方を選択するよう強制されます。


## アプリケーション オプション

Glide では、アプリケーションが [AppGlideModule](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/AppGlideModule.html) 実装を使用して Glide のメモリとディスク キャッシュの使用を完全に制御できます。Glide はほとんどのアプリケーションに適切なデフォルトを提供しようとしますが、一部のアプリケーションではこれらの値をカスタマイズする必要があります。パフォーマンスの低下を回避するために、変更の結果は必ず測定してください。


### メモリ キャッシュ

デフォルトでは、Glide は [LruResourceCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/LruResourceCache.html) を使用します。これは、LRU 削除で固定量のメモリを使用する [MemoryCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/MemoryCache.html) インターフェイスのデフォルト実装です。 LruResourceCache のサイズは、Glide の [MemorySizeCalculator](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/MemorySizeCalculator.html) クラスによって決定されます。このクラスは、デバイスのメモリ クラス、デバイスの RAM 容量が少ないかどうか、画面の解像度を考慮します。

アプリケーションは、AppGlideModule で、 [applyOptions(Context, GlideBuilder)](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/module/AppGlideModule.html#applyOptions-android.content.Context-com.bumptech.glide.GlideBuilder-) メソッドを使用して MemorySizeCalculator を構成することで、MemoryCache サイズをカスタマイズできます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
  @Override
  public void applyOptions(Context context, GlideBuilder builder) {
    MemorySizeCalculator calculator = new MemorySizeCalculator.Builder(context)
        .setMemoryCacheScreens(2)
        .build();
    builder.setMemoryCache(new LruResourceCache(calculator.getMemoryCacheSize()));
  }
}
```

アプリケーションはキャッシュ サイズを直接上書きすることもできます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
  @Override
  public void applyOptions(Context context, GlideBuilder builder) {
    int memoryCacheSizeBytes = 1024 * 1024 * 20; // 20mb
    builder.setMemoryCache(new LruResourceCache(memoryCacheSizeBytes));
  }
}
```

アプリケーションは独自の [MemoryCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/MemoryCache.html) 実装を提供することもできます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
  @Override
  public void applyOptions(Context context, GlideBuilder builder) {
    builder.setMemoryCache(new YourAppMemoryCacheImpl());
  }
}
```


### ビットマップ プール

Glide は、 [LruBitmapPool](https://bumptech.github.io/glide/javadocs/431/com/bumptech/glide/load/engine/bitmap_recycle/LruBitmapPool.html) をデフォルトの [BitmapPool](https://bumptech.github.io/glide/javadocs/431/com/bumptech/glide/load/engine/bitmap_recycle/BitmapPool.html) として使用します。 LruBitmapPool は、LRU 削除を使用するメモリ内の固定サイズのビットマップ プールです。デフォルトのサイズは、対象のデバイスの画面サイズと密度、メモリ クラス、および [isLowRamDevice](https://developer.android.com/reference/android/app/ActivityManager.html#isLowRamDevice()) の戻り値に基づきます。具体的な計算は、Glide の [MemorySizeCalculator](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/MemorySizeCalculator.html) によって行われます。これは、Glide の [MemoryCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/MemoryCache.html) のサイズが決定される方法に似ています。

アプリケーションは、AppGlideModule で、applyOptions(Context, GlideBuilder) メソッドを使用して MemorySizeCalculator を構成することで、ビットマップ プールのサイズをカスタマイズできます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
    @Override
    public void applyOptions(Context context, GlideBuilder builder) {
        MemorySizeCalculator calculator = new MemorySizeCalculator.Builder(context)
            .setBitmapPoolScreens(3)
            .build();
        builder.setBitmapPool(new LruBitmapPool(calculator.getBitmapPoolSize()));
    }
}
```

アプリケーションはプール サイズを直接オーバーライドすることもできます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
    @Override
    public void applyOptions(Context context, GlideBuilder builder) {
        int bitmapPoolSizeBytes = 1024 * 1024 * 30; // 30mb
        builder.setBitmapPool(new LruBitmapPool(bitmapPoolSizeBytes));
    }
}
```

アプリケーションは [BitmapPool](https://bumptech.github.io/glide/javadocs/431/com/bumptech/glide/load/engine/bitmap_recycle/BitmapPool.html) の独自の実装を提供することもできます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
    @Override
    public void applyOptions(Context context, GlideBuilder builder) {
        builder.setBitmapPool(new YourAppBitmapPoolImpl());
    }
}
```


### ディスク キャッシュ

Glide は、デフォルトの [DiskCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.html) として [DiskLruCacheWrapper](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskLruCacheWrapper.html) を使用します。DiskLruCacheWrapper は、LRU 削除機能を備えた固定サイズのディスク キャッシュです。デフォルトのディスク キャッシュ サイズは [250 MB](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.Factory.html#DEFAULT_DISK_CACHE_SIZE) で、アプリケーションの [キャッシュ フォルダー](https://developer.android.com/reference/android/content/Context.html#getCacheDir()) 内の [特定のディレクトリ](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.Factory.html#DEFAULT_DISK_CACHE_DIR) に配置されます。

アプリケーションは、表示するメディアが公開されている場合 (認証なしの Web サイト、検索エンジンなどから取得)、場所を外部ストレージに変更できます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
  @Override
  public void applyOptions(Context context, GlideBuilder builder) {
    builder.setDiskCache(new ExternalCacheDiskCacheFactory(context));
  }
}
```

アプリケーションは、内部ディスク キャッシュまたは外部ディスク キャッシュのディスク サイズを変更できます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
  @Override
  public void applyOptions(Context context, GlideBuilder builder) {
    int diskCacheSizeBytes = 1024 * 1024 * 100; // 100 MB
    builder.setDiskCache(new InternalCacheDiskCacheFactory(context, diskCacheSizeBytes));
  }
}
```

アプリケーションは、外部ストレージまたは内部ストレージ内でキャッシュが配置されるフォルダーの名前を変更できます。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
  @Override
  public void applyOptions(Context context, GlideBuilder builder) {
    int diskCacheSizeBytes = 1024 * 1024 * 100; // 100 MB
    builder.setDiskCache(
        new InternalCacheDiskCacheFactory(context, "cacheFolderName", diskCacheSizeBytes));
  }
}
```

アプリケーションは、 [DiskCache](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.html) インターフェイスを独自に実装し、それを生成する独自の [DiskCache.Factory](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.Factory.html) を提供することもできます。Glide は、Factory インターフェイスを使用してバックグラウンド スレッドで [DiskCaches](https://bumptech.github.io/glide/javadocs/400/com/bumptech/glide/load/engine/cache/DiskCache.html) を開き、キャッシュが [StrictMode](https://developer.android.com/reference/android/os/StrictMode.html) 違反を引き起こすことなく、ターゲット ディレクトリの存在を確認するなどの I/O を実行できるようにします。

```java
@GlideModule
public class YourAppGlideModule extends AppGlideModule {
    @Override
    public void applyOptions(Context context, GlideBuilder builder) {
        builder.setDiskCache(new DiskCache.Factory() {
            @Override
            public DiskCache build() {
                return new YourAppCustomDiskCache();
            }
        });
    }
}
```





