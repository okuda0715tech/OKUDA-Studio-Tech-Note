- [Swipeable から AnchoredDraggable に移行する](#swipeable-から-anchoreddraggable-に移行する)
  - [SwipeableState を AnchoredDraggableState に移行する](#swipeablestate-を-anchoreddraggablestate-に移行する)
    - [状態ホルダーを入れ替える](#状態ホルダーを入れ替える)
    - [オフセットにアクセスする](#オフセットにアクセスする)
  - [Modifier.swipeable を Modifier.anchoredDraggable に移行する](#modifierswipeable-を-modifieranchoreddraggable-に移行する)
    - [アンカーの定義](#アンカーの定義)
    - [位置のしきい値を定義する](#位置のしきい値を定義する)
    - [速度のしきい値を定義する](#速度のしきい値を定義する)
  - [API サーフェスの変更](#api-サーフェスの変更)
    - [AnchoredDraggableState](#anchoreddraggablestate)
    - [Modifier.anchoredDraggable](#modifieranchoreddraggable)


# Swipeable から AnchoredDraggable に移行する

[Swipeable](https://developer.android.com/reference/kotlin/androidx/compose/material/SwipeableState?_gl=1*bqpndr*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..) は、ボトムシート、ドロワー、スワイプして閉じるなどの個別の状態間でスワイプできるコンポーネントの構築に役立つ Compose Material API です。コンポーネントのサイズに依存するアンカーなどの高度なユースケースをより適切にサポートするために、後継の [AnchoredDraggable](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*bqpndr*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..) が Compose-Foundation 1.6.0-alpha01 で公開されました。AnchoredDraggable は、ボトムシート、ドロワー、スワイプして閉じるなどのアンカー状態を持つドラッグ可能なコンポーネントを構築するための Foundation API です。

Material の Swipeable API は Foundation の AnchoredDraggable に置き換えられ、廃止されました。今後のリリースでは削除されます。このガイドでは、Swipeable API から AnchoredDraggable に移行する方法について説明します。

注: AnchoredDraggable は試験的な API です。試験的な API は将来変更される可能性があります。


## SwipeableState を AnchoredDraggableState に移行する

まず、状態ホルダーを変更します。 AnchoredDraggableState は継承できず、初期化される前のオフセットは Float.NaN として表されます。


### 状態ホルダーを入れ替える

[AnchoredDraggableState](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*1cl6ldn*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..) は final クラスであるため、継承できません。そのため、既存のコンポーネントが [SwipeableState](https://developer.android.com/reference/kotlin/androidx/compose/material/SwipeableState?_gl=1*1cl6ldn*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..) を継承している場合は、単純な入れ替えができません。その場合は、 AnchoredDraggableState から継承するのではなく、 AnchoredDraggableState への参照を保持します。

```kotlin
// 既存のコンポーザブルが Swipeable を継承している場合
class MySwitchState: SwipeableState()
```

```kotlin
// AnchoredDraggableState を継承するのではなく、参照するようにします。
class MySwitchState {
    private val anchoredDraggableState = AnchoredDraggableState(...)
}
```

状態ホルダーは SwipeableState から継承されなくなったため、API を自分で公開する必要があるかもしれません。使用できる最も一般的な API は、 [offset](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*1thqmey*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#offset()) 、 [progress](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*1thqmey*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#progress()) 、 [currentValue](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*1thqmey*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#currentValue()) 、 [targetValue](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*1thqmey*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#targetValue()) です。


### オフセットにアクセスする

Swipeable とは異なり、AnchoredDraggableState のオフセットは初期化される前は Float.NaN です。アンカーを AnchoredDraggableState のコンストラクターに渡すと、オフセットがすぐに初期化されます。 AnchoredDraggable では、アンカーを AnchoredDraggableState のコンストラクターに渡すか、 [AnchoredDraggableState#updateAnchors](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*xrbriu*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#updateAnchors(androidx.compose.foundation.gestures.DraggableAnchors,kotlin.Any)) で更新できます。

アンカーがレイアウトに依存している場合や変更される可能性がある場合は、アンカーが変更されたときに状態が再作成されないように、AnchoredDraggableState#updateAnchors を使用します。アンカーが静的な場合は、コンストラクターに渡します。

updateAnchors を使用する場合、アンカーを updateAnchors に渡す前のオフセットは Float.NaN になります。誤って Float.NaN をコンポーネントに渡さないようにするには、 [AnchoredDraggableState#requireOffset](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/AnchoredDraggableState?_gl=1*xrbriu*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#requireOffset()) を使用して、オフセットの読み取り時に要求されていることを明示します。これにより、不整合やバグの可能性を早期に発見できます。

```kotlin
@Composable
fun AnchoredDraggableBox() {
    val state = remember { AnchoredDraggableState(...) }
    val density = LocalDensity.current
    val anchors = remember { DraggableAnchors { ... } }
    SideEffect {
        state.updateAnchors(anchors)
    }
    Box(
        Modifier.offset { IntOffset(x = state.requireOffset(), y = 0) }
    }
}
```

注: AnchoredDraggable のオーバーフロー サポートは現在実装中です。最新のステータスについては、 [b/288084801](https://issuetracker.google.com/288084801) を参照してください。


## Modifier.swipeable を Modifier.anchoredDraggable に移行する

[Modifier.anchoredDraggable()](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/package-summary?_gl=1*tw7d74*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#(androidx.compose.ui.Modifier).anchoredDraggable(androidx.compose.foundation.gestures.AnchoredDraggableState,androidx.compose.foundation.gestures.Orientation,kotlin.Boolean,kotlin.Boolean,androidx.compose.foundation.interaction.MutableInteractionSource)) は [Modifier.swipeable](https://developer.android.com/reference/kotlin/androidx/compose/material/package-summary?_gl=1*tw7d74*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#(androidx.compose.ui.Modifier).swipeable(androidx.compose.material.SwipeableState,kotlin.collections.Map,androidx.compose.foundation.gestures.Orientation,kotlin.Boolean,kotlin.Boolean,androidx.compose.foundation.interaction.MutableInteractionSource,kotlin.Function2,androidx.compose.material.ResistanceConfig,androidx.compose.ui.unit.Dp))() に代わるものです。 Modifier.swipeable() のパラメータの一部は、次のセクションで説明するように、AnchoredDraggableState に直接移動されました。


### アンカーの定義

[DraggableAnchors](https://developer.android.com/reference/kotlin/androidx/compose/foundation/gestures/DraggableAnchors?_gl=1*1f5gea5*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..) ビルダー メソッドを使用してアンカーを定義します。次に、それらを AnchoredDraggableState#updateAnchors または AnchoredDraggableState のコンストラクターに渡します。

```kotlin
// コンストラクタで渡す場合
enum class DragValue { Start, Center, End }

@Composable
fun AnchoredDraggableBox() {
    val anchors = DraggableAnchors {
        Start at -100.dp.toPx()
        Center at 0f
        End at 100.dp.toPx()
    }
    val state = remember {
        AnchoredDraggableState(anchors = anchors)
    }
    Box(
        Modifier.offset { IntOffset(x = state.requireOffset(), y = 0) }
    )
}
```

```kotlin
// updateAnchors で渡す場合
enum class DragValue { Start, Center, End }

@Composable
fun AnchoredDraggableBox() {
    val state = remember { AnchoredDraggableState(...) }
    val density = LocalDensity.current
    val anchors = with (density) {
        DraggableAnchors {
            Start at -100.dp.toPx()
            Center at 0f
            End at 100.dp.toPx()
        }
    }
    SideEffect {
        state.updateAnchors(anchors)
    }
    Box(
        Modifier.offset { IntOffset(x = state.requireOffset(), y = 0) }
    )
}
```

アンカーが静的な場合は、コンストラクターに渡します。レイアウトに依存する場合、または静的でない場合は、 updateAnchors を使用します。


### 位置のしきい値を定義する

閾値とは、それを定義することで、その閾値を超えない限り、スワイプされても、元の状態に戻るという意味だと思われます。 [こちら](./5.ドラッグ、スワイプ、フリング.md/#スワイプ) の動作を参照。

しきい値パラメータのタイプと名前が変更されました。AnchoredDraggableState には、別の ThresholdConfig インターフェースの代わりに、しきい値の位置を返すラムダ関数を受け取る positionalThreshold パラメータがあります。たとえば、位置しきい値 50% は次のように表現できます。

```kotlin
val anchoredDraggableState = AnchoredDraggableState(
    positionalThreshold = { distance -> distance * 0.5f },
    // ...
)
```

56dp の位置しきい値は次のように表すことができます。

```kotlin
val density = LocalDensity.current
val anchoredDraggableState = AnchoredDraggableState(
    positionalThreshold = { with(density) { 56.dp.toPx() } },
    // ...
)
```


### 速度のしきい値を定義する

速度しきい値も AnchoredDraggableState のコンストラクターに渡され、ラムダとして表現されます。

```kotlin
val density = LocalDensity.current
val anchoredDraggableState = AnchoredDraggableState(
    velocityThreshold = { with(density) { 125.dp.toPx() } },
    // ...
)
```


## API サーフェスの変更

API サーフェスの変更の概要については以下をご覧ください。


### AnchoredDraggableState

[公式ドキュメント](https://developer.android.com/develop/ui/compose/touch-input/pointer-input/migrate-swipeable?_gl=1*jpfa8e*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#changes-api-state) を参照

### Modifier.anchoredDraggable

[公式ドキュメント](https://developer.android.com/develop/ui/compose/touch-input/pointer-input/migrate-swipeable?_gl=1*jpfa8e*_up*MQ..*_ga*MjExMDE2NTk5NS4xNzI3MzM1MzI5*_ga_6HH9YJMN9M*MTcyNzMzNTMyOC4xLjAuMTcyNzMzNTMyOC4wLjAuMTM2Njk3ODM2MA..#changes-api-modifier) を参照

