- [インストルメンテーションテストを作成する](#インストルメンテーションテストを作成する)
  - [テスト環境をセットアップする](#テスト環境をセットアップする)
  - [インストルメンテーションテストクラスを作成する](#インストルメンテーションテストクラスを作成する)
  - [インストルメンテーションテストを実行する](#インストルメンテーションテストを実行する)
  - [参考情報](#参考情報)
    - [サンプル](#サンプル)
    - [Codelab](#codelab)
  - [引用元資料](#引用元資料)


# インストルメンテーションテストを作成する

インストルメンテーションテストは、物理デバイスか、エミュレーターかのいずれかの Android デバイスで実行されます。そのため、 Android フレームワーク API を利用できます。したがって、インストルメンテーションテストの方が、ローカルテストよりも忠実度が高くなりますが、実行速度は大幅に下がります。

インストルメンテーションテストは、実際のデバイスの動作をテストする必要がある場合にのみ、使用することをおすすめします。 [AndroidX Test](https://developer.android.com/training/testing/instrumented-tests/androidx-test-libraries/test-setup?hl=ja&_gl=1*1bs4zge*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) には、インストルメンテーションテストを簡単に記述できるライブラリが、いくつか用意されています。

**注** : インストルメンテーションテストは、 [Instrumentation](https://developer.android.com/reference/android/app/Instrumentation?hl=ja&_gl=1*t407zt*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) インスタンスにアクセスできる、特別な環境で初期化されます。このクラスを使用すると、アプリケーションコンテキストと API にアクセスして、テスト対象のアプリを操作できます。また、インストルメンテーションテストに名前を付与できます。


## テスト環境をセットアップする

Android Studio プロジェクトでは、インストルメンテーションテストのソースファイルを `module-name/src/androidTest/java/` に保存します。このディレクトリは、新しいプロジェクトの作成時に作成され、インストルメンテーションテストのサンプルが定義されています。

始める前に、 AndroidX Test API を追加する必要があります。これにより、アプリのインストルメンテーションテストコードを、すばやくビルドして実行できます。 AndroidX Test には、 [AndroidJUnitRunner](https://developer.android.com/reference/androidx/test/runner/AndroidJUnitRunner?hl=ja&_gl=1*1yqtmpd*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) ( JUnit 4 テストランナー) と、機能 UI テスト用の API ( [Espresso](https://developer.android.com/training/testing/espresso?hl=ja&_gl=1*380hdf*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) , [UI Automator](https://developer.android.com/training/testing/ui-automator?hl=ja&_gl=1*380hdf*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) , [Compose テスト](https://developer.android.com/jetpack/compose/testing?hl=ja&_gl=1*380hdf*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) など) が含まれています。

また、テストランナーと AndroidX Test が提供するルール API を使用するには、プロジェクトの Android テスト依存関係を構成する必要があります。

アプリの最上位の build.gradle ファイルで、次のライブラリを依存関係として指定する必要があります。

```gradle
dependencies {
    // テストランナー
    androidTestImplementation "androidx.test:runner:$androidXTestVersion"
    // ルール
    androidTestImplementation "androidx.test:rules:$androidXTestVersion"
    // Optional -- UI testing with Espresso
    androidTestImplementation "androidx.test.espresso:espresso-core:$espressoVersion"
    // Optional -- UI testing with UI Automator
    androidTestImplementation "androidx.test.uiautomator:uiautomator:$uiAutomatorVersion"
    // Optional -- UI testing with Compose
    androidTestImplementation "androidx.compose.ui:ui-test-junit4:$compose_version"
}
```

最新バージョンは [AndroidX リリースノート](https://developer.android.com/jetpack/androidx/releases/test?hl=ja&_gl=1*1liai2c*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) と [Compose UI のリリースノート](https://developer.android.com/reference/androidx/test/runner/AndroidJUnitRunner?hl=ja&_gl=1*1liai2c*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) で確認できます。

JUnit 4 テストクラスを使用して、テストフィルタリングなどの機能を利用するには、アプリのモジュールレベルの build.gradle ファイルに、次の設定を記述してください。そうすることで、プロジェクトのデフォルトのテストインストルメンテーションランナーとして [AndroidJUnitRunner](https://developer.android.com/reference/androidx/test/runner/AndroidJUnitRunner?hl=ja&_gl=1*g4u986*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..) が指定されます。

```gradle
android {
    defaultConfig {
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }
}
```


## インストルメンテーションテストクラスを作成する

インストルメンテーションテストのクラスは、ローカル単体テストと同様に、 JUnit 4 テストクラスである必要があります。

インストルメント化された JUnit 4 テストクラスを作成するには、デフォルトのテストランナーとして AndroidJUnit4 を指定します。

**注** : テストスイートが JUnit3 ライブラリと JUnit4 ライブラリの組み合わせに依存している場合は、テストクラス定義の先頭に `@RunWith(AndroidJUnit4::class)` アノテーションを追加します。

次の例は、 Parcelable インターフェースが LogHistory クラスに正しく実装されていることを検証するインストルメンテーションテストです。処理の流れは、以下の通りです。

1. LogHistory インスタンス ( logHistory ) を作成
2. `addEntry(TEST_STRING, TEST_LONG)` で、 logHistory ( Parcelable オブジェクト) にデータを書き込み
3. `writeToParcel(parcel, describeContents())` で、 logHistory のデータを parcel ( LogHistory とは別の Parcelable オブジェクト) に書き込み
4. `setDataPosition(0)` で parcel のカーソル位置を先頭に移動
5. `LogHistory.CREATOR.createFromParcel(parcel)` で parcel からデータを取得し、新しいオブジェクトで LogHistory を復元
6. 復元した LogHistory のデータ ( `createdFromParcel.getData()` ) をテストで検証

```kotlin
import android.os.Parcel
import android.text.TextUtils.writeToParcel
import androidx.test.filters.SmallTest
import androidx.test.runner.AndroidJUnit4
import com.google.common.truth.Truth.assertThat
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith

const val TEST_STRING = "This is a string"
const val TEST_LONG = 12345678L

// ここの @RunWith アノテーションは、 JUnit3 と JUnit4 を同時に使用する場合のみ必要です。
@RunWith(AndroidJUnit4::class)
@SmallTest
class LogHistoryAndroidUnitTest {
    private lateinit var logHistory: LogHistory

    @Before
    fun createLogHistory() {
        logHistory = LogHistory()
    }

    @Test
    fun logHistory_ParcelableWriteRead() {
        val parcel = Parcel.obtain()
        logHistory.apply {
            // 送信と受信のために、 Parcelable オブジェクトをセットアップします。
            addEntry(TEST_STRING, TEST_LONG)

            // データの書き込み
            writeToParcel(parcel, describeContents())
        }

        // カーソル位置を先頭に移動します。
        // 書き込みが完了した後、カーソル位置はデータの末尾にあります。
        // 後続のデータ読み込み処理のために、カーソル位置を先頭に移動します。
        parcel.setDataPosition(0)

        // データの読み込み
        val createdFromParcel: LogHistory = LogHistory.CREATOR.createFromParcel(parcel)
        createdFromParcel.getData().also { createdFromParcelData: List<Pair<String, Long>> ->

            // Verify that the received data is correct.
            assertThat(createdFromParcelData.size).isEqualTo(1)
            assertThat(createdFromParcelData[0].first).isEqualTo(TEST_STRING)
            assertThat(createdFromParcelData[0].second).isEqualTo(TEST_LONG)
        }
    }
}
```

`describeContents()` 関数は、 LogHistroy クラスの関数です。この関数は、 Parcelable オブジェクトを実装する際に、実装が必要です。 describeContents() 関数は、 Parcelable オブジェクトに含まれるデータの種類が、特殊なデータなのかどうかを返します。特殊なデータではない場合は、 0 を返しますが、特殊なデータの場合は、そのデータがどのようなデータなのかを返します。

**注**: Kotlin で、テストにバッククォートを使用して名前を付ける機能は、 API 30 以降を搭載しているデバイスでのみサポートされます。

例

```kotlin
@Test fun `everything works`() { ... }
```


## インストルメンテーションテストを実行する

インストルメンテーションテストは、実際のデバイス、または、エミュレータで実行できます。テストの実行方法については、以下のリンクを参照してください。

- [Android Studio からテストする](https://developer.android.com/studio/test/test-in-android-studio?hl=ja)
- [コマンドラインからテストする](https://developer.android.com/studio/test/command-line?hl=ja&_gl=1*ps7ome*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..)


## 参考情報

UI テストは通常、 UI の正しい動作を検証するインストルメンテーション テストです。そのようなライブラリでは、 Espresso や Compose Test などのフレームワークを使用します。詳しくは、 [UI テストガイド](https://developer.android.com/training/testing/ui-tests/behavior?hl=ja) をご覧ください。

インストルメンテーションテストの使用方法については、次のリソースをご覧ください。


### サンプル

- [インストルメンテーション単体テストのコードサンプル](https://github.com/android/testing-samples/tree/main/unit/BasicUnitAndroidTest)


### Codelab

- [Android テスト Codelab](https://developer.android.com/codelabs/advanced-android-kotlin-training-testing-basics?hl=ja&_gl=1*1b1ejz8*_up*MQ..*_ga*MzgzNjQyNS4xNzIzMTAyNTUx*_ga_6HH9YJMN9M*MTcyMzEwMjU1MC4xLjAuMTcyMzEwMjU1MC4wLjAuMA..)


## 引用元資料

- [インストルメンテーションテストを作成する](https://developer.android.com/training/testing/instrumented-tests?hl=ja)

