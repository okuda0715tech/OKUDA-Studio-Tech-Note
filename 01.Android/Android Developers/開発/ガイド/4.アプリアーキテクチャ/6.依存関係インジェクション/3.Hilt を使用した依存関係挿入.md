- [Hilt を使用した依存関係挿入](#hilt-を使用した依存関係挿入)
  - [依存関係を追加する](#依存関係を追加する)
  - [エントリポイントにアノテーションを付与する](#エントリポイントにアノテーションを付与する)
    - [Applicaiton クラスにアノテーションを付与する](#applicaiton-クラスにアノテーションを付与する)
    - [その他の Android クラスに依存関係を注入する](#その他の-android-クラスに依存関係を注入する)
      - [Hilt がサポートしている Android クラス](#hilt-がサポートしている-android-クラス)
      - [エントリーポイントの階層を意識する](#エントリーポイントの階層を意識する)
  - [プロパティに @Inject アノテーションを付与する](#プロパティに-inject-アノテーションを付与する)
  - [Hilt バインディング（クラスとそのインスタンスの生成方法の紐づけ）を定義する](#hilt-バインディングクラスとそのインスタンスの生成方法の紐づけを定義する)
    - [定義済みの Hilt バインディング](#定義済みの-hilt-バインディング)
      - [Context 以外の場合](#context-以外の場合)
      - [Context の場合](#context-の場合)
  - [Hilt モジュール](#hilt-モジュール)
    - [@Binds を使用してインターフェース インスタンスを注入する](#binds-を使用してインターフェース-インスタンスを注入する)
    - [@Provides を使用してインスタンスを注入する](#provides-を使用してインスタンスを注入する)
    - [同じ型に複数のバインディングを提供する](#同じ型に複数のバインディングを提供する)
    - [Hilt で事前定義されている修飾子](#hilt-で事前定義されている修飾子)
    - [インストールしたコンポーネント内の他のバインディングへのアクセス](#インストールしたコンポーネント内の他のバインディングへのアクセス)
  - [Android クラスに対して生成されたコンポーネント](#android-クラスに対して生成されたコンポーネント)
    - [コンポーネントのライフタイム](#コンポーネントのライフタイム)
    - [Hilt コンポーネントのスコープ](#hilt-コンポーネントのスコープ)
    - [コンストラクタでスコープを設定する場合](#コンストラクタでスコープを設定する場合)
      - [スコープの設定に使用するアノテーションの一覧](#スコープの設定に使用するアノテーションの一覧)
      - [アノテーションの指定方法](#アノテーションの指定方法)
    - [Hilt モジュールにスコープを設定する場合](#hilt-モジュールにスコープを設定する場合)
      - [スコープ設定時の注意点](#スコープ設定時の注意点)
        - [1. スコープの設定は最小限にする](#1-スコープの設定は最小限にする)
        - [2. 範囲の異なるスコープの関係](#2-範囲の異なるスコープの関係)
    - [Hilt コンポーネントの階層](#hilt-コンポーネントの階層)
    - [コンポーネントのデフォルトバインディング](#コンポーネントのデフォルトバインディング)
    - [Hilt でサポートされていないクラスに依存関係を注入する](#hilt-でサポートされていないクラスに依存関係を注入する)
  - [Hilt と Dagger](#hilt-と-dagger)


# Hilt を使用した依存関係挿入

Hilt は Android 用の依存関係インジェクション ライブラリです。これを使うことで、プロジェクトで依存関係の注入（DI）を手動で行うためのボイラープレートが減ります。手動で依存関係の注入を行うには、すべてのクラスとその依存関係を手作業で作成し、コンテナを使用して依存関係の再利用と管理を行う必要があります。

Hilt は、プロジェクト内のすべての Android クラスにコンテナを提供し、そのライフサイクルを自動で管理することで、アプリケーションで DI を行うための標準的な方法を提供します。Hilt は、よく知られた DI ライブラリである Dagger の上に構築されているため、コンパイル時の正確性、実行時のパフォーマンス、スケーラビリティ、Android Studio のサポートといった Dagger の恩恵を受けられます。詳細については、Hilt と Dagger をご覧ください。

このガイドでは、Hilt とそこで生成されるコンテナの基本概念について説明します。また、既存のアプリで Hilt を使用できるようにする方法も紹介します。


## 依存関係を追加する

まず、hilt-android-gradle-plugin プラグインをプロジェクトのルート build.gradle ファイルに追加します。

```kotlin
plugins {
  ...
  id("com.google.dagger.hilt.android") version "2.44" apply false
}
```

次に、Gradle プラグインを適用し、app/build.gradle ファイルに次の依存関係を追加します。

```kotlin
plugins {
  id("kotlin-kapt")
  id("com.google.dagger.hilt.android")
}

android {
  ...
}

dependencies {
  implementation("com.google.dagger:hilt-android:2.44")
  kapt("com.google.dagger:hilt-android-compiler:2.44")
}

// Allow references to generated code
kapt {
  correctErrorTypes = true
}
```

注: Hilt とデータ バインディングの両方を使用するプロジェクトには、Android Studio 4.0 以降が必要です。

Hilt は Java 8 の機能を使用しています。プロジェクトで Java 8 を有効にするには、app/build.gradle ファイルに次の内容を追加します。

```kotlin
android {
  ...
  compileOptions {
    // 常に最新のバージョンを使用しましょう。
    // 2024 年 12 月現在の最新は 17 です。
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
  }
}
```


## エントリポイントにアノテーションを付与する

### Applicaiton クラスにアノテーションを付与する

Hilt を使用するアプリには、@HiltAndroidApp アノテーションが付けられた Application クラスが含まれている必要があります。

@HiltAndroidApp は、 Hilt のコード生成をトリガーします。これにより、アプリケーションレベルの依存関係コンテナも生成されます。

```kotlin
@HiltAndroidApp
class ExampleApplication : Application() { ... }
```


### その他の Android クラスに依存関係を注入する

@AndroidEntryPoint アノテーションが付けられた Android クラスは、そのプロパティに依存関係を注入できるようになります。

```kotlin
@AndroidEntryPoint
class ExampleActivity : AppCompatActivity() {

}
```


#### Hilt がサポートしている Android クラス

現在、 Hilt は以下の Android クラスをサポートしています。

| Hilt がサポートしている Android クラス | 付与するアノテーション |
| -------------------------------------- | ---------------------- |
| Application                            | @HiltAndroidApp        |
| ViewModel                              | @HiltViewModel         |
| Activity                               | @AndroidEntryPoint     |
| Fragment                               | @AndroidEntryPoint     |
| View                                   | @AndroidEntryPoint     |
| Service                                | @AndroidEntryPoint     |
| BroadcastReceiver                      | @AndroidEntryPoint     |

注: Android クラスの Hilt サポートには、次の例外が適用されます。
- ComponentActivity を拡張するアクティビティのみをサポートします（AppCompatActivity など）。
- androidx.Fragment を拡張するフラグメントのみをサポートします。
- 保存されたフラグメントをサポートしていません。
  - `setRetainInstance(true)` が指定されたフラグメントのこと
  - 構成変更時に破棄されないフラグメントのこと
  - このフラグメントの使用は、現在、非推奨になっています。


#### エントリーポイントの階層を意識する

- @AndroidEntryPoint アノテーションは階層的に付与する必要があります。例えば、 Fragment に付与した場合は、それをホストする Activity にも付与する必要があります。

- 上位の階層で定義されたインジェクションは下位の階層でも使用可能です。例えば、 Applicaiton コンテナで定義されたインジェクションは、 Activity コンテナでも使用可能です。


## プロパティに @Inject アノテーションを付与する

依存関係を注入したいプロパティには @Injection アノテーションを付与します。

```kotlin
@AndroidEntryPoint
class ExampleActivity : AppCompatActivity() {

    @Inject lateinit var analytics: AnalyticsAdapter

}
```

ただし、これだけでは、まだ依存関係を注入することはできません。なぜなら、インスタンスをどのように生成するのかという定義がまだ明確になっていないためです


## Hilt バインディング（クラスとそのインスタンスの生成方法の紐づけ）を定義する

コンストラクタを使用してインスタンスを生成するように指示する場合

```kotlin
// コンストラクタの前に @Inject アノテーションを付与します。
class AnalyticsAdapter @Inject constructor(
  private val service: AnalyticsService
) { ... }
```

上記の例では、 AnalyticsAdapter のインスタンスを生成するには、 AnalyticsService のインスタンスが必要なこともわかります。そのため、 AnalyticsService のインスタンスの生成方法 (バインディング) も定義する必要があります。


### 定義済みの Hilt バインディング

以下のクラスについては、バインディングが定義済みであるため、新たに定義することなく、自動的にバインディングされます。

- Application
- SavedStateHandle
- Activity とその派生クラス
- Fragment とその派生クラス
- View とその派生クラス
- Fragment とその派生クラス
- Service とその派生クラス
- Context


#### Context 以外の場合

バインディングが定義済みのクラスについては、以下のように何も特別な記述なしで依存性が注入されます。

```kotlin
class AnalyticsServiceImpl @Inject constructor(

    // 何も特別な記述を追加することなく、
    // application にインジェクトされます。
    application: Application

) { ... }
```


#### Context の場合

Context クラスについてもバインディングが定義済みですが、 Context の場合は、 ApplicationContext と ActivityContext を区別するために、アノテーションを付与する必要があります。

```kotlin
// ApplicationContext が必要な場合
class AnalyticsServiceImpl @Inject constructor(
    // アノテーションを付与する必要があります。
    @ApplicationContext context: Context
) : AnalyticsService { ... }

// ActivityContext が必要な場合
class AnalyticsAdapter @Inject constructor(
    // アノテーションを付与する必要があります。
    @ActivityContext context: Context
) { ... }
```


## Hilt モジュール

Hilt モジュールは、 @Module アノテーションが付けられたクラスです。

コンストラクタ以外の方法でインスタンスを生成したい場合に、インスタンスの生成方法を Hilt に伝えるためのクラスです。

詳細は、 [Hilt モジュール](./【コードラボ】Android%20アプリでの%20Hilt%20の使用.md/#7-hilt-モジュール) を参照してください。


### @Binds を使用してインターフェース インスタンスを注入する

詳細は、 [@Bind を使用したインターフェースの提供](./【コードラボ】Android%20アプリでの%20Hilt%20の使用.md/#8-bind-を使用したインターフェースの提供) を参照してください。


### @Provides を使用してインスタンスを注入する


### 同じ型に複数のバインディングを提供する

詳細は、 xxx を参照してください。


### Hilt で事前定義されている修飾子

詳細は、 xxx を参照してください。


### インストールしたコンポーネント内の他のバインディングへのアクセス

Hilt モジュールを @InstallIn アノテーションで、 Hilt コンポーネント (※ 1 ) にインストールすると、その Hilt コンポーネント内で定義されている別のバインディングへアクセスできるようになります。

(※ 1 )  
Hilt コンポーネントとは、 Hilt で生成したインスタンスを保持するコンテナのことです。あらかじめ主要な Android コンポーネント ( Activity や ViewModel ) ごとに Hilt コンポーネントが用意されています。


## Android クラスに対して生成されたコンポーネント

Hilt は Hilt コンポーネントを自動的に生成し、管理します。開発者は、必要な場所で適切なスコープを持った Hilt コンポーネントを使用して依存関係を注入するだけです。

例えば、 Activity のライフサイクルに連動した ActivityComponent は、各 Activity ごとに存在します。


### コンポーネントのライフタイム

Hilt コンポーネントは、以下のタイミングで生成、破棄されます。

| Hilt コンポーネント  | 作成のタイミング         | 破棄のタイミング           |
| ------------------------- | ------------------------ | -------------------------- |
| SingletonComponent        | Application#onCreate()   | Application を破棄した時 |
| ActivityRetainedComponent | Activity#onCreate()      | Activity#onDestroy()       |
| ViewModelComponent        | ViewModel を生成した時 | ViewModel を破棄した時   |
| ActivityComponent         | Activity#onCreate()      | Activity#onDestroy()       |
| FragmentComponent         | Fragment#onAttach()      | Fragment#onDestroy()       |
| ViewComponent             | View#super()             | View を破棄した時        |
| ViewWithFragmentComponent | View#super()             | View を破棄した時        |
| ServiceComponent          | Service#onCreate()       | Service#onDestroy()        |

Hilt コンポーネントが生成する依存関係のインスタンスは、スコープを設定しているかどうかで、再利用されるかどうかが決まります。

- スコープを設定しなかった場合
  - バインディングをリクエストする度に新しいインスタンスが生成されます。
- スコープを設定した場合
  - そのスコープの間は同じインスタンスが再利用されます。


### Hilt コンポーネントのスコープ


デフォルトでは、 Hilt のすべてのバインディングはスコープ設定されていません。つまり、アプリがバインディングをリクエストするたびに、新しいインスタンスが作成されます。必要に応じて、自分でスコープを設定することで、そのスコープ内では、同じインスタンスを再利用 (共有) することが可能です。

スコープを設定すると、依存関係のインスタンスは、そのスコープに対応した Hilt コンポーネント内で管理されます。

スコープの指定方法は、インスタンスの生成方法によって異なります。

- コンストラクタでインスタンスを生成する場合
  - コンストラクタに対して、指定したいスコープのアノテーションを付与します。
- Hilt モジュールでインスタンスを生成する場合
  - Hilt モジュールに対して `@InstallIn()` アノテーションを付与して、そのパラメータに Hilt コンポーネントを渡します。
  - どの Hilt コンポーネントを指定するかによって、スコープが決まります。


### コンストラクタでスコープを設定する場合

#### スコープの設定に使用するアノテーションの一覧

スコープを指定するアノテーションには以下のものがあります。

| アノテーション          | スコープ                                          |
| ----------------------- | ------------------------------------------------- |
| @Singleton              | Application                                       |
| @ActivityRetainedScoped | Activity                                          |
| @ViewModelScoped        | ViewModel                                         |
| @ActivityScoped         | Activity                                          |
| @FragmentScoped         | Fragment                                          |
| @ViewScoped             | View                                              |
| @ViewScoped             | @WithFragmentBindings アノテーションが付いた View |
| @ServiceScoped          | Service                                           |


#### アノテーションの指定方法

コンストラクタを使用してインスタンスを生成するようにしている場合には、コンストラクタにアノテーションを付与します。

```kotlin
@ActivityScoped
class AnalyticsAdapter @Inject constructor(
    private val service: AnalyticsService
) { ... }
```


### Hilt モジュールにスコープを設定する場合

Hilt モジュールにスコープを設定する場合は、 @InstallIn アノテーションの引数に設定します。



#### スコープ設定時の注意点

##### 1. スコープの設定は最小限にする

スコープの設定は最小限にしてください。スコープ設定された依存関係のインスタンスはメモリ上に残り続けるため、コストになる場合があります。特にスコープ設定が有効なのは、インスタンスの生成に時間がかかる場合や、インスタンスの生成を同期する必要がある場合です。


##### 2. 範囲の異なるスコープの関係

上位レベルのスコープ設定は、下位レベルのスコープ設定を含みます。つまり、 Application レベルのスコープが設定されたプロパティは、 Activity や Fragment 内でも同じインスタンスが共有されます。


### Hilt コンポーネントの階層

下位のコンポーネント内からは、上位のコンポーネントのバインディングにアクセスできます。例えば、 FragmentComponent 内のバインディングは、 ActivityComponent および SingletonComponent のバインディングにアクセスできます。

<img src="./画像/Hilt コンポーネントの階層.svg" width="600">

ViewComponent から FragmentComponent と ActivityComponent にアクセスするためには、 @WithFragmentBindings アノテーションを使用して、 ViewWithFragmentComponent を使用する必要があります。


### コンポーネントのデフォルトバインディング

デフォルトバインディングが定義されているもの ( Applicaiton や Activity など) については、バインディングを定義せずとも依存関係を注入することができます。


### Hilt でサポートされていないクラスに依存関係を注入する

詳しくは、 [こちら](./【コードラボ】Android%20アプリでの%20Hilt%20の使用.md) を参照してください。


## Hilt と Dagger

Hilt は Dagger を Android で使用しやすくしたものです。 Android では、 Dagger を直接使用するよりも、 Hilt を使用したほうがメリットが大きいです。


