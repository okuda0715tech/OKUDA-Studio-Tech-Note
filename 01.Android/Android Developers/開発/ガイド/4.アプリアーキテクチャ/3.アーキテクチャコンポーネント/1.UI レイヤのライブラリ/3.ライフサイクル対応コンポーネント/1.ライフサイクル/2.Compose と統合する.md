- [Compose と統合する](#compose-と統合する)


# Lifecycle を Compose と統合する

Lifecycle ライブラリには、Jetpack Compose との統合を可能にする組み込み API が用意されています。主な API は次のとおりです。

- 現在の `Lifecycle.State` のフロー。
- `LifecycleEffects` : 特定の `Lifecycle.Event` に基づいてブロックを実行できます。

これらの統合は、 Compose 階層内で Lifecycle を管理する便利なフックを提供します。このドキュメントでは、アプリでこれを使用する方法について説明します。

注: このドキュメントで説明する API は、 Lifecycle バージョン 2.7.0 で導入されました。


## フローでライフサイクルの状態を収集する

Lifecycle は、現在の Lifecycle.State を Kotlin StateFlow として提供する currentStateFlow プロパティを公開します。この Flow は State として収集できます。これにより、アプリは作成中に Lifecycle の変更を読み取ることができます。

```kotlin
// Composable がホストされている Fragment or Activity の
// 現在の LifecycleOwner を取得します。
val lifecycleOwner = LocalLifecycleOwner.current
val stateFlow = lifecycleOwner.lifecycle.currentStateFlow
…
val currentLifecycleState by stateFlow.collectAsState()

// 上記の処理は、下記のようにしてより簡潔に記述することが可能です。
// どちらの記述方法でも同じ動作をします。
val lifecycleOwner = LocalLifecycleOwner.current
val currentLifecycleState = lifecycleOwner.lifecycle.currentStateAsState()
```

LocalLifecycleOwner.current は、そのコンポーザブルが Activity 内で使用されていれば、 Activity の LifecycleOwner を返し、 Fragment 内で使用されていれば、 Fragment の LifecycleOwner を返します。

**Activity 内で使用されている場合**

```kotlin
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            MyComposable()
        }
    }
}

```


**Fragment 内で使用されている場合**

```kotlin
class MyFragment : Fragment() {
    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        return ComposeView(requireContext()).apply {
            setContent {
                MyComposable()
            }
        }
    }
}
```


## ライフサイクルイベントでコードを実行する

また、特定の Lifecycle.Event が発生したときにブロックを実行できるようにする LifecycleEffects もあります。

```kotlin
LifecycleEventEffect(Lifecycle.Event.ON_START) {
    // do something here
}
```

**警告** : これを使用して Lifecycle.Event.ON_DESTROY のリッスンを行うことはできません。なぜなら、 ON_STOP イベントを受け取った後、 Compose は再コンポーズを停止するため、 ON_DESTROY イベントを受け取ることがないためです。

この関数は、コールバックデータを MutableState の Lifecycle.State として保存することにより、コールバックイベントに応答してタスクを起動するためにも使用しないでください。代わりに、currentStateAsState を参照して、状態の変更に応答してジョブを起動するために使用できる State を取得してください。

LifecycleEventEffect に加えて、LifecycleStartEffect と LifecycleResumeEffect を使用することもできます。これらの API は、特定のイベントに関連付けられています。また、プライマリ ブロック内に追加のブロックがあり、イベントが発生した可能性のあるコードをクリーンアップするのに役立ちます。


### LifecycleStartEffect

LifecycleStartEffect は LifecycleEffect と似ていますが、Lifecycle.Event.ON_START イベントでのみ実行されます。また、他の Compose と同様にキーも受け入れます。キーが変更されると、ブロックの再実行がトリガーされます。

Lifecycle.Event.ON_STOP イベントが発生するか、作用がコンポジションを終了すると、onStopOrDispose ブロックが実行されます。これにより、開始ブロックに含まれていた作業をクリーンアップできます。

```kotlin
LifecycleStartEffect {
    // ON_START code is executed here

    onStopOrDispose {
        // do any needed clean up here
    }
}
```

注: onStopOrDispose ブロックは常に必須です。不要な場合は、LifecycleEffect を使用して Lifecycle.Event.ON_START イベントを渡します。


### LifecycleResumeEffect

LifecycleResumeEffect は LifecycleStartedEffect と同じように動作しますが、代わりに Lifecycle.Event.ON_RESUME イベントで実行されます。また、クリーンアップを行う onPauseOrDispose ブロックも用意されています。

```kotlin
LifecycleResumeEffect {
    // ON_RESUME code is executed here

    onPauseOrDispose {
        // do any needed clean up here
    }
}
```
