- [デスティネーションへのディープリンクを作成する](#デスティネーションへのディープリンクを作成する)
  - [Compose でディープリンクを実装する方法](#compose-でディープリンクを実装する方法)
  - [Android View でディープリンクを実装する方法](#android-view-でディープリンクを実装する方法)
    - [明示的ディープリンクを作成する](#明示的ディープリンクを作成する)
    - [暗黙的ディープリンクを作成する](#暗黙的ディープリンクを作成する)
    - [ディープリンクの処理](#ディープリンクの処理)


# デスティネーションへのディープリンクを作成する

Android では、アプリ内の特定のデスティネーションにユーザーを直接誘導するリンクを、ディープリンクと呼びます。

**ユーザーが明示的ディープリンクを通じてアプリを開くと、タスク バックスタックがクリアされ、ディープリンク デスティネーションに置き換えられます。**

**[グラフをネスト](./4.ネストされたグラフ.md) している場合は、各ネストレベルの開始デスティネーションもスタックに追加されます。** そのため、ユーザーがディープリンク デスティネーションから [戻る] ボタンを押すと、アプリにそのエントリ ポイントからアクセスしたかのようにナビゲーション スタックを戻ることができます。


## Compose でディープリンクを実装する方法

Compose でディープリンクを実装する方法は、 [こちら](../../../../../主要分野/UI/ガイド/2.UIアーキテクチャ/8.ナビゲーション.md/#ディープリンク) を参照してください。


## Android View でディープリンクを実装する方法

Android View では、 Navigation コンポーネントを使用すると、「明示的」と「暗黙的」という 2 種類のディープリンクを作成できます。


### 明示的ディープリンクを作成する

[明示的ディープリンク](https://developer.android.com/training/app-links/deep-linking?hl=ja&_gl=1*ylw41e*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczMzc5NDczMy4yLjAuMTczMzc5NDczMy4wLjAuNTg5MDkxMTY3) は、 [PendingIntent](https://developer.android.com/reference/android/app/PendingIntent?hl=ja&_gl=1*1sxinrw*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczMzc5NDczMy4yLjAuMTczMzc5NDczMy4wLjAuNTg5MDkxMTY3) を使用して、アプリ内の特定の場所にユーザーを誘導するディープリンクの単一インスタンスです。たとえば、通知やアプリ ウィジェットの一部として明示的ディープリンクを表示できます。

以下の例に示すように、NavDeepLinkBuilder クラスを使用して、PendingIntent を作成できます。指定されたコンテキストが Activity でない場合、コンストラクタは、起動するデフォルト アクティビティとして (利用可能な場合は) PackageManager.getLaunchIntentForPackage() を使用します。

```kotlin
val pendingIntent = NavDeepLinkBuilder(context)
    .setGraph(R.navigation.nav_graph)
    .setDestination(R.id.android)
    .setArguments(args)
    .createPendingIntent()
```

デフォルトでは、NavDeepLinkBuilder はアプリのマニフェストに宣言されたデフォルト起動 Activity への明示的ディープリンクを起動します。NavHost が別のアクティビティにある場合は、ディープリンク ビルダーを作成する際に、次のようにしてそのコンポーネント名を指定する必要があります。

```kotlin
val pendingIntent = NavDeepLinkBuilder(context)
    .setGraph(R.navigation.nav_graph)
    .setDestination(R.id.android)
    .setArguments(args)
    .setComponentName(DestinationActivity::class.java)
    .createPendingIntent()
```

[ComponentName](https://developer.android.com/reference/android/content/ComponentName?_gl=1*1bemakw*_up*MQ..*_ga*MjE0Mzg5MDEyMy4xNzIzNjg5ODUz*_ga_6HH9YJMN9M*MTcyMzY4OTg1Mi4xLjAuMTcyMzY4OTg1Mi4wLjAuMA..) がある場合は、次のようにビルダーにそのまま渡すことができます。

```kotlin
val componentName = ...

val pendingIntent = NavDeepLinkBuilder(context)
    .setGraph(R.navigation.nav_graph)
    .setDestination(R.id.android)
    .setArguments(args)
    .setComponentName(componentName)
    .createPendingIntent()
```

既存の [NavController](https://developer.android.com/reference/androidx/navigation/NavController?hl=ja&_gl=1*1uphvh1*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczMzc5NDczMy4yLjAuMTczMzc5NDczMy4wLjAuNTg5MDkxMTY3) がある場合は、 [NavController.createDeepLink()](https://developer.android.com/reference/androidx/navigation/NavController?hl=ja&_gl=1*1uphvh1*_up*MQ..*_ga*MTU0NjM2NDc1Mi4xNzMzNzkyNDc4*_ga_6HH9YJMN9M*MTczMzc5NDczMy4yLjAuMTczMzc5NDczMy4wLjAuNTg5MDkxMTY3#createDeepLink()) を使用してディープリンクを作成することもできます。

注意: この API を使用すると、画面が暗黙的ディープリンクをサポートしていなくても、アプリで任意の画面にディープリンクできます。該当の画面にディープリンクを経由して到達した場合に、 [条件付きナビゲーション](https://developer.android.com/guide/navigation/use-graph/conditional?hl=ja&_gl=1*1pu3qpe*_up*MQ..*_ga*MjE0Mzg5MDEyMy4xNzIzNjg5ODUz*_ga_6HH9YJMN9M*MTcyMzY4OTg1Mi4xLjAuMTcyMzY4OTg1Mi4wLjAuMA..) ページに記載されている手順に沿って、条件に応じてログインが必要な画面に、ユーザーがリダイレクトされるようにする必要があります。


### 暗黙的ディープリンクを作成する

暗黙的ディープリンクは、アプリ内の特定のデスティネーションを参照します。ディープリンクが呼び出されると（たとえばユーザーがリンクをタップしたとき）、Android は対応するデスティネーションでアプリを開くことができます。

ディープリンクは、URI、インテント アクション、MIME タイプによってマッチングできます。単一のディープリンクに対して複数のマッチタイプを指定できますが、マッチングの優先順位は URI 引数、アクション、MIME タイプの順になります。

URI、アクション、 MIME タイプを含むディープリンクの例を次に示します。

```xml
<fragment android:id="@+id/a"
    android:name="com.example.myapplication.FragmentA"
    tools:layout="@layout/a">
    
    <deepLink app:uri="www.example.com"
        app:action="android.intent.action.MY_ACTION"
        app:mimeType="type/subtype"/>

</fragment>
```

Navigation Editor を使用して、デスティネーションへの暗黙的ディープリンクを作成することもできます。手順は次のとおりです。

1. Navigation Editor の [Design] タブで、ディープリンクのデスティネーションを選択します。

2. [Attributes] パネルの [Deep Links] セクションで、[+] をクリックします。

3. 表示された [Add Deep Link] ダイアログで、ディープリンクの情報を入力します。

次の点に注意してください。

- スキーマのない URI は、http または https のいずれかと見なされます。たとえば、www.google.com は http://www.google.com と https://www.google.com の両方に一致します。
- {placeholder_name} 形式のパスパラメータ プレースホルダは、1 つ以上の文字に一致します。たとえば、http://www.example.com/users/{id} は http://www.example.com/users/4 に一致します。Navigation コンポーネントは、プレースホルダ名を、ディープリンク デスティネーション用に定義された引数とマッチングすることにより、プレースホルダ値を解析して適切な型に解決しようと試みます。同じ名前を持つ引数が定義されていない場合は、デフォルトの String 型が引数の値に使用されます。ワイルドカード「.*」を使用すると、0 個以上の文字に一致させることができます。
- クエリ パラメータ プレースホルダは、パスパラメータの代わりに使用することも、パスパラメータと一緒に使用することもできます。たとえば、http://www.example.com/users/{id}?myarg={myarg} は http://www.example.com/users/4?myarg=28 に一致します。
- デフォルト値または null 許容値で定義された変数のクエリ パラメータ プレースホルダは、マッチングが不要です。たとえば、http://www.example.com/users/{id}?arg1={arg1}&arg2={arg2} は http://www.example.com/users/4?arg2=28 または http://www.example.com/users/4?arg1=7 と一致します。この点がパスパラメータと異なります。たとえば、http://www.example.com/users?arg1=7&arg2=28 は、必須のパスパラメータが指定されていないため、上記のパターンに一致しません。
- 追加のクエリ パラメータは、ディープリンク URI のマッチングには影響しません。たとえば、extraneousParam が URI パターンで定義されていなくても、http://www.example.com/users/{id} は http://www.example.com/users/4?extraneousParam=7 に一致します。

4. （省略可）自分が URI のオーナーであることが必ず Google によって検証されるようにするには、[Auto Verify] チェックボックスをオンにします。詳しくは、Android アプリリンクを検証するをご覧ください。

5. [Add] をクリックします。選択したデスティネーションの上にリンクアイコン  が表示され、そのデスティネーションがディープリンクを持つことが示されます。

6. [Code] タブをクリックして、XML ビューに切り替えます。ネストされた `<deepLink>` 要素がデスティネーションに追加されています。

```xml
<deepLink app:uri="https://www.google.com" />
```

暗黙的ディープリンクを有効にするには、アプリの manifest.xml ファイルに要素を追加する必要もあります。既存のナビゲーション グラフをポイントするアクティビティに対して、単一の <nav-graph> 要素を追加します。次の例をご覧ください。

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.myapplication">

    <application ... >

        <activity name=".MainActivity" ...>
            ...

            <nav-graph android:value="@navigation/nav_graph" />

            ...

        </activity>
    </application>
</manifest>
```

プロジェクトをビルドする際、Navigation コンポーネントは、<nav-graph> 要素を生成された <intent-filter> 要素に置き換えて、ナビゲーション グラフ内のすべてのディープリンクに一致するようにします。

暗黙的ディープリンクをトリガーする場合、暗黙的 Intent を Intent.FLAG_ACTIVITY_NEW_TASK フラグ付きで起動したかどうかによって、バックスタックの状態が変わります。

フラグがセットされている場合、タスク バックスタックはクリアされ、ディープリンク デスティネーションに置き換えられます。明示的ディープリンクと同様、グラフをネストしている場合は、各ネストレベルの開始デスティネーション（つまり、階層内の各 <navigation> 要素の開始デスティネーション）もスタックに追加されます。そのため、ユーザーがディープリンク デスティネーションから [戻る] ボタンを押すと、アプリにそのエントリ ポイントからアクセスしたかのようにナビゲーション スタックを戻ることができます。
フラグがセットされていない場合、ユーザーは、暗黙的ディープリンクをトリガーした元のアプリのタスクスタック上にとどまります。この場合、[戻る] ボタンを押すと前のアプリに戻り、[上へ] ボタンを押すと、ナビゲーション グラフ階層内の親デスティネーション上にあるアプリのタスクが開始されます。


### ディープリンクの処理

Navigation を使用する際は、常にデフォルトの standard launchMode を使用することを強くおすすめします。standard 起動モードを使用すると、Navigation は Intent 内の明示的・暗黙的ディープリンクを処理する handleDeepLink() を呼び出して、ディープリンクを自動的に処理します。しかし、singleTop など別の launchMode を使用すると、Activity が再使用された際に自動的に処理されません。その場合は、次の例に示すように、onNewIntent() で handleDeepLink() を手動で呼び出す必要があります。

```kotlin
override fun onNewIntent(intent: Intent?) {
    super.onNewIntent(intent)
    navController.handleDeepLink(intent)
}
```





