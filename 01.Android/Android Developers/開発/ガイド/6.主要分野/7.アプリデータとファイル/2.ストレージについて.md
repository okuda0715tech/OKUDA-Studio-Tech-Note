- [データストレージとファイルストレージの概要](#データストレージとファイルストレージの概要)
  - [保存場所の種類](#保存場所の種類)
    - [アプリのインストール場所を外部ストレージにする方法](#アプリのインストール場所を外部ストレージにする方法)
  - [外部ストレージに対する権限とアクセス](#外部ストレージに対する権限とアクセス)
    - [対象範囲別ストレージ](#対象範囲別ストレージ)
  - [デバイス上のファイルを表示する](#デバイス上のファイルを表示する)
  - [参考情報](#参考情報)
    - [動画](#動画)
  - [引用元資料](#引用元資料)


# データストレージとファイルストレージの概要

Android は、他のプラットフォームと同様のディスクベースファイルシステムを使用しています。アプリには、データの保存方法として、次のような選択肢が用意されています。

- **アプリ固有のストレージ**
  - アプリ専用のファイルを保存します。
  - 内部ストレージと外部ストレージに、それぞれ専用のディレクトリが用意されています。
  - 他のアプリがアクセスすべきでない機密情報の保存には、内部ストレージを使用します。
- **共有ストレージ**
  - メディアやドキュメントなど、アプリが他のアプリと共有するファイルを保存します。
- **プリファレンス**
  - 非公開のプリミティブデータを Key-Value ペアで保存します。
- **データベース**
  - Room 永続ライブラリを使用して、構造化データを非公開のデータベースに保存します。

これらの選択肢の特徴を表にまとめたものは、 [公式ドキュメント](https://developer.android.com/training/data-storage?hl=ja&_gl=1*12qy47f*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..) を参照してください。

選択するソリューションは、次のようなニーズによって異なります。

**1. データに必要な容量**

内部ストレージのアプリ固有データ用のスペースは限られています。大量のデータを保存する必要がある場合は、他の種類のストレージを使用します。 (ただし、近年のデバイスは、内部ストレージが充実している場合が多いため、大量のデータも内部ストレージで保存することが一般的だと思われます。)


**2. データアクセスの信頼性**

アプリの起動時など、アプリの基本機能に特定のデータが必要な場合は、内部ストレージのディレクトリ、または、データベースに保存します。 **外部ストレージに保存されているアプリ固有のファイルは、外部ストレージの物理デバイスをユーザーが取り外すことができるため、常にアクセスできるわけではありません。**


**3. 保存する必要があるデータの種類**

自分のアプリにとってだけ意味のあるデータには、アプリ固有のストレージを使用します。共有可能なメディアコンテンツには、他のアプリがコンテンツにアクセスできるように、共有ストレージを使用します。

構造化データには、 Key-Value データの場合にはプリファレンスを使用し、 2 列以上のデータの場合には、データベースを使用します。


**4. データを非公開にする必要性**

他のアプリからアクセスできてはいけない機密データを保存する場合は、内部ストレージ、プリファレンス、または、データベースを使用します。内部ストレージには、保存されたデータをユーザーが直接閲覧できないというメリットもあります。


## 保存場所の種類

Android には、内部ストレージと外部ストレージという、2 種類の物理的な保存場所があります。ほとんどのデバイスで、内部ストレージの容量は外部ストレージよりも少なくなっています。ただし、内部ストレージは常にすべてのデバイスで利用できるため、アプリにとって重要なデータを保存する場所としては、より信頼性が高い場所です。

SD カードなどのリムーバブルボリュームは、外部ストレージの一部としてファイルシステムの中に現れます。 Android では、こういったデバイスを `/sdcard/` のようなパスを使用して表します。

**注意**:

- ファイルの正確な保存場所は、デバイスによって異なる場合があります。このため、ハードコードされたファイルパスは使用しないでください。
- ユーザーによる偶発的なデータの検出を避けるため、ファイル名に予測可能なパターンを使用しないでください。


### アプリのインストール場所を外部ストレージにする方法

アプリ自体はデフォルトで内部ストレージにインストールされます。ただし、 APK のサイズが非常に大きい場合は、次のようにアプリのマニフェストファイルで設定を指定して、アプリを外部ストレージにインストールさせることができます。

```xml
<manifest
  android:installLocation="preferExternal"> 
</manifest>
```


## 外部ストレージに対する権限とアクセス

Android では、ストレージ関連の権限として [READ_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja&_gl=1*11i4ib3*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..#READ_EXTERNAL_STORAGE) , [WRITE_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja&_gl=1*11i4ib3*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..#WRITE_EXTERNAL_STORAGE) , [MANAGE_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja&_gl=1*13xtrok*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..#MANAGE_EXTERNAL_STORAGE) が定義されています。

以前のバージョンの Android では、 「外部ストレージ ( `/storage/emulated/0/` ) 内で、アプリ固有のディレクトリ ( `/storage/emulated/0/Android/data/<my-package-name>/` ) の外 (※ 1 ) 」 にあるファイルを参照するには、 READ_EXTERNAL_STORAGE 権限を宣言する必要がありました。また、同様に、ファイルに書き込むには、 WRITE_EXTERNAL_STORAGE 権限を宣言する必要がありました。

(※ 1 ) つまり、 `/storage/emulated/0/Documents/` などへのアクセスのこと

新しいバージョンの Android では、 **アプリのファイルへのアクセス権と書き込み権を判断するにあたって、ファイルの場所よりも用途を重視します。** 特に、Android 11（API レベル 30）以降をターゲットとするアプリの場合、 WRITE_EXTERNAL_STORAGE 権限は、アプリのストレージへのアクセスに影響しません。このような用途に基づいたストレージモデルでは、アプリが実際に使用する領域のみにアクセス可能なため、ユーザーのプライバシーが向上します。

Android 11 では、 MANAGE_EXTERNAL_STORAGE 権限が導入されています。これは、アプリ固有のディレクトリと MediaStore の外にあるファイルへの書き込みを可能にします。ただし、この権限は、ほとんどのアプリが宣言する必要はありません。その理由と権限の詳細については、ストレージデバイスの [すべてのファイルを管理する](./5.ストレージデバイスのすべてのファイルを管理する.md) 方法に関するガイドをご覧ください。


### 対象範囲別ストレージ

ユーザーがファイルをきめ細かく管理して整理できるように、Android 10（API レベル 29）以降をターゲットとするアプリには、外部ストレージに対する限定的なアクセス権がデフォルトで付与されます（そのようなストレージを対象範囲別ストレージと呼びます）。このようなアプリでアクセスできるのは、外部ストレージにあるアプリ固有のディレクトリと、そのアプリが作成した特定の種類のメディアだけです。

**注** : アプリが実行時にストレージ関連の権限をリクエストした場合、たとえ、対象範囲別ストレージが有効になっていても、ユーザーには、ダイアログで、「アプリが幅広い外部ストレージへのアクセスをリクエストしている」ことが示されます。

対象範囲別ストレージを使用しなくても良いのは、アクセスしたいファイルの存在する場所が、以下の場合のみです。

- ファイルが [アプリ固有のディレクトリ](./3.アプリ固有のストレージに保存する.md) の外に存在する
- かつ
- ファイルが [MediaStore](https://developer.android.com/reference/android/provider/MediaStore?hl=ja&_gl=1*19jgd5d*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..) API でアクセスできないディレクトリに存在する

アプリ固有のファイルを外部ストレージに保存する場合は、 [外部ストレージのアプリ固有のディレクトリ](./3.アプリ固有のストレージに保存する.md/#外部ストレージにアクセスする) ( `/storage/emulated/0/Android/data/<my-package-name>/` ) に配置することで、対象範囲別ストレージの導入が容易になります。

対象範囲別ストレージが有効なとき、アプリでアプリ固有のファイルへのアクセス権を管理します。

アプリを対象範囲別ストレージに対応させるには、 [ストレージのユースケースとおすすめの方法](./8.ストレージのユースケースとベストプラクティス.md)  ( [引用元](https://developer.android.com/training/data-storage/use-cases?hl=ja&_gl=1*1rzg3xr*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..) ) に関するガイドをご覧ください。もし、上記の参考資料の方法では、対象範囲別ストレージを適用できない場合は、 [機能リクエストを提出](https://source.android.com/setup/contribute/report-bugs?hl=ja) してください。 [対象範囲別ストレージの使用を一時的にオプトアウト](./8.ストレージのユースケースとベストプラクティス.md/#対象範囲別ストレージを一時的にオプトアウトする) できます。


## デバイス上のファイルを表示する

デバイスに保存されているファイルを表示するには、Android Studio の [Device File Explorer](https://developer.android.com/studio/debug/device-file-explorer?_gl=1*1kxhu6g*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..) を使用します。


## 参考情報

データストレージの詳細については、次のリソースをご覧ください。


### 動画

[対象範囲別ストレージの準備（Android Dev Summit '19）](https://www.youtube.com/watch?v=UnJ3amzJM94&hl=ja)


## 引用元資料

- [データストレージとファイルストレージの概要](https://developer.android.com/training/data-storage?hl=ja)


