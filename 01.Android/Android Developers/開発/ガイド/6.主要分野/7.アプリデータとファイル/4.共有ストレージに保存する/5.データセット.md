- [共有データセットにアクセスする](#共有データセットにアクセスする)
  - [共有データ blob にアクセスする](#共有データ-blob-にアクセスする)
    - [データセットが利用できる場合](#データセットが利用できる場合)
    - [データセットが利用できない場合](#データセットが利用できない場合)


まず、このドキュメントを学習する前に考えたいこと

- BlobStoreManager はどのような機能か？
  - BlobStoreManager は、他のアプリと共有したいバイナリデータを、キャッシュとして一時的に保存する機能です。
    - 他のアプリと共有
      - 内部ストレージのキャッシュ ( getCacheDir() ) では、ファイルの共有ができないため、キャッシュを共有するには BlobStoreManager が必要です。
    - キャッシュとして保存
      - キャッシュとして保存するため、そのデータの作成、更新、削除などは、ユーザーが行うのではなく、アプリや OS が行います。
      - そのため、ユーザーが明示的に管理するデータではないデータを管理するための機能です。
- BlobStoreManager はどのような用途で使用するのか？
  - AI モデルを保存
  - 動画のストリーミングデータを保存
- 今後、 BlobStoreManager を使用する可能性があるのか？
  - 上記の用途に記載したようなアプリを作成する場合には、使用する可能性があります。


# 共有データセットにアクセスする

Android 11（API レベル 30）より、複数のアプリが機械学習、メディア再生などのユースケースのためにアクセスする可能性がある大容量のデータセットは、システムによってキャッシュに保存され、ネットワーク上とディスク上の両方でデータの冗長性が軽減されます。

こうした大規模な共有データセットにアプリがアクセスする必要がある場合、新しいコピーをダウンロードするかどうかを判断する前に、「共有データ blob」と呼ばれる、キャッシュに保存されたデータセットをまず探すことができます。アプリは、 [BlobStoreManager](https://developer.android.com/reference/android/app/blob/BlobStoreManager?hl=ja&_gl=1*13gansc*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..) 内の API を使用して、これらの共有データセット機能にアクセスできます。

システムが共有データ blob を保持し、どのアプリがそれにアクセスできるかを管理します。アプリがデータ blob を提供する際、以下のいずれかのメソッドを呼び出して、他にどのアプリがアクセス権を持つかを指定できます。

- デバイス上の特定のアプリのセットにアクセス権を付与するには、それらのアプリのパッケージ名を [allowPackageAccess()](https://developer.android.com/reference/android/app/blob/BlobStoreManager.Session?hl=ja&_gl=1*13gansc*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..#allowPackageAccess(java.lang.String,%20byte%5B%5D)) に渡します。
- 自分のアプリに使用する鍵と同じ鍵で署名された証明書を持つアプリ（自分が管理するアプリスイートなど）にのみアクセスを許可する場合は、 [allowSameSignatureAccess()](https://developer.android.com/reference/android/app/blob/BlobStoreManager.Session?hl=ja&_gl=1*1veiuo5*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..#allowSameSignatureAccess()) を呼び出します。
- デバイス上のすべてのアプリにアクセス権を付与するには、 [allowPublicAccess()](https://developer.android.com/reference/android/app/blob/BlobStoreManager.Session?hl=ja&_gl=1*1veiuo5*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..#allowPublicAccess()) を呼び出します。


## 共有データ blob にアクセスする

システムは各共有データ blob を [BlobHandle](https://developer.android.com/reference/android/app/blob/BlobHandle?hl=ja&_gl=1*1vb8g9c*_up*MQ..*_ga*MjI0NTM2NDk1LjE3MjI3NDg4Mzc.*_ga_6HH9YJMN9M*MTcyMjc0ODgzNy4xLjAuMTcyMjc0ODgzNy4wLjAuMA..) オブジェクトを使って表します。 BlobHandle の各インスタンスには、データのハッシュ値と、ラベルなどのデータセットを識別できる情報が含まれます。

共有データ blob にアクセスするには、サーバーから識別情報をダウンロードします。この情報を使って、データセットがシステムですでに利用可能かどうかを確認します。

次のステップは、データが利用可能かどうかによって異なります。


### データセットが利用できる場合

データセットがそのデバイス上ですでに利用できる場合は、次のコード スニペットに示すように、システムからアクセスします。

```kotlin
val blobStoreManager =
        getSystemService(Context.BLOB_STORE_SERVICE) as BlobStoreManager
// The label "Sample photos" is visible to the user.
val blobHandle = BlobHandle.createWithSha256(/* sha256DigestBytes */,
        "Sample photos",
        System.currentTimeMillis() + TimeUnit.DAYS.toMillis(1),
        "photoTrainingDataset")
try {
    val input = ParcelFileDescriptor.AutoCloseInputStream(
            blobStoreManager.openBlob(blobHandle))
    // Dataset を使用した処理を行う独自の関数
    useDataset(input)
}
```


### データセットが利用できない場合

データセットが利用できない場合は、次のコード スニペットに示すように、サーバーからデータセットをダウンロードして、システムに提供します。

```kotlin
val sessionId = blobStoreManager.createSession(blobHandle)
try {
    val session = blobStoreManager.openSession(sessionId)
    try {
        // For this example, write 200 MiB at the beginning of the file.
        val output = ParcelFileDescriptor.AutoCloseOutputStream(
                session.openWrite(0, 1024 * 1024 * 200))
        writeDataset(output)

        session.apply {
            allowSameSignatureAccess()
            allowPackageAccess(your-app-package,
                    app-certificate)
            allowPackageAccess(some-other-app-package,
                    app-certificate)
            commit(mainExecutor, callback)
        }
    }
}
```

