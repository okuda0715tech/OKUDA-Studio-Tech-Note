- [共有ファイルのリクエスト](#共有ファイルのリクエスト)
  - [ファイルのリクエストを送信する](#ファイルのリクエストを送信する)
  - [リクエストされたファイルにアクセスする](#リクエストされたファイルにアクセスする)
  - [引用元資料](#引用元資料)


# 共有ファイルのリクエスト

あるアプリが共有しているファイルに、別のアプリがアクセスする場合、リクエスト側のアプリ（クライアント）は、通常、ファイルを共有しているアプリにリクエストを送信します。通常はこのリクエストによって、共有ファイルを保持しているサーバーアプリで Activity が開始されます。ユーザーがファイルを選択すると、サーバーアプリがファイルのコンテンツ URI をクライアントアプリに返します。

このレッスンでは、クライアントアプリがサーバーアプリにファイルをリクエストします。その後、サーバーアプリがファイルのコンテンツ URI をクライアントアプリへ返し、そのコンテンツ URI を使用してファイルを開く方法を説明します。


## ファイルのリクエストを送信する

サーバーアプリにファイルをリクエストするために、クライアントアプリは [ACTION_PICK](https://developer.android.com/reference/android/content/Intent?hl=ja#ACTION_PICK) などのアクションを含む Intent と、そのクライアントアプリが処理できる MIME タイプを使用して [startActivityForResult](https://developer.android.com/reference/android/app/Activity?hl=ja#startActivityForResult(android.content.Intent,%20int)) を呼び出します。

たとえば、次のコードスニペットは、 [ファイルの共有](./3.ファイルの共有.md) で説明されているサーバーアプリの Activity を開始するために、クライアントアプリが、サーバーアプリの Activity を Intent で開始する方法を示しています。

```kotlin
// クライアントアプリの Activity
class MainActivity : Activity() {
    private lateinit var requestFileIntent: Intent
    private lateinit var inputPFD: ParcelFileDescriptor
    ...
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        requestFileIntent = Intent(Intent.ACTION_PICK).apply {
            type = "image/jpg"
        }
        ...
    }
    ...
    private fun requestFile() {
        /**
         * ユーザーがファイルをリクエストした時、
         * サーバーアプリに対して Intent を送信します。
         */
        startActivityForResult(requestFileIntent, 0)
        ...
    }
    ...
}
```


## リクエストされたファイルにアクセスする

サーバーアプリは、ファイルのコンテンツ URI を Intent でクライアントアプリに送り返します。この Intent は、 [onActivityResult()](https://developer.android.com/reference/android/app/Activity?hl=ja#onActivityResult(int,%20int,%20android.content.Intent)) のオーバーライドでクライアントアプリに渡されます。ファイルのコンテンツ URI を取得したクライアントアプリは、ファイルにアクセスするためにそのファイルの [FileDescriptor](https://developer.android.com/reference/java/io/FileDescriptor?hl=ja) を取得します。

このプロセスでファイルのセキュリティが確保されるのは、クライアントアプリが受け取るコンテンツ URI を適切に解析した場合に限られます。コンテンツを解析する際は、この URI が目的のディレクトリの外部を指していないことを確認して、 [パストラバーサル](https://developer.android.com/privacy-and-security/risks/path-traversal?hl=ja) が試行されないようにする必要があります。ファイルにアクセスできるのは、サーバーアプリによって権限を付与されたクライアントアプリだけです。権限は一時的なものであるため、クライアントアプリのタスクスタックが終了すると、サーバーアプリの外からファイルにアクセスすることはできなくなります。

次のスニペットは、クライアントアプリがサーバーアプリから送信された Intent を処理する方法と、クライアントアプリがコンテンツ URI を使用して FileDescriptor を取得する方法を示しています。

```kotlin
/*
 * When the Activity of the app that hosts files sets a result and calls
 * finish(), this method is invoked. The returned Intent contains the
 * content URI of a selected file. The result code indicates if the
 * selection worked or not.
 * 
 */
public override fun onActivityResult(requestCode: Int, resultCode: Int, returnIntent: Intent) {
    // If the selection didn't work
    if (resultCode != Activity.RESULT_OK) {
        // Exit without doing anything else
        return
    }
    // Get the file's content URI from the incoming Intent
    returnIntent.data?.also { returnUri ->
        /*
         * Try to open the file for "read" access using the
         * returned URI. If the file isn't found, write to the
         * error log and return.
         */
        inputPFD = try {
            /*
             * Get the content resolver instance for this context, and use it
             * to get a ParcelFileDescriptor for the file.
             */
            contentResolver.openFileDescriptor(returnUri, "r")
        } catch (e: FileNotFoundException) {
            e.printStackTrace()
            Log.e("MainActivity", "File not found.")
            return
        }

        // Get a regular file descriptor for the file
        val fd = inputPFD.fileDescriptor
        ...
    }
}
```

メソッド [openFileDescriptor()](https://developer.android.com/reference/android/content/ContentResolver?hl=ja#openFileDescriptor(android.net.Uri,%20java.lang.String)) は、ファイルの [ParcelFileDescriptor](https://developer.android.com/reference/android/os/ParcelFileDescriptor?hl=ja) を返します。クライアント アプリは、このオブジェクトから [FileDescriptor](https://developer.android.com/reference/java/io/FileDescriptor?hl=ja) オブジェクトを取得し、これを使用してファイルを読み取ることができます。

openFileDescriptor() に関して、詳しくは、 [このあたり ( openOutputStream() 関数と openFileDescriptor() 関数の違い )](../4.共有ストレージに保存する/2.メディア.md/#openoutputstream-関数と-openfiledescriptor-関数の違い) を参照してください。

その他の関連情報については、以下をご覧ください。

- [インテントとインテントフィルタ](https://developer.android.com/guide/components/intents-filters?hl=ja)
- [プロバイダからデータを取得する](../12.コンテンツプロバイダ/2.コンテンツプロバイダの基本.md/#プロバイダからデータを取得する)


## 引用元資料

- [共有ファイルのリクエスト](https://developer.android.com/training/secure-file-sharing/request-file?hl=ja)

