- [Android ストレージのユースケースとおすすめの方法](#android-ストレージのユースケースとおすすめの方法)
  - [メディアファイルを処理する](#メディアファイルを処理する)
    - [複数の画像ファイル、または、動画ファイルを表示する](#複数の画像ファイルまたは動画ファイルを表示する)
    - [特定のフォルダの画像、または、動画を表示する](#特定のフォルダの画像または動画を表示する)
    - [写真から位置情報にアクセスする](#写真から位置情報にアクセスする)
    - [新規ダウンロードの保存先を定義する](#新規ダウンロードの保存先を定義する)
    - [ユーザーのメディアファイルをデバイスにエクスポートする](#ユーザーのメディアファイルをデバイスにエクスポートする)
    - [1 回の操作で複数のメディアファイルを変更または削除する](#1-回の操作で複数のメディアファイルを変更または削除する)
      - [Android 11 で動作するアプリ](#android-11-で動作するアプリ)
      - [Android 10 で動作するアプリ](#android-10-で動作するアプリ)
      - [Android 9 以前で動作するアプリ](#android-9-以前で動作するアプリ)
    - [既存の単一の画像を読み込む](#既存の単一の画像を読み込む)
      - [独自のユーザーインターフェースを表示する](#独自のユーザーインターフェースを表示する)
      - [システムの選択ツールを使用する](#システムの選択ツールを使用する)
    - [単一の画像をキャプチャする](#単一の画像をキャプチャする)
    - [メディアファイルを他のアプリと共有する](#メディアファイルを他のアプリと共有する)
    - [メディアファイルを特定のアプリと共有する](#メディアファイルを特定のアプリと共有する)
    - [直接ファイルパスを使用する「コード」または「ライブラリ」からファイルにアクセスする](#直接ファイルパスを使用するコードまたはライブラリからファイルにアクセスする)
      - [Android 11 で動作するアプリ](#android-11-で動作するアプリ-1)
      - [Android 10 で動作するアプリ](#android-10-で動作するアプリ-1)
      - [Android 9 以前で動作するアプリ](#android-9-以前で動作するアプリ-1)
  - [メディア以外のファイルを処理する](#メディア以外のファイルを処理する)
    - [ドキュメント ファイルを開く](#ドキュメント-ファイルを開く)
    - [セカンダリストレージボリューム上のファイルに書き込む](#セカンダリストレージボリューム上のファイルに書き込む)
      - [Android 11 で動作するアプリ](#android-11-で動作するアプリ-2)
      - [以前のバージョンで動作するアプリ](#以前のバージョンで動作するアプリ)
    - [以前の保存先から既存のファイルを移行する](#以前の保存先から既存のファイルを移行する)
      - [データ移行のために以前の保存先へのアクセス権を維持する](#データ移行のために以前の保存先へのアクセス権を維持する)
        - [Android 11 をターゲットとするアプリの場合](#android-11-をターゲットとするアプリの場合)
        - [Android 10 をターゲットとするアプリの場合](#android-10-をターゲットとするアプリの場合)
      - [アプリデータを移行する](#アプリデータを移行する)
    - [コンテンツを他のアプリと共有する](#コンテンツを他のアプリと共有する)
    - [メディア以外のファイルをキャッシュに保存する](#メディア以外のファイルをキャッシュに保存する)
    - [メディア以外のファイルをデバイスにエクスポートする](#メディア以外のファイルをデバイスにエクスポートする)
  - [アプリ固有のファイルを処理する](#アプリ固有のファイルを処理する)
    - [内部ストレージディレクトリ](#内部ストレージディレクトリ)
    - [外部ストレージディレクトリ](#外部ストレージディレクトリ)
  - [対象範囲別ストレージを一時的にオプトアウトする](#対象範囲別ストレージを一時的にオプトアウトする)
    - [テストでオプトアウトする](#テストでオプトアウトする)
    - [製品版アプリでオプトアウトする](#製品版アプリでオプトアウトする)
  - [参考情報](#参考情報)
    - [ブログ投稿](#ブログ投稿)
  - [引用元資料](#引用元資料)


# Android ストレージのユースケースとおすすめの方法

ユーザーが、ファイルをより細かく制御して整理できるように、 Android 10 では、 [対象範囲別ストレージ](./2.ストレージについて.md/#対象範囲別ストレージ) という新しいアプリ用ストレージパラダイムが導入されました。対象範囲別ストレージは、アプリが、デバイスの外部ストレージ内のファイルにアクセスする方法を刷新します。対象範囲別ストレージをサポートするようにアプリを移行するには、このガイドで概説する一般的なストレージユースケースのおすすめの方法に従ってください。ユースケースは、 [メディアファイルの処理](#メディアファイルを処理する) と [メディア以外のファイルの処理](#メディア以外のファイルを処理する) という 2 つのカテゴリに分かれています。

多くの場合、自分のアプリが作成するファイルは、他のアプリがアクセスする必要のないファイル、または、アクセスすべきでないファイルです。システムには、このようなファイルを管理するための [アプリ固有の保存場所](#アプリ固有のファイルを処理する) が用意されています。

Android でファイルにアクセスする方法について詳しくは、 [ストレージのトレーニングガイド](./2.ストレージについて.md) ( [引用元](https://developer.android.com/training/data-storage?hl=ja) ) をご覧ください。


## メディアファイルを処理する

このセクションでは、メディアファイル（動画、画像、音声ファイル）を扱う一般的なユースケースと、あなたのアプリで使用できる高レベルアプローチについて説明します。そうした各ユースケースと、詳細を含む各セクションへのリンクを次の表にまとめます。

- 複数の画像ファイル、または、動画ファイルを表示する
  - Android のすべてのバージョンで同じ方法を使用します。
- 特定のフォルダの画像、または、動画を表示する
  - Android のすべてのバージョンで同じ方法を使用します。
- 写真から位置情報にアクセスする
  - アプリで対象範囲別ストレージを使用する場合は、1 つの方法を使用します。アプリで対象範囲別ストレージをオプトアウトしている場合は、別の方法を使用します。
- 新規ダウンロードの保存先を定義する
  - アプリで対象範囲別ストレージを使用する場合は、1 つの方法を使用します。アプリで対象範囲別ストレージをオプトアウトしている場合は、別の方法を使用します。
- ユーザーのメディアファイルをデバイスにエクスポートする
  - Android のすべてのバージョンで同じ方法を使用します。
- 1 回の操作で複数のメディアファイルを変更または削除する
  - Android 11 では 1 つの方法を使用します。Android 10 の場合は、対象範囲別ストレージをオプトアウトし、代わりに Android 9 以前の方法を使用します。
- 既存の単一の画像を読み込む
  - Android のすべてのバージョンで同じ方法を使用します。
- 単一の画像をキャプチャする
  - Android のすべてのバージョンで同じ方法を使用します。
- メディアファイルを他のアプリと共有する
  - Android のすべてのバージョンで同じ方法を使用します。
- メディアファイルを特定のアプリと共有する
  - Android のすべてのバージョンで同じ方法を使用します。
- 直接ファイルパスを使用するコードまたはライブラリからファイルにアクセスする
  - Android 11 では 1 つの方法を使用します。Android 10 の場合は、対象範囲別ストレージをオプトアウトし、代わりに Android 9 以前の方法を使用します。


### 複数の画像ファイル、または、動画ファイルを表示する

[contentResolver.query()](https://developer.android.com/reference/android/content/ContentResolver#query(android.net.Uri,%20java.lang.String[],%20android.os.Bundle,%20android.os.CancellationSignal)) API を使用して [メディアコレクションをクエリ](./4.共有ストレージに保存する/2.メディア.md/#メディアコレクションをクエリする) します。メディアファイルをフィルタするか並べ替えるには、projection、selection、selectionArgs、sortOrder パラメータを調整します。

contentResolver.query() メソッドで取得できるデータは、自分のアプリが作成したアプリのメタデータのみです。他のアプリが作成したファイルのメタデータも取得したい場合には、適切な権限 ( READ_EXTERNAL_STORAGE や READ_MEDIA_IMAGES など) が必要です。


### 特定のフォルダの画像、または、動画を表示する

次の方法を使用します。

1. [アプリの権限をリクエストする](https://developer.android.com/training/permissions/requesting?hl=ja) で概説されているおすすめの方法に沿って、 READ_EXTERNAL_STORAGE 権限をリクエストします。
2. ディスク上のメディアアイテムへの絶対ファイルシステムパスを含む [MediaColumns.DATA](https://developer.android.com/reference/kotlin/android/provider/MediaStore.MediaColumns?hl=ja#data) の値に基づいてメディアファイルを取得します。

**注** : 既存のメディアファイルを参照する場合は、アプリのロジックで [DATA](https://developer.android.com/reference/android/provider/MediaStore.MediaColumns?hl=ja#DATA) 列の値を使用できます。これは、この値に有効なファイルパスが含まれているためです。ただし、ファイルが常に使用可能であるとは限りません。ファイルベースの I/O エラーが発生した場合の処理を準備してください。

一方、メディアファイルを作成、または、更新する場合は、 DATA 列を使用しないでください。代わりに、 DISPLAY_NAME 列と RELATIVE_PATH 列を使用します。


### 写真から位置情報にアクセスする

対象範囲別ストレージを使用しているアプリでは、メディアストレージガイドの [写真の位置情報セクション](./4.共有ストレージに保存する/2.メディア.md/#写真) ([引用元](https://developer.android.com/training/data-storage/shared/media?hl=ja#location-info-photos)) の手順を実施します。

**注** : [共有ストレージからメディアファイルにアクセスする](./4.共有ストレージに保存する/2.メディア.md/#メディアの位置情報に関する権限) のページに記載されているように、 Android 10 以降をターゲットとするアプリが、 [MediaStore](https://developer.android.com/reference/android/provider/MediaStore) API を使用してアクセスした画像内の無編集の位置情報を読み取るには、 [ACCESS_MEDIA_LOCATION](https://developer.android.com/reference/android/Manifest.permission?hl=ja#ACCESS_MEDIA_LOCATION) 権限が必要です。


### 新規ダウンロードの保存先を定義する

対象範囲別ストレージを使用するアプリの場合、ダウンロードしたメディアファイルを保存する場所にも注意してください。

他のアプリがファイルにアクセスする必要がある場合は、ダウンロード用に [明確に定義されたメディアコレクション](https://developer.android.com/training/data-storage/shared/media?hl=ja#well-defined-collections) 、または、ドキュメントコレクションの使用を検討してください。

**注** : Android 11 以降では、ターゲット SDK レベルに関係なく、外部ストレージ上のアプリ固有のディレクトリ ( `/Android/data/<my-package-name>/` ) に保存されたファイルに対し、他のアプリからはアクセスできません。

Android 11 以降では、ファイルを取得するために [DownloadManager](https://developer.android.com/reference/android/app/DownloadManager?hl=ja) を使用しても、外部のアプリ固有のディレクトリ内にあるファイルにはアクセスできません。


### ユーザーのメディアファイルをデバイスにエクスポートする

(このセクションでは、アプリ固有のストレージから、共有ストレージへとデータをエクスポートするユースケースについての言及だと思われます。)

ユーザーのメディアファイルを保存するために、適切なデフォルトの場所を定義します。

- [アプリ固有のストレージ](./3.アプリ固有のストレージに保存する.md) 、または、 [共有ストレージ](./4.共有ストレージに保存する/2.メディア.md) を使用して、他のアプリでメディアファイルを読み取れるようにするかどうかを、ユーザーが選択できるようにします。
- ユーザーがファイルを [アプリ固有のディレクトリ](https://developer.android.com/reference/android/content/Context#getExternalFilesDirs(java.lang.String)) から一般的にアクセスしやすい場所にエクスポートできるようにします。 [MediaStore の画像、動画、音声のコレクション](https://developer.android.com/training/data-storage/shared/media?hl=ja#well-defined-collections) を使用して、メディアファイルをデバイスのギャラリーにエクスポートします。

注: わかりやすくするために、 [externalStoragePublicDirectory()](https://developer.android.com/reference/android/os/Environment?hl=ja#getExternalStoragePublicDirectory(java.lang.String)) や [externalMediaDirs()](https://developer.android.com/reference/android/content/Context?hl=ja#getExternalMediaDirs()) など、一般的にアクセスしやすい場所を使用してください。


### 1 回の操作で複数のメディアファイルを変更または削除する

アプリが動作する Android のバージョンに基づいてロジックを組み込みます。


#### Android 11 で動作するアプリ

次の方法を使用します。

1. [MediaStore.createWriteRequest()](https://developer.android.com/reference/android/provider/MediaStore?hl=ja#createWriteRequest(android.content.ContentResolver,%20java.util.Collection%3Candroid.net.Uri%3E)) 、または、 [MediaStore.createTrashRequest()](https://developer.android.com/reference/android/provider/MediaStore?hl=ja#createTrashRequest(android.content.ContentResolver,%20java.util.Collection%3Candroid.net.Uri%3E,%20boolean)) を使用して、アプリの書き込み、または、削除リクエストのペンディングインテントを作成してから、そのインテントを取得することで、一連のファイルを編集する権限をユーザーに求めます。
2. ユーザーのレスポンスを評価します。
  - 権限が付与されている場合は、変更、または、削除の操作を行います。
  - 権限が付与されていない場合は、アプリの機能に権限が必要な理由をユーザーに説明します。

上記のメソッドの使用方法は、 [メディアファイルのグループを管理する](./4.共有ストレージに保存する/2.メディア.md/#メディアファイルのグループを管理する一括操作) をご覧ください。


#### Android 10 で動作するアプリ

Android 10（ API レベル 29 ）をターゲットとするアプリの場合は、 [対象範囲別ストレージをオプトアウト](#対象範囲別ストレージを一時的にオプトアウトする) し、 Android 9 以前の方法を使用してこの操作を行います。


#### Android 9 以前で動作するアプリ

次の方法を使用します。

1. [アプリの権限をリクエストする](https://developer.android.com/training/permissions/requesting?hl=ja) で概説されているおすすめの方法に沿って、 [WRITE_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja#WRITE_EXTERNAL_STORAGE) 権限をリクエストします。
2. [MediaStore](https://developer.android.com/reference/android/provider/MediaStore?hl=ja) API を使用してメディアファイルを変更または削除します。


### 既存の単一の画像を読み込む

既存の単一の画像を読み込む場合（ユーザーのプロフィール写真として使用するなど）、アプリは操作に独自の UI を使用するか、システムの選択ツールを使用できます。


#### 独自のユーザーインターフェースを表示する

次の方法を使用します。

1. [アプリの権限をリクエストする](https://developer.android.com/training/permissions/requesting?hl=ja) で概説されているおすすめの方法に沿って、 [READ_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja#READ_EXTERNAL_STORAGE) 権限をリクエストします。
2. [query()](https://developer.android.com/reference/android/content/ContentResolver?hl=ja#query(android.net.Uri,%20java.lang.String%5B%5D,%20java.lang.String,%20java.lang.String%5B%5D,%20java.lang.String,%20android.os.CancellationSignal)) API を使用して、 [メディアコレクションをクエリ](https://developer.android.com/training/data-storage/shared/media?hl=ja#query-collection) します。
3. 結果をアプリのカスタム UI に表示します。


#### システムの選択ツールを使用する

読み込む画像を選択するようユーザーに求める [ACTION_GET_CONTENT](https://developer.android.com/reference/android/content/Intent?hl=ja#ACTION_GET_CONTENT) インテントを使用します。

システムの選択ツールでユーザーに提示して選択させる画像の種類をフィルタする場合は、 [setType()](https://developer.android.com/reference/android/content/Intent?hl=ja#setType(java.lang.String)) 、または、 [EXTRA_MIME_TYPES](https://developer.android.com/reference/android/content/Intent?hl=ja#EXTRA_MIME_TYPES) を使用できます。


### 単一の画像をキャプチャする

アプリで使用する単一の画像をキャプチャする場合（ユーザーのプロフィール写真として使用するなど）、 [ACTION_IMAGE_CAPTURE](https://developer.android.com/reference/android/provider/MediaStore?hl=ja#ACTION_IMAGE_CAPTURE) インテントを使用して、ユーザーに対し、デバイスのカメラを使用して写真を撮影するよう求めます。キャプチャされた写真は [MediaStore.Images](https://developer.android.com/reference/android/provider/MediaStore.Images?hl=ja) テーブルに保存されます。


### メディアファイルを他のアプリと共有する

[insert()](https://developer.android.com/reference/android/content/ContentResolver?hl=ja#insert(android.net.Uri,%20android.content.ContentValues)) メソッドを使用して、 MediaStore にレコードを直接追加します。詳細については、メディアストレージガイドの [アイテムを追加する](./4.共有ストレージに保存する/2.メディア.md/#アイテムを追加する) をご覧ください。


### メディアファイルを特定のアプリと共有する

[ファイル共有の設定](./10.ファイルの共有/2.ファイル共有の設定.md) ガイドで説明されているように、 Android FileProvider コンポーネントを使用します。


### 直接ファイルパスを使用する「コード」または「ライブラリ」からファイルにアクセスする

アプリが動作する Android のバージョンに基づいてロジックを組み込みます。


#### Android 11 で動作するアプリ

次の方法を使用します。

1. [アプリの権限をリクエストする](https://developer.android.com/training/permissions/requesting?hl=ja) で概説されているおすすめの方法に沿って、 [READ_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja#READ_EXTERNAL_STORAGE) 権限をリクエストします。
2. 直接ファイルパスを使用してファイルにアクセスします。

詳しくは、 [直接ファイルパスを使用してメディアファイルを開く方法](./4.共有ストレージに保存する/2.メディア.md/#直接ファイルパス) についてのセクションをご覧ください。


#### Android 10 で動作するアプリ

Android 10（API レベル 29）をターゲットとするアプリの場合は、 [対象範囲別ストレージをオプトアウト](#対象範囲別ストレージを一時的にオプトアウトする) し、Android 9 以前の方法を使用してこの操作を行います。


#### Android 9 以前で動作するアプリ

次の方法を使用します。

1. [アプリの権限をリクエストする](https://developer.android.com/training/permissions/requesting?hl=ja) で概説されているおすすめの方法に沿って、 [WRITE_EXTERNAL_STORAGE](https://developer.android.com/reference/android/Manifest.permission?hl=ja#WRITE_EXTERNAL_STORAGE) 権限をリクエストします。
2. 直接ファイルパスを使用してファイルにアクセスします。


## メディア以外のファイルを処理する

このセクションでは、メディア以外のファイルを処理する一般的なユースケースと、アプリで使用できる大まかな方法について説明します。そうした各ユースケースと、詳細を含む各セクションへのリンクを次の表にまとめます。

- ドキュメント ファイルを開く
  - Android のすべてのバージョンで同じ方法を使用します。
- セカンダリストレージボリューム上のファイルに書き込む
  - Android 11 では 1 つの方法を使用します。それよりも古いバージョンでは別の方法を使用します。
- 以前の保存先から既存のファイルを移行する
  - 可能であれば、ファイルを対象範囲別ストレージに移行します。必要に応じて、 Android 10 の対象範囲別ストレージをオプトアウトします。
- コンテンツを他のアプリと共有する
  - Android のすべてのバージョンで同じ方法を使用します。
- メディア以外のファイルをキャッシュに保存する
  - Android のすべてのバージョンで同じ方法を使用します。
- メディア以外のファイルをデバイスにエクスポートする
  - アプリで対象範囲別ストレージを使用する場合は、 1 つの方法を使用します。アプリで対象範囲別ストレージをオプトアウトしている場合は、別の方法を使用します。


### ドキュメント ファイルを開く

[ACTION_OPEN_DOCUMENT](https://developer.android.com/reference/android/content/Intent?hl=ja#ACTION_OPEN_DOCUMENT) インテントを使用すると、開くファイルを選択するようユーザーに求めることができます。ユーザーは、システムの「選択ツール」を使用して、開くファイルを選択します。システムの選択ツールに表示するファイルの種類をフィルタリングする場合は、 [setType()](https://developer.android.com/reference/android/content/Intent?hl=ja#setType(java.lang.String)) 、または、 [EXTRA_MIME_TYPES](https://developer.android.com/reference/android/content/Intent?hl=ja#EXTRA_MIME_TYPES) を使用できます。

たとえば、次のコードを使用してすべての PDF、ODT、TXT ファイルを検索できます。

```kotlin
startActivityForResult(
    Intent(Intent.ACTION_OPEN_DOCUMENT).apply {
        addCategory(Intent.CATEGORY_OPENABLE)
        type = "*/*"
        putExtra(Intent.EXTRA_MIME_TYPES, arrayOf(
            "application/pdf", // .pdf
            "application/vnd.oasis.opendocument.text", // .odt
            "text/plain" // .txt
        )
    },
    REQUEST_CODE
)
```


### セカンダリストレージボリューム上のファイルに書き込む

セカンダリストレージボリュームには、 SD カードが含まれます。 [StorageVolume](https://developer.android.com/reference/android/os/storage/StorageVolume?hl=ja) クラスを使用すると、特定のストレージボリュームに関する情報にアクセスできます。

アプリが動作する Android のバージョンに基づいてロジックを組み込みます。


#### Android 11 で動作するアプリ

**注** : 次の方法では、ほとんどの場合、アプリが正常にアクセスできる信頼性の高いボリュームにのみアクセスできます。

次の方法を使用します。

1. [対象範囲別ストレージ](./2.ストレージについて.md/#対象範囲別ストレージ) モデルを使用します。
2. Android 10（API レベル 29）以前をターゲットとします。
3. WRITE_EXTERNAL_STORAGE 権限を宣言します。
4. 次のいずれかのアクセスを行います。
  - MediaStore API を使用したファイル アクセス。
  - [File](https://developer.android.com/reference/java/io/File?hl=ja) や fopen() などの API を使用した直接ファイルパス アクセス。


#### 以前のバージョンで動作するアプリ

[ストレージアクセスフレームワーク](./4.共有ストレージに保存する/4.ドキュメントおよび他のファイル.md) を使用すると、ユーザーは、セカンダリストレージボリューム上の場所を選択できます。


### 以前の保存先から既存のファイルを移行する

ディレクトリは、アプリ固有のディレクトリや公開共有ディレクトリでない場合に、以前の保存先と見なされます。アプリが、以前の保存先でファイルを作成、または、使用する場合は、アプリのファイルを対象範囲別ストレージでアクセスできる場所に移行し、対象範囲別ストレージ内のファイルを扱うために必要な変更をアプリに加えることをおすすめします。


#### データ移行のために以前の保存先へのアクセス権を維持する

アプリのファイルを対象範囲別ストレージでアクセスできる場所に移行するには、以前の保存先へのアクセス権を維持する必要があります。使用する方法は、アプリのターゲット API レベルによって異なります。


##### Android 11 をターゲットとするアプリの場合

1. [preserveLegacyExternalStorage](https://developer.android.com/reference/android/R.attr?hl=ja#preserveLegacyExternalStorage) フラグを true に設定して、 [以前のストレージモデルを保持し](https://developer.android.com/about/versions/11/privacy/storage?hl=ja#migrate-data-for-scoped-storage) 、ユーザーが Android 11 をターゲットとするアプリの新しいバージョンにアップグレードする際に、ユーザーのデータを移行できるようにします。

**注** : preserveLegacyExternalStorage を true に設定した場合、以前のストレージモデルは、ユーザーがアプリをアンインストールするまで有効です。 Android 11 が搭載されたデバイスで、ユーザーがアプリをインストール、または、再インストールする場合、 preserveLegacyExternalStorage の値に関係なく、アプリは対象範囲別ストレージモデルをオプトアウトできません。

2. [対象範囲別ストレージをオプトアウトする](#対象範囲別ストレージを一時的にオプトアウトする) に進み、 Android 10 デバイスの以前の保存先にあるファイルに、アプリで引き続きアクセスできるようにします。


##### Android 10 をターゲットとするアプリの場合

[対象範囲別ストレージをオプトアウト](https://developer.android.com/training/data-storage/use-cases?hl=ja&_gl=1*1rzg3xr*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..#opt-out-scoped-storage) して、 Android バージョン間でアプリの動作を維持しやすくします。


#### アプリデータを移行する

アプリで移行の準備が整ったら、次の方法を使用します。

1. Android 10 以前をターゲットとします。
2. [対象範囲別ストレージをオプトアウト](#対象範囲別ストレージを一時的にオプトアウトする) して、移行する必要のあるファイルにアプリがアクセスできるようにします。
3. File API を使用して、ファイルを /sdcard/ 内の現在の場所から対象範囲別ストレージでアクセスできる場所に移動するコードをデプロイします。
  - プライベート アプリ ファイルを、getExternalFilesDir() メソッドで返されるディレクトリに移動します。
  - メディア以外の共有ファイルを、Downloads/ ディレクトリのアプリ専用サブディレクトリに移動します。
4. アプリの以前のストレージディレクトリを `/sdcard/` ディレクトリから削除します。

ユーザーは、アプリの新しいバージョンをインストールした後、デバイスでデータ移行プロセスを完了します。分析イベントを作成することで、ユーザーベース全体の移行プロセスをモニタリングできます。

ユーザーがデータを移行した後、 Android 11 をターゲットとするアプリの別のアップデートを公開します。


### コンテンツを他のアプリと共有する

アプリのファイルを他の 1 つのアプリと共有するには、 [FileProvider を使用します。](./10.ファイルの共有/1.ファイル共有について.md) すべてのアプリ間でファイルを共有する必要がある場合は、アプリごとに [コンテンツプロバイダを使用](./12.コンテンツプロバイダ/2.コンテンツプロバイダの基本.md) して、アプリがコレクションに追加されたときにデータを同期することをおすすめします。


### メディア以外のファイルをキャッシュに保存する

使用する方法は、キャッシュに保存する必要があるファイルの種類によって異なります。

- **小さいファイル、または、機密情報を含むファイルの場合**
  - [Context#getCacheDir()](https://developer.android.com/reference/android/content/Context?hl=ja#getCacheDir()) を使用します。
- **大きいファイル、または、機密情報が含まれていないファイルの場合**
  - [Context#getExternalCacheDir()](https://developer.android.com/reference/android/content/Context?hl=ja#getExternalCacheDir()) を使用します。


### メディア以外のファイルをデバイスにエクスポートする

メディア以外のファイルを保存するために、適切なデフォルトの場所を定義します。ユーザーがファイルを [アプリ固有のディレクトリ](https://developer.android.com/reference/android/content/Context?hl=ja#getExternalFilesDirs(java.lang.String)) から一般的にアクセスしやすい場所にエクスポートできるようにします。 [MediaStore のダウンロード、または、ドキュメントのコレクション](./4.共有ストレージに保存する/4.ドキュメントおよび他のファイル.md) を使用して、メディア以外のファイルをデバイスにエクスポートします。

**注** : わかりやすくするために、 [externalStoragePublicDirectory()](https://developer.android.com/reference/android/os/Environment?hl=ja#getExternalStoragePublicDirectory(java.lang.String)) や [externalMediaDirs()](https://developer.android.com/reference/android/content/Context?hl=ja#getExternalMediaDirs()) など、一般的にアクセスしやすい場所を使用してください。


## アプリ固有のファイルを処理する

他のアプリがアクセスする必要のないファイルをアプリが作成した場合や、 アクセスすべきでないものがある場合、これらのファイルは、 [アプリ固有のストレージロケーション](./3.アプリ固有のストレージに保存する.md) に保存します。


### 内部ストレージディレクトリ

他のアプリは、これらの場所にアクセスできません。 Android 10（API レベル 29）以上では、これらの場所は暗号化されます。これらの場所は、アプリだけがアクセスできる機密データを保存するのに適しています。


### 外部ストレージディレクトリ

アプリ固有のファイルを保存するのに十分な容量が内部ストレージにない場合は、代わりに外部ストレージの使用を検討してください。別のアプリで これらのディレクトリにアクセスする アプリが適切な権限を持っている場合、これらのディレクトリに保存されているファイルは、 はアプリでのみ使用されるものです。

Android 4.4（API レベル 19）以降では、外部ストレージ内のアプリ固有のディレクトリにアクセスするために、ストレージに関する権限をリクエストする必要はありません。

ユーザーがアプリをアンインストールすると、アプリ固有のストレージに保存されたファイルは削除されます。そのため、ユーザーがアプリのアンインストール後もデータが保持されることを期待するデータを、ここに保存するべきではありません。


## 対象範囲別ストレージを一時的にオプトアウトする

アプリが対象範囲別ストレージに完全に対応するまでは、テストと製品版アプリの両方で一時的にオプトアウトできます。


### テストでオプトアウトする

(ここでいう「テスト」とは、 JUnit 等を使用した自動化テストを示していると思われます。)

Android 10（API レベル 29）以降では、アプリのテストはデフォルトでストレージ サンドボックスで実行されます。このサンドボックスにより、アプリはアプリ固有のディレクトリと一般公開ディレクトリの外にあるファイルにアクセスできなくなります。

テストでホスト用のファイル（スクリーンショット、デバッグデータ、カバレッジデータ、パフォーマンス指標など）が出力される場合、そうしたファイルをグローバルディレクトリに書き込むことができます。そのためには、 `am instrument` を呼び出す関連ハーネスに次のフラグを追加します。

```
-e no-isolated-storage 1
```

このフラグは、インストルメント化されたテストケースのすべての動作に影響し、呼び出されるすべてのテストコードに影響します。そのため、このフラグを使用した場合、アプリと対象範囲別ストレージの互換性を検証できません。テスト出力では代わりに、シェルで読み取り可能な、アプリを対象とするストレージに書き込むことをおすすめします。その後、アプリを対象とするディレクトリを pull できます。 pull 元のディレクトリを判断するには、 [getExternalMediaDirs()](https://developer.android.com/reference/android/content/Context?hl=ja#getExternalMediaDirs()) を呼び出します。

**注** : アプリをアンインストールすると、アプリを対象とするストレージ内のファイルは保持されません。


### 製品版アプリでオプトアウトする

Android 10（API レベル 29）以前をターゲットとするアプリの場合、製品版アプリで対象範囲別ストレージを一時的にオプトアウトできます。ただし、Android 10 をターゲットとする場合は、アプリのマニフェスト ファイルで requestLegacyExternalStorage の値を true に設定する必要があります。

```xml
<manifest ... >
    <!-- This attribute is "false" by default on apps targeting Android 10. -->
    <application android:requestLegacyExternalStorage="true" ... >
    ...
    </application>
</manifest>
```

**注意** : OS のバージョンが Android 11 のデバイスでアプリが動作している場合、アプリの targetSdkVersion を Android 11（API レベル 30）に更新すると、システムは [requestLegacyExternalStorage 属性を無視](https://developer.android.com/about/versions/11/privacy/storage?hl=ja#scoped-storage) します。あなたのアプリは、 [対象のユーザーのデータを移行し](#以前の保存先から既存のファイルを移行する) 、対象範囲別ストレージをサポートするように更新する必要があります。

Android 10 以前をターゲットとしているアプリが対象範囲別ストレージを使用したときにどのように動作するのかテストするには、requestLegacyExternalStorage の値を false に設定して、対象範囲別ストレージをオプトインします。 Android 11 を搭載したデバイスでテストする場合は、 [アプリの互換性フラグを使用](https://developer.android.com/about/versions/11/privacy/storage?hl=ja#test-scoped-storage) して、対象範囲別ストレージの有無にかかわらずアプリの動作をテストすることもできます。


## 参考情報

Android ストレージの詳細については、次の資料をご覧ください。


### ブログ投稿

- [Viber のユーザーに最新のストレージを提供](https://android-developers.googleblog.com/2020/07/bringing-modern-storage-to-vibers-users.html)


## 引用元資料

- [Android ストレージのユースケースとおすすめの方法](https://developer.android.com/training/data-storage/use-cases?hl=ja&_gl=1*1rzg3xr*_up*MQ..*_ga*MTE2NzQ4NjMzNC4xNzIyNTE5MzA5*_ga_6HH9YJMN9M*MTcyMjU3NTIyNi4yLjAuMTcyMjU3NTIyNi4wLjAuMA..)



