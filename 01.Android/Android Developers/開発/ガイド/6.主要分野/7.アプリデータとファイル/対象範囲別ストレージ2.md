- [対象範囲別ストレージ（ Scoped Storage ）](#対象範囲別ストレージ-scoped-storage-)
  - [概要](#概要)
  - [Scoped Storage を無効化する設定（Android 10 のデバイスでのみ可能）](#scoped-storage-を無効化する設定android-10-のデバイスでのみ可能)
  - [Scoped Storage の有効化](#scoped-storage-の有効化)
  - [Scoped Storage でのファイルアクセス方法](#scoped-storage-でのファイルアクセス方法)
  - [引用元資料](#引用元資料)


# 対象範囲別ストレージ（ Scoped Storage ）

## 概要

対象範囲別ストレージとは、 Android 10 ( API レベル 29 ) から導入され始めた仕組みで、以下の特徴を持っています。

- 外部ストレージ ( `/storage/emulated/0/` ) (※ 1 ) へのアクセス制限
  - 今までは、他のアプリから自分のアプリのアプリ固有の外部ストレージ ( `/storage/emulated/0/Android/data/<my-package-name>/` ) へ、権限を付与することでアクセス可能だったが、権限を付与してもアクセスができなくなった。
  - 外部ストレージのフォルダわけが、用途別のフォルダ構成になった？
    - `/storage/emulated/0/Documents/` など

(※ 1 )  
`/storage/emulated/0/` の代わりに、 `/sdcard/` としても OK です。 `/sdcard/` は、 `/storage/emulated/0/` のシンボリックリンクです。シンボリックリンクとは、ほぼエイリアスですが、 cd コマンドが使えるなど、より実態がそこにあるかのように振舞います。


## Scoped Storage を無効化する設定（Android 10 のデバイスでのみ可能）

デバイスの OS バージョンが Android 10 の場合のみ、 AndroidManifest.xml に以下を設定すると、一時的に Scoped Storage をオプトアウトし、従来のストレージアクセスを有効にできます。 ( アプリの targetSdkVertion の値に関係なく、デバイスの OS バージョンによって、オプトアウトできるかどうかが決まります。)

```xml
<manifest>
    <application
        android:requestLegacyExternalStorage="true">
    </application>
</manifest>
```


## Scoped Storage の有効化

デバイスの OS バージョンと、アプリの targetSdkVersion の条件を満たすと、 Scoped Storage は自動的に有効化されます。

- アプリの targetSdkVersion 29 以上、かつ、デバイスの Android OS 10 以上
  - デフォルトで Scoped Storage が適用され、外部ストレージへのアクセスが制限される。
- アプリの targetSdkVersion 30 以上、かつ、デバイスの Android OS 11 以上
  - さらに制限が強化され、 requestLegacyExternalStorage="true" を使っても Scoped Storage を無効にできない。
- アプリの targetSdkVersion 28 以下、もしくは、デバイスの Android OS 9 以下
  - 従来の外部ストレージアクセス（ WRITE_EXTERNAL_STORAGE で自由にアクセス）を使用可能。


## Scoped Storage でのファイルアクセス方法

Scoped Storage 環境では、以下のような方法でファイルにアクセスします。

1. MediaStore API を使う（画像・動画・音声向け）

例: `MediaStore.Images.Media.EXTERNAL_CONTENT_URI` を使って画像を保存・取得

2. アプリ専用ストレージを使う（getExternalFilesDir()）

- `context.getExternalFilesDir(null)` を使うと、アプリ専用の外部ストレージディレクトリにアクセス可能
- 例: /storage/emulated/0/Android/data/com.example.app/files/

3. SAF（Storage Access Framework）を使う（任意の場所にアクセス）

ACTION_OPEN_DOCUMENT や ACTION_CREATE_DOCUMENT を使って、ユーザーが選択したファイルにアクセスする

4. 特定の許可を得る（特殊ケース）

MANAGE_EXTERNAL_STORAGE（Android 11+）を使うと、全ファイルアクセスが可能だが、 Google Play のポリシーにより審査が厳しい。エクスプローラーのようなアプリでしか Google Play の承認が下りない。


## 引用元資料

- ChatGPT との会話の結果を引用


