<!-- TOC START min:1 max:3 link:true asterisk:false update:true -->
- [バックアップの対象となるファイルをカスタマイズする](#バックアップの対象となるファイルをカスタマイズする)
  - [マニフェストファイルへの記述](#マニフェストファイルへの記述)
    - [Android 11（ API レベル 30 ）以下のデバイスへの対応](#android-11-api-レベル-30-以下のデバイスへの対応)
    - [Android 12（ API レベル 31 ）以上のデバイスへの対応](#android-12-api-レベル-31-以上のデバイスへの対応)
  - [カスタマイズファイルの文法](#カスタマイズファイルの文法)
    - [Android 11 と Android 12 で共通の文法](#android-11-と-android-12-で共通の文法)
      - [\<include\> タグと \<exclude\> タグの有無について](#include-タグと-exclude-タグの有無について)
      - [domain 属性について](#domain-属性について)
      - [path 属性について](#path-属性について)
    - [Android 11（ API レベル 30 ）以下のデバイスへの対応](#android-11-api-レベル-30-以下のデバイスへの対応-1)
    - [Android 12（ API レベル 31 ）以上のデバイスへの対応](#android-12-api-レベル-31-以上のデバイスへの対応-1)
  - [カスタマイズファイルのサンプル](#カスタマイズファイルのサンプル)
    - [Android 11（ API レベル 30 ）以下のデバイスへの対応](#android-11-api-レベル-30-以下のデバイスへの対応-2)
    - [Android 12（ API レベル 31 ）以上のデバイスへの対応](#android-12-api-レベル-31-以上のデバイスへの対応-2)
<!-- TOC END -->


# バックアップの対象となるファイルをカスタマイズする

ここでは、バックアップの対象となるファイルを追加 or 除外する方法を示します。

Android 11 ( API レベル 30 ) 以下のデバイスへの対応と  
Android 12 ( API レベル 31 ) 以上のデバイスへの対応は異なりますので、  
それぞれについて、以下に説明します。

targetSdkVersion がいくつであるかにかかわらず、 Android 11 と Android 12 の OS を搭載した  
ユーザーが存在する可能性がある限り、両方の対応を行う必要があります。


## マニフェストファイルへの記述

まず、マニフェストファイルに、カスタマイズ方法を記述したファイルへの参照を記述します。

Android 11 への対応の場合も、 Android 12 への対応の場合も、  
`backup_rules.xml` ファイルは、 `res/xml/` フォルダに格納します。


### Android 11（ API レベル 30 ）以下のデバイスへの対応

```xml
<application
    android:fullBackupContent="@xml/backup_rules">
</application>
```


### Android 12（ API レベル 31 ）以上のデバイスへの対応

```xml
<application
    android:dataExtractionRules="backup_rules.xml">
</application>
```


## カスタマイズファイルの文法

`backup_rules.xml` は、以下の文法に則って記述します。


### Android 11 と Android 12 で共通の文法


#### \<include\> タグと \<exclude\> タグの有無について

**1. \<include\> タグが存在しない場合**

`<include>` タグが存在しない場合は、デフォルトの転送対象ファイルが転送対象となります。  
デフォルトの転送対象ファイルは、以下の通りです。

- SharedPreference のファイル
- `getFilesDir()` または `getDir(String, int)` によってアクセスされる、アプリの内部ストレージに保存されているファイル
- `getDatabasePath(String)` から返されるディレクトリ内のファイル ( `SQLiteOpenHelper` クラスで作成されたファイルも含む)
- 外部ストレージ上の、 `getExternalFilesDir(String)` から返されるディレクトリ内のファイル


**2. \<include\> タグが存在する場合**

`<include>` タグが存在する場合は、デフォルトの転送対象ファイルは、一旦全て転送対象外になります。  
`<include>` タグで指定した対象のみが転送対象に設定されます。

ただし、 `getCacheDir()` 、 `getCodeCacheDir()` 、 `getNoBackupFilesDir()` から  
返されたディレクトリ内のファイルは、バックアップの対象に含めようとしても常に除外されます。


**3. \<exclude\> タグが存在しない場合**

転送対象外になるファイルは存在せず、デフォルトの転送対象ファイル、もしくは  
`<include>` タグで設定した転送対象ファイルが、最終的な転送対象ファイルとなります。


**4. \<exclude\> タグが存在する場合**

デフォルトの転送対象ファイル、もしくは、 `<include>` タグで設定した転送対象ファイルから  
`<exclude>` タグで指定したファイルを除外したものが、最終的な転送対象ファイルとなります。


#### domain 属性について

リソースの場所を指定します。この属性の有効な値は以下のとおりです。  
下記以外の場所にあるファイルはバックアップすることができません。

- root
  - このアプリに属するすべてのプライベート ファイルが保存される、ファイル システム上のディレクトリ。
- file
  - `getFilesDir()` が返すディレクトリ。
- database
  - `getDatabasePath()` が返すディレクトリ。
  - SQLiteOpenHelper で作成されたデータベースはここに格納されます。
- sharedpref
  - SharedPreferences が格納されるディレクトリ。
- external
  - `getExternalFilesDir()` が返すディレクトリ。


#### path 属性について

バックアップに含める、もしくは、除外する対象を指定するのに使用します。

- ファイル、もしくはディレクトリを指定することが可能です。
- `./` を指定すると、 `domain` に応じたルートディレクトリを示します。
  - 例えば、 `domain="database"` の場合は、 `data/data/package_name/database` ディレクトリを示します。
- ディレクトリを指定すると、そのディレクトリ以下のすべてのファイルやサブディレクトリに対してルールが適用されます。
  - 孫ディレクトリなども含め、指定したディレクトリ以下の全てに適用されます。

注意点

- `../` は、通常、親ディレクトリを参照する文法ですが、セキュリティ上の理由から参照することはできません。
- ワイルドカードや正規表現の構文を使用することはできません。


### Android 11（ API レベル 30 ）以下のデバイスへの対応

```xml
<full-backup-content>
    <include domain=["file" | "database" | "sharedpref" | "external" | "root"]
        path="string"
        requireFlags=["clientSideEncryption" | "deviceToDeviceTransfer"] />
    <exclude domain=["file" | "database" | "sharedpref" | "external" | "root"]
        path="string" />
</full-backup-content>
```

- path 属性
  - ファイル名や 「 . 」 を記述します。
  - ファイル名の場合は、ファイルの拡張子も含めます。
- requireFlags 属性
  - Android 9 ( API Level 28 ) 以上で有効な属性です。 ( ※ 1 )
  - 指定した条件を満たす場合のみ、バックアップを行うように設定することができます。
  - clientSideEncryption
    - デバイスに画面ロック ( PIN / パターン / パスワードのいずれか) を設定している場合のみバックアップの対象となります。
    - バックアップがクライアント側のシークレットで暗号化されます。
  - deviceToDeviceTransfer
    - デバイス間のローカル転送でデータ移行する場合にのみ、バックアップの対象となります。

( ※ 1 )  
`requireFlags` 属性を設定すると、 Android 9 ( API Level 28 ) 未満のデバイスは、  
バックアップが機能しなくなるため、代替リソースを用意する必要があります。


### Android 12（ API レベル 31 ）以上のデバイスへの対応

```xml
<data-extraction-rules>
    <cloud-backup [disableIfNoEncryptionCapabilities="true|false"]>
        <include domain=["file" | "database" | "sharedpref" | "external" | "root"]
            path="string"/>
        <exclude domain=["file" | "database" | "sharedpref" | "external" | "root"]
            path="string"/>
    </cloud-backup>
    <device-transfer>
        <include domain=["file" | "database" | "sharedpref" | "external" | "root"]
            path="string"/>
        <exclude domain=["file" | "database" | "sharedpref" | "external" | "root"]
            path="string"/>
  </device-transfer>
</data-extraction-rules>
```

- \<cloud-backup\> タグ
  - Google ドライブへのバックアップ時の設定
- \<device-transfer\> タグ
  - デバイス間転送時の設定
- disableIfNoEncryptionCapabilities 属性
  - デバイスロックが設定されているかどうかによって、バックアップを行うかどうかを指定することができます。
  - true : 暗号化不可 (デバイスロック未設定) の場合はバックアップを行わない
  - false : 暗号化不可の場合でもバックアップを行う
  - デバイス間転送では、データがサーバーに送信されず、通信を盗聴される可能性がないため、この属性は無効になります。

**\<device-transfer\> タグ or \<cloud-backup\> タグが存在しない場合**

`<device-transfer>` タグ or `<cloud-backup>` タグが存在しない場合は、  
その転送方法に関しては、転送するファイルに追加や削除の指定がなかったものとみなされ、  
デフォルトの転送対象ファイルが転送されます。


## カスタマイズファイルのサンプル

以下のサンプルでは、 device.xml を除くすべての SharedPreference のファイルがバックアップされます。

カスタマイズファイルは、以下のパスに存在します。

`res/xml/backup_rules.xml`


### Android 11（ API レベル 30 ）以下のデバイスへの対応

```xml
<?xml version="1.0" encoding="utf-8"?>
<full-backup-content>
    <include domain="sharedpref" path="."/>
    <exclude domain="sharedpref" path="device.xml"/>
</full-backup-content>
```


### Android 12（ API レベル 31 ）以上のデバイスへの対応

```xml
<?xml version="1.0" encoding="utf-8"?>
<data-extraction-rules>
    <cloud-backup [disableIfNoEncryptionCapabilities="true|false"]>
        <include domain="sharedpref" path="."/>
        <exclude domain="sharedpref" path="device.xml"/>
    </cloud-backup>
</data-extraction-rules>
```




